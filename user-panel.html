<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard - GlobalTradePro</title>
    <link rel="stylesheet" href="user-panel-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>

</head>
<body>
    <div class="dashboard-container">
        <!-- Mobile Overlay -->
        <div class="mobile-overlay" onclick="closeMobileMenu()"></div>
        
        <!-- Sol Navigasyon Paneli -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-chart-line"></i>
                    <span>TradePro</span>
                </div>
            </div>
            
            <nav class="nav-menu">
                <div class="nav-item">
                    <a href="#" class="nav-link active" data-section="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="portfolio">
                        <i class="fas fa-briefcase"></i>
                        <span>Portföyüm</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="markets">
                        <i class="fas fa-coins"></i>
                        <span>Piyasalar</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="positions">
                        <i class="fas fa-chart-line"></i>
                        <span>Pozisyonlar</span>
                        <span class="position-count" id="positionCount" style="display: none;">0</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="deposit">
                        <i class="fas fa-plus-circle"></i>
                        <span>Para Yatır</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="withdrawal">
                        <i class="fas fa-minus-circle"></i>
                        <span>Para Çek</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="profile">
                        <i class="fas fa-user"></i>
                        <span>Profil</span>
                    </a>
                </div>
            </nav>
        </aside>
        
        <!-- Ana İçerik Alanı -->
        <main class="main-content">
            <!-- Üst Bar -->
            <header class="top-bar">
                <div class="top-bar-left">
                    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title" id="pageTitle">Dashboard</h1>
                </div>
                <div class="top-bar-right">
                    <div class="balance-display" id="userBalance" onclick="openBalanceMenu()" style="cursor: pointer;" title="Para yatır/çek">
                        <i class="fas fa-spinner fa-spin"></i> Yükleniyor...
                    </div>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Çıkış
                    </button>
                </div>
            </header>
            
            <!-- İçerik Alanları -->
            <div class="content-area">
                
                <!-- Dashboard Bölümü -->
                <section class="content-section active" id="dashboard">
                    <div class="section-header">
                        <h2 class="section-title">Hoş Geldiniz</h2>
                        <p class="section-subtitle">Trading hesabınızın genel durumu</p>
                    </div>
                    
                    <div class="grid grid-3">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Toplam Bakiye</h3>
                                <i class="fas fa-wallet" style="color: #00d4aa;"></i>
                            </div>
                            <div id="totalBalance" class="loading">
                                <div class="spinner"></div>
                                Yükleniyor...
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Günlük Kazanç</h3>
                                <i class="fas fa-chart-line" style="color: #00d4aa;"></i>
                            </div>
                            <div id="dailyPnl" class="loading">
                                <div class="spinner"></div>
                                Hesaplanıyor...
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Açık Pozisyonlar</h3>
                                <i class="fas fa-chart-pie" style="color: #00d4aa;"></i>
                            </div>
                            <div id="openPositions" class="loading">
                                <div class="spinner"></div>
                                Yükleniyor...
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-2">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Son İşlemler</h3>
                            </div>
                            <div id="recentTrades" class="loading">
                                <div class="spinner"></div>
                                Yükleniyor...
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Piyasa Özetı</h3>
                            </div>
                            <div id="marketSummary" class="loading">
                                <div class="spinner"></div>
                                Yükleniyor...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hızlı İşlemler Paneli - Dashboard'a taşındı -->
                    <div class="card" style="margin-top: 32px;">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-bolt" style="color: #00d4aa; margin-right: 8px;"></i>
                                Hızlı İşlemler
                            </h3>
                            <p style="color: #8b8fa3; font-size: 14px; margin: 8px 0 0 0;">En sık kullanılan işlemlere hızlı erişim</p>
                        </div>
                        <div class="quick-actions-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; padding: 20px;">
                            <button class="quick-action-btn" onclick="showSection('markets')" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 16px; text-align: left;" onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'; this.style.transform='translateY(0)'">
                                <div class="quick-action-icon" style="width: 48px; height: 48px; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; flex-shrink: 0; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                                <div class="quick-action-text" style="flex: 1;">
                                    <span style="display: block; font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Coin Al</span>
                                    <small style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">Piyasalara git ve coin satın al</small>
                                </div>
                            </button>

                            <button class="quick-action-btn" onclick="showSection('portfolio')" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 16px; text-align: left;" onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'; this.style.transform='translateY(0)'">
                                <div class="quick-action-icon" style="width: 48px; height: 48px; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; flex-shrink: 0; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                                    <i class="fas fa-briefcase"></i>
                                </div>
                                <div class="quick-action-text" style="flex: 1;">
                                    <span style="display: block; font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Portföy</span>
                                    <small style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">Varlıklarınızı görüntüleyin</small>
                                </div>
                            </button>

                            <button class="quick-action-btn" onclick="showSection('deposit')" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 16px; text-align: left;" onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'; this.style.transform='translateY(0)'">
                                <div class="quick-action-icon" style="width: 48px; height: 48px; background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; flex-shrink: 0; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">
                                    <i class="fas fa-plus-circle"></i>
                                </div>
                                <div class="quick-action-text" style="flex: 1;">
                                    <span style="display: block; font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Para Yatır</span>
                                    <small style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">Hesabınıza bakiye ekleyin</small>
                                </div>
                            </button>

                            <button class="quick-action-btn" onclick="showSection('positions')" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 16px; text-align: left;" onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'; this.style.transform='translateY(0)'">
                                <div class="quick-action-icon" style="width: 48px; height: 48px; background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; flex-shrink: 0; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="quick-action-text" style="flex: 1;">
                                    <span style="display: block; font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Pozisyonlar</span>
                                    <small style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">Kaldıraçlı işlemleriniz</small>
                                </div>
                            </button>

                            <button class="quick-action-btn" onclick="showSection('trading')" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 16px; text-align: left;" onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'; this.style.transform='translateY(0)'">
                                <div class="quick-action-icon" style="width: 48px; height: 48px; background: linear-gradient(135deg, #ef4444 0%, #f87171 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; flex-shrink: 0; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);">
                                    <i class="fas fa-exchange-alt"></i>
                                </div>
                                <div class="quick-action-text" style="flex: 1;">
                                    <span style="display: block; font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Forex İşlem</span>
                                    <small style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">Profesyonel trading</small>
                                </div>
                            </button>

                            <button class="quick-action-btn" onclick="openBalanceMenu()" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 16px; text-align: left;" onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'; this.style.transform='translateY(0)'">
                                <div class="quick-action-icon" style="width: 48px; height: 48px; background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; flex-shrink: 0; box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);">
                                    <i class="fas fa-wallet"></i>
                                </div>
                                <div class="quick-action-text" style="flex: 1;">
                                    <span style="display: block; font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 4px;">Cüzdan</span>
                                    <small style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">Para yatır/çek işlemleri</small>
                                </div>
                            </button>
                        </div>
                    </div>
                </section>
                
                <!-- Diğer bölümler buraya eklenecek -->
                <section class="content-section" id="portfolio">
                    <div class="section-header">
                        <h2 class="section-title">Portföyüm</h2>
                        <p class="section-subtitle">Sahip olduğunuz kripto varlıklar ve performansları</p>
                    </div>
                    
                    <!-- Portföy Özeti -->
                    <div class="portfolio-summary-grid">
                        <div class="portfolio-stat-card total-value">
                            <div class="portfolio-stat-header">
                                <div class="portfolio-stat-icon">
                                    <i class="fas fa-wallet"></i>
                                </div>
                                <div class="portfolio-stat-trend">
                                    <i class="fas fa-arrow-up" id="totalValueTrend"></i>
                                </div>
                            </div>
                            <div class="portfolio-stat-content">
                                <h3 class="portfolio-stat-value" id="portfolioTotalValue">₺0</h3>
                                <p class="portfolio-stat-label">Toplam Portföy Değeri</p>
                                <div class="portfolio-stat-change" id="totalValueChange">+₺0 (0%)</div>
                            </div>
                        </div>
                        
                        <div class="portfolio-stat-card profit-loss">
                            <div class="portfolio-stat-header">
                                <div class="portfolio-stat-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="portfolio-stat-trend">
                                    <i class="fas fa-arrow-up" id="profitLossTrend"></i>
                                </div>
                            </div>
                            <div class="portfolio-stat-content">
                                <h3 class="portfolio-stat-value" id="portfolioProfitLoss">₺0</h3>
                                <p class="portfolio-stat-label">Gerçekleşmemiş K/Z</p>
                                <div class="portfolio-stat-change" id="profitLossPercent">0%</div>
                            </div>
                        </div>
                        
                        <div class="portfolio-stat-card asset-count">
                            <div class="portfolio-stat-header">
                                <div class="portfolio-stat-icon">
                                    <i class="fas fa-coins"></i>
                                </div>
                                <div class="portfolio-stat-badge" id="newAssetBadge">+0</div>
                            </div>
                            <div class="portfolio-stat-content">
                                <h3 class="portfolio-stat-value" id="portfolioCoinCount">0</h3>
                                <p class="portfolio-stat-label">Varlık Sayısı</p>
                                <div class="portfolio-stat-change" id="assetDistribution">%0 çeşitlilik</div>
                            </div>
                        </div>
                        
                        <div class="portfolio-stat-card best-performer">
                            <div class="portfolio-stat-header">
                                <div class="portfolio-stat-icon">
                                    <i class="fas fa-trophy"></i>
                                </div>
                                <div class="portfolio-stat-trend up">
                                    <i class="fas fa-crown"></i>
                                </div>
                            </div>
                            <div class="portfolio-stat-content">
                                <h3 class="portfolio-stat-value" id="bestPerformerValue">-</h3>
                                <p class="portfolio-stat-label">En İyi Performans</p>
                                <div class="portfolio-stat-change" id="bestPerformerChange">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Portföy Listesi -->
                    <div class="portfolio-container">
                        <div class="portfolio-header">
                            <div class="portfolio-title-section">
                                <h3 class="portfolio-main-title">
                                    <i class="fas fa-briefcase"></i>
                                    Varlık Portföyü
                                </h3>
                                <p class="portfolio-subtitle">Sahip olduğunuz kripto varlıkların detayları</p>
                            </div>
                            <div class="portfolio-controls">
                                <div class="view-toggle">
                                    <button class="view-btn active" id="cardViewBtn" onclick="togglePortfolioView('cards')">
                                        <i class="fas fa-th-large"></i>
                                    </button>
                                    <button class="view-btn" id="tableViewBtn" onclick="togglePortfolioView('table')">
                                        <i class="fas fa-list"></i>
                                    </button>
                                </div>
                                <button class="refresh-btn" onclick="loadPortfolio()">
                                    <i class="fas fa-sync-alt"></i>
                                    <span>Yenile</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Loading State -->
                        <div id="portfolioLoader" class="loading" style="display: none; text-align: center; padding: 40px;">
                            <div class="spinner"></div>
                            <p>Portföy yükleniyor...</p>
                        </div>
                        
                        <!-- Empty State -->
                        <div id="portfolioEmpty" style="display: none; text-align: center; padding: 60px 20px; color: #8b8fa3;">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                            <h3 style="color: #ffffff; margin-bottom: 12px;">Portföyünüz Boş</h3>
                            <p style="margin-bottom: 24px;">Henüz hiç coin satın almamışsınız. Piyasalar sayfasından coin alım-satımı yapabilirsiniz.</p>
                            <button onclick="showSection('markets')" style="background: #00d4aa; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">
                                <i class="fas fa-shopping-cart"></i> Coin Satın Al
                            </button>
                        </div>
                        
                        <!-- Portfolio Cards View -->
                        <div id="portfolioCards" class="portfolio-cards-container">
                            <!-- Cards will be inserted here -->
                        </div>
                        
                        <!-- Portfolio Table View -->
                        <div id="portfolioTable" class="portfolio-table-container" style="display: none;">
                            <div class="table-wrapper">
                                <table class="enhanced-portfolio-table">
                                    <thead>
                                        <tr>
                                            <th>
                                                <div class="th-content">
                                                    <i class="fas fa-coins"></i>
                                                    <span>Varlık</span>
                                                </div>
                                            </th>
                                            <th>
                                                <div class="th-content">
                                                    <i class="fas fa-layer-group"></i>
                                                    <span>Miktar</span>
                                                </div>
                                            </th>
                                            <th>
                                                <div class="th-content">
                                                    <i class="fas fa-calculator"></i>
                                                    <span>Ort. Fiyat</span>
                                                </div>
                                            </th>
                                            <th>
                                                <div class="th-content">
                                                    <i class="fas fa-chart-line"></i>
                                                    <span>Güncel</span>
                                                </div>
                                            </th>
                                            <th>
                                                <div class="th-content">
                                                    <i class="fas fa-wallet"></i>
                                                    <span>Değer</span>
                                                </div>
                                            </th>
                                            <th>
                                                <div class="th-content">
                                                    <i class="fas fa-chart-bar"></i>
                                                    <span>K/Z</span>
                                                </div>
                                            </th>
                                            <th>
                                                <div class="th-content">
                                                    <i class="fas fa-percentage"></i>
                                                    <span>%</span>
                                                </div>
                                            </th>
                                            <th>
                                                <div class="th-content">
                                                    <i class="fas fa-cogs"></i>
                                                    <span>İşlemler</span>
                                                </div>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="portfolioTableBody">
                                        <!-- Portfolio items will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Para Yatırma Bölümü -->
                <section class="content-section" id="deposit">
                    <div class="section-header">
                        <h2 class="section-title">Para Yatır</h2>
                        <p class="section-subtitle">Hesabınıza para yatırarak işlem yapmaya başlayın</p>
                    </div>

                    <div class="grid grid-2">
                        <!-- Deposit Form -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-plus-circle" style="color: #00d4aa;"></i>
                                    Para Yatırma Formu
                                </h3>
                            </div>
                            
                            <form id="deposit-form" style="display: flex; flex-direction: column; gap: 20px;">
                                <div class="form-group">
                                    <label for="deposit-method" style="display: block; margin-bottom: 8px; font-weight: 600; color: #ffffff;">Yatırma Yöntemi:</label>
                                    <select id="deposit-method" style="width: 100%; padding: 12px 16px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ffffff; font-size: 14px;" required>
                                        <option value="">Yöntem seçiniz</option>
                                        <option value="papara">Papara</option>
                                        <option value="ziraat">Ziraat Bankası</option>
                                        <option value="garanti">Garanti BBVA</option>
                                        <option value="isbank">İş Bankası</option>
                                        <option value="akbank">Akbank</option>
                                        <option value="yapikredi">Yapı Kredi</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="deposit-amount" style="display: block; margin-bottom: 8px; font-weight: 600; color: #ffffff;">Yatırılacak Tutar (₺):</label>
                                    <input type="number" id="deposit-amount" placeholder="1000" min="10" max="50000" step="0.01" style="width: 100%; padding: 12px 16px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ffffff; font-size: 14px;" required>
                                    <small style="color: #8b8fa3; font-size: 12px; margin-top: 4px; display: block;">Minimum: ₺10 - Maksimum: ₺50,000</small>
                                </div>

                                <!-- Papara specific fields -->
                                <div id="papara-fields" class="method-fields" style="display: none;">
                                    <div class="form-group">
                                        <label for="papara-number" style="display: block; margin-bottom: 8px; font-weight: 600; color: #ffffff;">Papara Numarası:</label>
                                        <input type="text" id="papara-number" placeholder="Papara numaranızı girin" style="width: 100%; padding: 12px 16px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ffffff; font-size: 14px;">
                                    </div>
                                </div>

                                <!-- Bank specific fields -->
                                <div id="ziraat-fields" class="method-fields" style="display: none;">
                                    <div class="bank-info-card" style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 15px;">
                                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                            <div class="bank-logo ziraat-logo" style="width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3); overflow: hidden;">
                                <img src="bank_logo/Ziraat_Bankası_logo.png" alt="Ziraat Bankası" style="width: 100%; height: 100%; object-fit: contain; border-radius: 12px;">
                                            </div>
                                            <div>
                                                <h4 style="color: #ffffff; margin: 0 0 5px 0;">Ziraat Bankası</h4>
                                                <p style="color: #8b8fa3; margin: 0; font-size: 14px;">Türkiye Cumhuriyeti Ziraat Bankası A.Ş.</p>
                                            </div>
                                        </div>
                                        <div style="background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 8px; font-family: monospace;">
                                            <p style="margin: 0 0 8px 0; color: #ffffff;"><strong>IBAN:</strong> TR63 0001 0000 0000 0000 0000 01</p>
                                            <p style="margin: 0 0 8px 0; color: #ffffff;"><strong>Hesap Sahibi:</strong> TradePro Ltd. Şti.</p>
                                            <p style="margin: 0; color: #fbbf24; font-size: 12px;"><i class="fas fa-info-circle"></i> Havale açıklamasına kullanıcı adınızı yazınız</p>
                                        </div>
                                    </div>
                                </div>

                                <div id="garanti-fields" class="method-fields" style="display: none;">
                                    <div class="bank-info-card" style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 15px;">
                                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                            <div class="bank-logo garanti-logo" style="width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3); overflow: hidden;">
                                <img src="bank_logo/Garanti_BBVA.png" alt="Garanti BBVA" style="width: 100%; height: 100%; object-fit: contain; border-radius: 12px;">
                                            </div>
                                            <div>
                                                <h4 style="color: #ffffff; margin: 0 0 5px 0;">Garanti BBVA</h4>
                                                <p style="color: #8b8fa3; margin: 0; font-size: 14px;">Türkiye Garanti Bankası A.Ş.</p>
                                            </div>
                                        </div>
                                        <div style="background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 8px; font-family: monospace;">
                                            <p style="margin: 0 0 8px 0; color: #ffffff;"><strong>IBAN:</strong> TR63 0006 2000 0000 0000 0000 02</p>
                                            <p style="margin: 0 0 8px 0; color: #ffffff;"><strong>Hesap Sahibi:</strong> TradePro Ltd. Şti.</p>
                                            <p style="margin: 0; color: #fbbf24; font-size: 12px;"><i class="fas fa-info-circle"></i> Havale açıklamasına kullanıcı adınızı yazınız</p>
                                        </div>
                                    </div>
                                </div>

                                <div id="isbank-fields" class="method-fields" style="display: none;">
                                    <div class="bank-info-card" style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 15px;">
                                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                            <div class="bank-logo isbank-logo" style="width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3); overflow: hidden;">
                                                <img src="bank_logo/Türkiye İş Bankası.png" alt="İş Bankası" style="width: 100%; height: 100%; object-fit: contain; border-radius: 12px;">
                                            </div>
                                            <div>
                                                <h4 style="color: #ffffff; margin: 0 0 5px 0;">İş Bankası</h4>
                                                <p style="color: #8b8fa3; margin: 0; font-size: 14px;">Türkiye İş Bankası A.Ş.</p>
                                            </div>
                                        </div>
                                        <div style="background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 8px; font-family: monospace;">
                                            <p style="margin: 0 0 8px 0; color: #ffffff;"><strong>IBAN:</strong> TR63 0006 4000 0000 0000 0000 03</p>
                                            <p style="margin: 0 0 8px 0; color: #ffffff;"><strong>Hesap Sahibi:</strong> TradePro Ltd. Şti.</p>
                                            <p style="margin: 0; color: #fbbf24; font-size: 12px;"><i class="fas fa-info-circle"></i> Havale açıklamasına kullanıcı adınızı yazınız</p>
                                        </div>
                                    </div>
                                </div>

                                <div id="akbank-fields" class="method-fields" style="display: none;">
                                    <div class="bank-info-card" style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 15px;">
                                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                            <div class="bank-logo akbank-logo" style="width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3); overflow: hidden;">
                                                <img src="bank_logo/Akbank.png" alt="Akbank" style="width: 100%; height: 100%; object-fit: contain; border-radius: 12px;">
                                            </div>
                                            <div>
                                                <h4 style="color: #ffffff; margin: 0 0 5px 0;">Akbank</h4>
                                                <p style="color: #8b8fa3; margin: 0; font-size: 14px;">Akbank T.A.Ş.</p>
                                            </div>
                                        </div>
                                        <div style="background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 8px; font-family: monospace;">
                                            <p style="margin: 0 0 8px 0; color: #ffffff;"><strong>IBAN:</strong> TR63 0004 6000 0000 0000 0000 04</p>
                                            <p style="margin: 0 0 8px 0; color: #ffffff;"><strong>Hesap Sahibi:</strong> TradePro Ltd. Şti.</p>
                                            <p style="margin: 0; color: #fbbf24; font-size: 12px;"><i class="fas fa-info-circle"></i> Havale açıklamasına kullanıcı adınızı yazınız</p>
                                        </div>
                                    </div>
                                </div>

                                <div id="yapikredi-fields" class="method-fields" style="display: none;">
                                    <div class="bank-info-card" style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 15px;">
                                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                            <div class="bank-logo yapikredi-logo" style="width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(233, 30, 99, 0.3); overflow: hidden;">
                                                <img src="bank_logo/Yapı Kredi Bankası.jpg" alt="Yapı Kredi" style="width: 100%; height: 100%; object-fit: contain; border-radius: 12px;">
                                            </div>
                                            <div>
                                                <h4 style="color: #ffffff; margin: 0 0 5px 0;">Yapı Kredi</h4>
                                                <p style="color: #8b8fa3; margin: 0; font-size: 14px;">Yapı ve Kredi Bankası A.Ş.</p>
                                            </div>
                                        </div>
                                        <div style="background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 8px; font-family: monospace;">
                                            <p style="margin: 0 0 8px 0; color: #ffffff;"><strong>IBAN:</strong> TR63 0006 7000 0000 0000 0000 05</p>
                                            <p style="margin: 0 0 8px 0; color: #ffffff;"><strong>Hesap Sahibi:</strong> TradePro Ltd. Şti.</p>
                                            <p style="margin: 0; color: #fbbf24; font-size: 12px;"><i class="fas fa-info-circle"></i> Havale açıklamasına kullanıcı adınızı yazınız</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="deposit-note" style="display: block; margin-bottom: 8px; font-weight: 600; color: #ffffff;">Not (İsteğe bağlı):</label>
                                    <textarea id="deposit-note" rows="3" placeholder="İlave notunuz varsa buraya yazabilirsiniz..." style="width: 100%; padding: 12px 16px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ffffff; font-size: 14px; resize: vertical;"></textarea>
                                </div>

                                <button type="submit" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #00d4aa 0%, #00b894 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 20px rgba(0, 212, 170, 0.3);">
                                    <i class="fas fa-paper-plane"></i> Para Yatırma Talebi Gönder
                                </button>
                            </form>
                        </div>

                        <!-- Deposit Information -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                                    Para Yatırma Bilgileri
                                </h3>
                            </div>
                            
                            <div style="color: #e2e8f0; line-height: 1.6;">
                                <div style="margin-bottom: 20px; padding: 16px; background: rgba(0, 212, 170, 0.1); border-left: 4px solid #00d4aa; border-radius: 8px;">
                                    <h4 style="color: #00d4aa; margin-bottom: 8px;">
                                        <i class="fas fa-clock"></i> İşlem Süreleri
                                    </h4>
                                    <ul style="margin: 0; padding-left: 20px;">
                                        <li><strong>Papara:</strong> Anında</li>
                                        <li><strong>Kredi Kartı:</strong> 5-15 dakika</li>
                                        <li><strong>Banka Havalesi:</strong> 1-2 iş günü</li>
                                    </ul>
                                </div>

                                <div style="margin-bottom: 20px; padding: 16px; background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; border-radius: 8px;">
                                    <h4 style="color: #3b82f6; margin-bottom: 8px;">
                                        <i class="fas fa-shield-alt"></i> Güvenlik
                                    </h4>
                                    <p>Tüm işlemleriniz SSL şifreleme ile korunmaktadır. Kart bilgileriniz güvenli bir şekilde saklanır.</p>
                                </div>

                                <div style="margin-bottom: 20px;">
                                    <h4 style="color: #ffffff; margin-bottom: 12px;">
                                        <i class="fas fa-university"></i> Desteklenen Bankalar
                                    </h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 15px;">
                                        <div style="background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 8px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1);">
                                            <div class="bank-logo ziraat-logo" style="width: 40px; height: 40px; background: linear-gradient(135deg, #2E7D32, #4CAF50); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; margin: 0 auto 5px;">
                                                Z
                                            </div>
                                            <p style="margin: 0; font-size: 12px; color: #8b8fa3;">Ziraat</p>
                                        </div>
                                        <div style="background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 8px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1);">
                                            <div class="bank-logo garanti-logo" style="width: 40px; height: 40px; background: linear-gradient(135deg, #1976D2, #2196F3); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; margin: 0 auto 5px;">
                                                G
                                            </div>
                                            <p style="margin: 0; font-size: 12px; color: #8b8fa3;">Garanti</p>
                                        </div>
                                        <div style="background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 8px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1);">
                                            <div class="bank-logo isbank-logo" style="width: 40px; height: 40px; background: linear-gradient(135deg, #D32F2F, #F44336); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; margin: 0 auto 5px;">
                                                İ
                                            </div>
                                            <p style="margin: 0; font-size: 12px; color: #8b8fa3;">İş Bankası</p>
                                        </div>
                                        <div style="background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 8px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1);">
                                            <div class="bank-logo akbank-logo" style="width: 40px; height: 40px; background: linear-gradient(135deg, #FF9800, #FFC107); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; margin: 0 auto 5px;">
                                                A
                                            </div>
                                            <p style="margin: 0; font-size: 12px; color: #8b8fa3;">Akbank</p>
                                        </div>
                                        <div style="background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 8px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1);">
                                            <div class="bank-logo yapikredi-logo" style="width: 40px; height: 40px; background: linear-gradient(135deg, #9C27B0, #E91E63); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; margin: 0 auto 5px;">
                                                Y
                                            </div>
                                            <p style="margin: 0; font-size: 12px; color: #8b8fa3;">Yapı Kredi</p>
                                        </div>
                                    </div>
                                    <div style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                        <p style="margin: 0; color: #3b82f6; font-size: 13px;">
                                            <i class="fas fa-info-circle"></i>
                                            Yukarıdaki bankalardan birini seçtiğinizde hesap bilgileri otomatik olarak gösterilecektir.
                                        </p>
                                    </div>
                                </div>

                                <div style="padding: 16px; background: rgba(239, 68, 68, 0.1); border-left: 4px solid #ef4444; border-radius: 8px;">
                                    <h4 style="color: #ef4444; margin-bottom: 8px;">
                                        <i class="fas fa-exclamation-circle"></i> Önemli Uyarılar
                                    </h4>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 14px;">
                                        <li>Minimum yatırım tutarı ₺10'dur</li>
                                        <li>Günlük maksimum yatırım limiti ₺50,000'dir</li>
                                        <li>Para yatırma talepleri admin onayı sonrası hesabınıza yansır</li>
                                        <li>Havale açıklamasına mutlaka kullanıcı adınızı yazınız</li>
                                        <li>Yanlış hesap bilgisi kullananlarda işlem gecikebilir</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Deposit Requests -->
                    <div class="card" style="margin-top: 24px;">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-history" style="color: #8b5cf6;"></i>
                                Son Para Yatırma Talepleriniz
                            </h3>
                        </div>
                        <div id="recent-deposits">
                            <div class="loading">
                                <div class="spinner"></div>
                                Talepler yükleniyor...
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Para Çekme Bölümü -->
                <section class="content-section" id="withdrawal">
                    <div class="section-header">
                        <h2 class="section-title">Para Çek</h2>
                        <p class="section-subtitle">Hesabınızdan para çekerek kazançlarınızı nakde çevirin</p>
                    </div>

                    <div class="grid grid-2">
                        <!-- Withdrawal Form -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-minus-circle" style="color: #ef4444;"></i>
                                    Para Çekme Formu
                                </h3>
                            </div>
                            
                            <form id="withdrawal-form" style="display: flex; flex-direction: column; gap: 16px;">
                                <div class="form-group">
                                    <label for="withdrawal-method" style="display: block; margin-bottom: 8px; font-weight: 600; color: #ffffff;">Çekme Yöntemi:</label>
                                    <select id="withdrawal-method" style="width: 100%; padding: 12px 16px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ffffff; font-size: 14px;" required>
                                        <option value="">Yöntem seçiniz</option>
                                        <option value="bank_transfer">Banka Havalesi</option>
                                        <option value="papara">Papara</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="withdrawal-amount" style="display: block; margin-bottom: 8px; font-weight: 600; color: #ffffff;">Çekilecek Tutar (₺):</label>
                                    <input type="number" id="withdrawal-amount" placeholder="1000" min="100" max="50000" step="0.01" style="width: 100%; padding: 12px 16px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ffffff; font-size: 14px;" required>
                                    <small style="color: #8b8fa3; font-size: 12px; margin-top: 4px; display: block;">
                                        Minimum: ₺100 - Maksimum: ₺50,000 - 
                                        <span style="color: #00d4aa;">Mevcut Bakiye: <span id="current-balance-display">₺0.00</span></span>
                                    </small>
                                </div>

                                <!-- Bank Transfer specific fields -->
                                <div id="bank-transfer-fields" class="method-fields" style="display: none; margin-top: 8px;">
                                <div class="form-group">
                                    <label for="recipient-name" style="display: block; margin-bottom: 8px; font-weight: 600; color: #ffffff;">Alıcı Adı Soyadı:</label>
                                    <input type="text" id="recipient-name" placeholder="Adınız Soyadınız" readonly style="width: 100%; padding: 12px 16px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ffffff; font-size: 14px; cursor: not-allowed; opacity: 0.8;">
                                    <small style="color: #8b8fa3; font-size: 12px; margin-top: 4px; display: block;">
                                        <i class="fas fa-lock"></i> Bu alan otomatik olarak hesap bilgilerinizden doldurulur
                                    </small>
                                </div>
                                    <div class="form-group">
                                        <label for="bank-name" style="display: block; margin-bottom: 8px; font-weight: 600; color: #ffffff;">Banka Adı:</label>
                                        <select id="bank-name" style="width: 100%; padding: 12px 16px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ffffff; font-size: 14px;">
                                            <option value="">Banka seçiniz</option>
                                            <option value="ziraat">Ziraat Bankası</option>
                                            <option value="garanti">Garanti BBVA</option>
                                            <option value="isbank">İş Bankası</option>
                                            <option value="akbank">Akbank</option>
                                            <option value="yapikredi">Yapı Kredi</option>
                                            <option value="other">Diğer</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="iban-number" style="display: block; margin-bottom: 8px; font-weight: 600; color: #ffffff;">IBAN Numarası:</label>
                                        <input type="text" id="iban-number" placeholder="TR00 0000 0000 0000 0000 0000 00" maxlength="26" style="width: 100%; padding: 12px 16px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ffffff; font-size: 14px; font-family: monospace;">
                                        <small style="color: #8b8fa3; font-size: 12px; margin-top: 4px; display: block;">
                                            <i class="fas fa-info-circle"></i> IBAN numarası TR ile başlamalı ve tam 26 karakter olmalıdır
                                        </small>
                                    </div>
                                </div>

                                <!-- Papara specific fields -->
                                <div id="papara-withdrawal-fields" class="method-fields" style="display: none; margin-top: 8px;">
                                    <div class="form-group">
                                        <label for="papara-withdrawal-number" style="display: block; margin-bottom: 8px; font-weight: 600; color: #ffffff;">Papara Numarası:</label>
                                        <input type="text" id="papara-withdrawal-number" placeholder="Papara numaranızı girin" maxlength="10" pattern="[0-9]{10}" style="width: 100%; padding: 12px 16px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ffffff; font-size: 14px;">
                                        <small style="color: #8b8fa3; font-size: 12px; margin-top: 4px; display: block;">Papara numarası tam 10 haneli olmalıdır</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="papara-account-name" style="display: block; margin-bottom: 8px; font-weight: 600; color: #ffffff;">Papara Hesap Sahibi:</label>
                                        <input type="text" id="papara-account-name" placeholder="Hesap sahibinin adı soyadı" style="width: 100%; padding: 12px 16px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ffffff; font-size: 14px;">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="withdrawal-note" style="display: block; margin-bottom: 8px; font-weight: 600; color: #ffffff;">Not (İsteğe bağlı):</label>
                                    <textarea id="withdrawal-note" rows="3" placeholder="İlave notunuz varsa buraya yazabilirsiniz..." style="width: 100%; padding: 12px 16px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #ffffff; font-size: 14px; resize: vertical;"></textarea>
                                </div>

                                <!-- Balance Check -->
                                <div id="balance-check-info" style="display: none; background: rgba(239, 68, 68, 0.1); border-left: 4px solid #ef4444; border-radius: 8px; padding: 12px;">
                                    <div style="color: #ef4444; font-size: 14px;">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <span>Yetersiz bakiye! Maksimum çekebileceğiniz tutar: <span id="max-withdrawal">₺0.00</span></span>
                                    </div>
                                </div>

                                <button type="submit" id="withdrawal-submit-btn" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);">
                                    <i class="fas fa-paper-plane"></i> Para Çekme Talebi Gönder
                                </button>
                            </form>
                        </div>

                        <!-- Withdrawal Information -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-info-circle" style="color: #f59e0b;"></i>
                                    Para Çekme Bilgileri
                                </h3>
                            </div>
                            
                            <div style="color: #e2e8f0; line-height: 1.6;">
                                <div style="margin-bottom: 20px; padding: 16px; background: rgba(239, 68, 68, 0.1); border-left: 4px solid #ef4444; border-radius: 8px;">
                                    <h4 style="color: #ef4444; margin-bottom: 8px;">
                                        <i class="fas fa-clock"></i> İşlem Süreleri
                                    </h4>
                                    <ul style="margin: 0; padding-left: 20px;">
                                        <li><strong>Banka Havalesi:</strong> 1-3 iş günü</li>
                                        <li><strong>Papara:</strong> 2-24 saat (iş günleri)</li>
                                        <li><strong>İnceleme Süresi:</strong> Maksimum 24 saat</li>
                                    </ul>
                                </div>

                                <div style="margin-bottom: 20px; padding: 16px; background: rgba(245, 158, 11, 0.1); border-left: 4px solid #f59e0b; border-radius: 8px;">
                                    <h4 style="color: #f59e0b; margin-bottom: 8px;">
                                        <i class="fas fa-shield-alt"></i> Güvenlik ve Doğrulama
                                    </h4>
                                    <p>Para çekme işlemleri güvenlik kontrolünden geçer. Hesap sahibi doğrulaması yapılır ve tüm bilgiler kontrol edilir.</p>
                                </div>

                                <div style="margin-bottom: 20px;">
                                    <h4 style="color: #ffffff; margin-bottom: 12px;">
                                        <i class="fas fa-university"></i> Desteklenen Çekme Yöntemleri
                                    </h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 15px;">
                                        <div style="background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 8px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1);">
                                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #2563eb, #3b82f6); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; margin: 0 auto 5px;">
                                                <i class="fas fa-university"></i>
                                            </div>
                                            <p style="margin: 0; font-size: 12px; color: #8b8fa3;">Banka Havalesi</p>
                                        </div>
                                        <div style="background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 8px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1);">
                                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #7c3aed, #8b5cf6); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; margin: 0 auto 5px;">
                                                P
                                            </div>
                                            <p style="margin: 0; font-size: 12px; color: #8b8fa3;">Papara</p>
                                        </div>
                                    </div>
                                    <div style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                        <p style="margin: 0; color: #3b82f6; font-size: 13px;">
                                            <i class="fas fa-info-circle"></i>
                                            Para çekme işlemleri sadece kendi adınıza kayıtlı hesaplara yapılabilir.
                                        </p>
                                    </div>
                                </div>

                                <div style="padding: 16px; background: rgba(239, 68, 68, 0.1); border-left: 4px solid #ef4444; border-radius: 8px;">
                                    <h4 style="color: #ef4444; margin-bottom: 8px;">
                                        <i class="fas fa-exclamation-circle"></i> Önemli Kurallar
                                    </h4>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 14px;">
                                        <li>Minimum çekme tutarı ₺100'dür</li>
                                        <li>Günlük maksimum çekme limiti ₺50,000'dir</li>
                                        <li>Para çekme işlemi komisyonsuz ve ücretsizdir</li>
                                        <li>Hesap doğrulaması tamamlanmamış hesaplardan para çekilemez</li>
                                        <li>IBAN bilgileri mutlaka doğru girilmelidir</li>
                                        <li>Sadece kendi adınıza kayıtlı hesaplara para çekebilirsiniz</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Withdrawal Requests -->
                    <div class="card" style="margin-top: 24px;">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-history" style="color: #8b5cf6;"></i>
                                Son Para Çekme Talepleriniz
                            </h3>
                        </div>
                        <div id="recent-withdrawals">
                            <div class="loading">
                                <div class="spinner"></div>
                                Talepler yükleniyor...
                            </div>
                        </div>
                    </div>
                </section>
                
                <section class="content-section" id="markets">
                    <div class="section-header">
                        <h2 class="section-title">Piyasalar</h2>
                        <p class="section-subtitle">Anlık kripto para fiyatları ve piyasa analizi</p>
                    </div>
                    
                    <div class="modern-market-container">
                        <div class="market-header">
                            <div class="market-title-section">
                                <h3 class="market-title">
                                    <i class="fas fa-chart-line"></i>
                                    Kripto Para Piyasası
                                </h3>
                                <p class="market-subtitle">Gerçek zamanlı veriler • Güncellenme: <span id="lastUpdate">Şimdi</span></p>
                            </div>
                            <div class="market-controls">
                                <div class="search-container">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="coinSearch" placeholder="Coin ara...">
                                </div>
                                <button class="refresh-btn" onclick="refreshMarketData()">
                                    <i class="fas fa-sync-alt"></i>
                                    <span>Yenile</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="market-filters">
                            <button class="filter-chip active" data-filter="all">
                                <i class="fas fa-star"></i> Tümü
                            </button>
                            <button class="filter-chip" data-filter="favorites">
                                <i class="fas fa-heart"></i> Favoriler
                            </button>
                            <button class="filter-chip" data-filter="trending">
                                <i class="fas fa-fire"></i> Trend
                            </button>
                            <button class="filter-chip" data-filter="top">
                                <i class="fas fa-trophy"></i> Top 10
                            </button>
                        </div>
                        
                        <div id="marketLoader" class="modern-loading">
                            <div class="loading-animation">
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                            </div>
                            <p>Piyasa verileri yükleniyor...</p>
                        </div>
                        
                        <!-- Desktop Coins Grid -->
                        <div id="desktopCoinsGrid" class="desktop-coins-grid" style="display: none;">
                            <!-- Coin kartları buraya yüklenecek -->
                        </div>
                        
                        <!-- Mobile Coins Grid -->
                        <div id="mobileCoinsGrid" class="mobile-coins-grid" style="display: none;">
                            <!-- Mobil coin kartları buraya yüklenecek -->
                        </div>
                        
                        <!-- Legacy table (gizli) -->
                        <div id="marketTable" style="display: none;">
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="border-bottom: 1px solid #2a2f3e;">
                                            <th style="padding: 12px; text-align: left; color: #8b8fa3; font-weight: 600;">#</th>
                                            <th style="padding: 12px; text-align: left; color: #8b8fa3; font-weight: 600;">Coin</th>
                                            <th style="padding: 12px; text-align: right; color: #8b8fa3; font-weight: 600;">Fiyat</th>
                                            <th style="padding: 12px; text-align: right; color: #8b8fa3; font-weight: 600;">24s %</th>
                                            <th style="padding: 12px; text-align: right; color: #8b8fa3; font-weight: 600;">Piyasa Değeri</th>
                                            <th style="padding: 12px; text-align: center; color: #8b8fa3; font-weight: 600;">İşlem</th>
                                        </tr>
                                    </thead>
                                    <tbody id="marketTableBody">
                                        <!-- Coin verileri buraya yüklenecek -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
                

                <!-- Trading Modal - Tamamen Yenilenmiş -->
                <div id="tradingModal" class="trading-modal-enhanced" style="display: none;">
                    <div class="modal-overlay" onclick="closeTradingModal()"></div>
                    <div class="modal-container-enhanced">
                        <!-- Header -->
                        <div class="modal-header-enhanced">
                            <div class="coin-info">
                                <div class="coin-icon-container">
                                    <i class="fab fa-bitcoin" id="modalCoinIcon"></i>
                                </div>
                                <div class="coin-details">
                                    <h2 id="modalCoinName">Bitcoin</h2>
                                    <span id="modalCoinSymbol">BTC</span>
                                </div>
                                <div class="price-info">
                                    <div class="current-price" id="modalCoinPrice">₺1,350,000</div>
                                    <div class="price-change positive" id="modalCoinChange">+2.45%</div>
                                </div>
                            </div>
                            <button class="close-btn" onclick="closeTradingModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <!-- Trading Form -->
                        <div class="modal-body-enhanced">
                            <!-- Direction Buttons -->
                            <div class="direction-buttons">
                                <button class="direction-btn buy-btn active" data-direction="buy">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>SATIN AL</span>
                                    <small id="buyPrice">₺1,350,000</small>
                                </button>
                                <button class="direction-btn sell-btn" data-direction="sell">
                                    <i class="fas fa-arrow-down"></i>
                                    <span>SATIŞ YAP</span>
                                    <small id="sellPrice">₺1,348,000</small>
                                </button>
                            </div>
                            
                            <!-- Trading Mode Selection -->
                            <div class="trading-mode-selection">
                                <div class="mode-tabs">
                                    <button class="mode-tab active" data-mode="spot">
                                        <i class="fas fa-exchange-alt"></i>
                                        <span>Spot</span>
                                    </button>
                                    <button class="mode-tab" data-mode="leverage">
                                        <i class="fas fa-chart-line"></i>
                                        <span>Kaldıraçlı</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Leverage Selection (Only for leverage mode) -->
                            <div class="leverage-selection" id="leverageSelection" style="display: none;">
                                <div class="leverage-header">
                                    <label>Kaldıraç Oranı</label>
                                    <div class="leverage-info">
                                        <i class="fas fa-info-circle"></i>
                                        <span>Yüksek kaldıraç yüksek risk taşır</span>
                                    </div>
                                </div>
                                <div class="leverage-buttons">
                                    <button class="leverage-btn active" data-leverage="1">1x</button>
                                    <button class="leverage-btn" data-leverage="2">2x</button>
                                    <button class="leverage-btn" data-leverage="5">5x</button>
                                    <button class="leverage-btn" data-leverage="10">10x</button>
                                </div>
                                <div class="position-type-selection">
                                    <button class="position-btn long-btn active" data-position="long">
                                        <i class="fas fa-arrow-up"></i>
                                        <span>Long (Yükseliş)</span>
                                    </button>
                                    <button class="position-btn short-btn" data-position="short">
                                        <i class="fas fa-arrow-down"></i>
                                        <span>Short (Düşüş)</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Input Tabs -->
                            <div class="input-tabs">
                                <button class="input-tab active" data-tab="amount">Miktar</button>
                                <button class="input-tab" data-tab="total">Toplam ₺</button>
                            </div>
                            
                            <!-- Amount Input -->
                            <div class="input-section" id="amountSection">
                                <div class="input-group-enhanced">
                                    <label>Alınacak/Satılacak Miktar</label>
                                    <div class="input-with-suffix">
                                        <input type="number" id="coinAmount" placeholder="0.00000000" step="0.00000001" min="0">
                                        <span class="suffix" id="quantitySuffix">BTC</span>
                                    </div>
                                </div>
                                <div class="percentage-buttons">
                                    <button class="percent-btn" data-percent="25">25%</button>
                                    <button class="percent-btn" data-percent="50">50%</button>
                                    <button class="percent-btn" data-percent="75">75%</button>
                                    <button class="percent-btn" data-percent="100">Tümü</button>
                                </div>
                            </div>
                            
                            <!-- Total Input -->
                            <div class="input-section" id="totalSection" style="display: none;">
                                <div class="input-group-enhanced">
                                    <label>Harcanacak/Alınacak Tutar</label>
                                    <div class="input-with-suffix">
                                        <input type="number" id="totalAmount" placeholder="0.00" step="0.01" min="0">
                                        <span class="suffix">₺</span>
                                    </div>
                                </div>
                                <div class="percentage-buttons">
                                    <button class="percent-btn" data-percent="25">25%</button>
                                    <button class="percent-btn" data-percent="50">50%</button>
                                    <button class="percent-btn" data-percent="75">75%</button>
                                    <button class="percent-btn" data-percent="100">Tümü</button>
                                </div>
                            </div>
                            
                            <!-- Transaction Summary -->
                            <div class="transaction-summary">
                                <div class="summary-header">
                                    <h4>İşlem Özeti</h4>
                                </div>
                                <div class="summary-rows">
                                    <div class="summary-row">
                                        <span>Coin Fiyatı:</span>
                                        <span id="currentCoinPrice">₺1,350,000.00</span>
                                    </div>
                                    <div class="summary-row">
                                        <span>Miktar:</span>
                                        <span id="calculatedAmount">0.00000000 BTC</span>
                                    </div>
                                    <div class="summary-row">
                                        <span>İşlem Tutarı:</span>
                                        <span id="calculatedTotal">₺0.00</span>
                                    </div>
                                    
                                    <!-- Leverage-specific rows -->
                                    <div class="leverage-summary-rows" id="leverageSummaryRows" style="display: none;">
                                        <div class="summary-row">
                                            <span>Kaldıraç Oranı:</span>
                                            <span id="leverageRatio">1x</span>
                                        </div>
                                        <div class="summary-row">
                                            <span>Pozisyon Büyüklüğü:</span>
                                            <span id="positionSize">0.00000000 BTC</span>
                                        </div>
                                        <div class="summary-row">
                                            <span>Liquidation Fiyatı:</span>
                                            <span id="liquidationPrice">₺0.00</span>
                                        </div>
                                        <div class="summary-row">
                                            <span>Yatırılan Miktar:</span>
                                            <span id="investedAmount">₺0.00</span>
                                        </div>
                                        <div class="summary-divider"></div>
                                    </div>
                                    
                                    <div class="summary-row">
                                        <span>Komisyon (0.1%):</span>
                                        <span id="calculatedFee">₺0.00</span>
                                    </div>
                                    <div class="summary-divider"></div>
                                    <div class="summary-row total-row">
                                        <span>Toplam Tutar:</span>
                                        <span id="finalTotal">₺0.00</span>
                                    </div>
                                    <div class="summary-row">
                                        <span>Mevcut Bakiye:</span>
                                        <span id="currentBalance">₺0.00</span>
                                    </div>
                                    <div class="summary-row">
                                        <span>Kalan Bakiye:</span>
                                        <span id="remainingBalance">₺0.00</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Execute Button -->
                            <button id="executeOrderBtn" class="execute-btn buy-order" disabled>
                                <i class="fas fa-shopping-cart"></i>
                                <span id="executeText">BTC Satın Al</span>
                            </button>
                            
                            <!-- Balance Warning -->
                            <div id="balanceWarning" class="balance-warning" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>Yetersiz bakiye</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                
                
                <section class="content-section" id="positions">
                    <div class="section-header">
                        <h2 class="section-title">Kaldıraçlı Pozisyonlar</h2>
                        <p class="section-subtitle">Açık pozisyonlarınız ve kar/zarar durumu</p>
                    </div>
                    
                    <!-- Modern Pozisyon Özeti -->
                    <div class="positions-summary-grid">
                        <div class="position-stat-card active-positions">
                            <div class="position-stat-header">
                                <div class="position-stat-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="position-stat-trend" id="positionsTrend">
                                    <i class="fas fa-arrow-up"></i>
                                </div>
                            </div>
                            <div class="position-stat-content">
                                <h3 class="position-stat-value" id="totalPositions">0</h3>
                                <p class="position-stat-label">Açık Pozisyon</p>
                                <div class="position-stat-change" id="positionsChange">Bu hafta: +0</div>
                            </div>
                        </div>
                        
                        <div class="position-stat-card total-investment">
                            <div class="position-stat-header">
                                <div class="position-stat-icon">
                                    <i class="fas fa-coins"></i>
                                </div>
                                <div class="position-stat-badge" id="newInvestmentBadge">₺0</div>
                            </div>
                            <div class="position-stat-content">
                                <h3 class="position-stat-value" id="totalInvested">₺0</h3>
                                <p class="position-stat-label">Toplam Yatırım</p>
                                <div class="position-stat-change" id="investmentChange">Ortalama: ₺0</div>
                            </div>
                        </div>
                        
                        <div class="position-stat-card total-pnl">
                            <div class="position-stat-header">
                                <div class="position-stat-icon">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                                <div class="position-stat-trend" id="pnlTrend">
                                    <i class="fas fa-arrow-up"></i>
                                </div>
                            </div>
                            <div class="position-stat-content">
                                <h3 class="position-stat-value" id="totalUnrealizedPnL">₺0</h3>
                                <p class="position-stat-label">Gerçekleşmemiş K/Z</p>
                                <div class="position-stat-change" id="pnlPercentage">0%</div>
                            </div>
                        </div>
                        
                        <div class="position-stat-card best-position">
                            <div class="position-stat-header">
                                <div class="position-stat-icon">
                                    <i class="fas fa-trophy"></i>
                                </div>
                                <div class="position-stat-trend up">
                                    <i class="fas fa-crown"></i>
                                </div>
                            </div>
                            <div class="position-stat-content">
                                <h3 class="position-stat-value" id="bestPositionValue">-</h3>
                                <p class="position-stat-label">En İyi Pozisyon</p>
                                <div class="position-stat-change" id="bestPositionChange">-</div>
                            </div>
                        </div>
                    </div>
                    




                    <!-- Basit Pozisyonlar Paneli -->
                    <div class="simple-positions-container">
                        <div class="simple-positions-header">
                            <div class="positions-title-section">
                                <h3 class="positions-main-title">
                                    <i class="fas fa-chart-line"></i>
                                    Açık Pozisyonlar
                                </h3>
                                <p class="positions-subtitle">Kaldıraçlı işlemleriniz</p>
                            </div>
                            <button class="simple-refresh-btn" onclick="refreshPositions()">
                                <i class="fas fa-sync-alt"></i>
                                <span>Yenile</span>
                            </button>
                        </div>
                        
                        <!-- Pozisyon Listesi -->
                        <div id="positionsTable" class="simple-positions-list">
                            <!-- Position items will be inserted here -->
                        </div>
                        
                        <!-- Loading State -->
                        <div id="positionsLoader" class="positions-loading" style="display: none;">
                            <div class="spinner"></div>
                            <p>Pozisyonlar yükleniyor...</p>
                        </div>
                        
                        <!-- Empty State -->
                        <div id="positionsEmpty" class="positions-empty" style="display: none;">
                            <i class="fas fa-chart-line"></i>
                            <h3>Henüz Açık Pozisyonunuz Yok</h3>
                            <p>Kaldıraçlı işlem yapmak için piyasalar sayfasından coin seçebilirsiniz.</p>
                            <button onclick="showSection('markets')" class="empty-action-btn">
                                <i class="fas fa-plus"></i> Pozisyon Aç
                            </button>
                        </div>
                    </div>
                    
                    <!-- Modern Pozisyon Geçmişi -->
                    <div class="position-history-container">
                        <div class="position-history-header">
                            <div class="position-history-title-section">
                                <h3 class="position-history-main-title">
                                    <i class="fas fa-history"></i>
                                    Pozisyon Geçmişi
                                </h3>
                                <p class="position-history-subtitle">Geçmiş işlemleriniz ve gerçekleşen kar/zarar durumu</p>
                            </div>
                            <div class="position-history-controls">
                                <div class="history-filter-buttons">
                                    <button class="history-filter-btn active" data-filter="all">Tümü</button>
                                    <button class="history-filter-btn" data-filter="profitable">Karlı</button>
                                    <button class="history-filter-btn" data-filter="loss">Zararlı</button>
                                </div>
                                <button class="history-refresh-btn" onclick="loadPositionHistory()">
                                    <i class="fas fa-sync-alt"></i>
                                    <span>Yenile</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Geçmiş Özet Kartları -->
                        <div class="history-summary-grid">
                            <div class="history-stat-card total-trades">
                                <div class="history-stat-icon">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                                <div class="history-stat-content">
                                    <h4 class="history-stat-value" id="totalTrades">0</h4>
                                    <p class="history-stat-label">Toplam İşlem</p>
                                </div>
                            </div>
                            
                            <div class="history-stat-card win-rate">
                                <div class="history-stat-icon">
                                    <i class="fas fa-trophy"></i>
                                </div>
                                <div class="history-stat-content">
                                    <h4 class="history-stat-value" id="winRate">0%</h4>
                                    <p class="history-stat-label">Başarı Oranı</p>
                                </div>
                            </div>
                            
                            <div class="history-stat-card total-pnl">
                                <div class="history-stat-icon">
                                    <i class="fas fa-coins"></i>
                                </div>
                                <div class="history-stat-content">
                                    <h4 class="history-stat-value" id="totalHistoryPnL">₺0</h4>
                                    <p class="history-stat-label">Toplam K/Z</p>
                                </div>
                            </div>
                            
                            <div class="history-stat-card avg-pnl">
                                <div class="history-stat-icon">
                                    <i class="fas fa-calculator"></i>
                                </div>
                                <div class="history-stat-content">
                                    <h4 class="history-stat-value" id="avgPnL">₺0</h4>
                                    <p class="history-stat-label">Ortalama K/Z</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Geçmiş Listesi -->
                        <div class="position-history-list">
                            <!-- Loading State -->
                            <div id="historyLoader" class="history-loading" style="display: none;">
                                <div class="spinner"></div>
                                <p>Geçmiş yükleniyor...</p>
                            </div>
                            
                            <!-- Empty State -->
                            <div id="historyEmpty" class="history-empty" style="display: none;">
                                <i class="fas fa-history"></i>
                                <h3>Henüz Pozisyon Geçmişiniz Yok</h3>
                                <p>İlk kaldıraçlı işleminizi yaptığınızda geçmiş burada görünecek.</p>
                            </div>
                            
                            <!-- History Items -->
                            <div id="historyItems" class="history-items-container">
                                <!-- History items will be inserted here -->
                            </div>
                        </div>
                    </div>
                </section>
                
                <section class="content-section" id="profile">
                    <!-- Modern Mobile-First Profile Header -->
                    <div class="modern-profile-header">
                        <div class="profile-hero-section">
                            <div class="profile-background-gradient"></div>
                            <div class="profile-hero-content">
                                <div class="profile-avatar-section">
                                    <div class="profile-avatar-container">
                                        <div class="profile-avatar" id="profileAvatar">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="avatar-status-indicator online"></div>
                                        <button class="edit-avatar-btn" onclick="editProfileAvatar()">
                                            <i class="fas fa-camera"></i>
                                        </button>
                                    </div>
                                    <div class="profile-user-info">
                                        <h2 class="profile-username" id="profileUsername">Kullanıcı</h2>
                                        <p class="profile-user-level" id="profileUserLevel">Premium Member</p>
                                        <div class="profile-join-date" id="profileJoinDate">
                                            <i class="fas fa-calendar-alt"></i>
                                            <span>Üye olma: Ocak 2024</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Enhanced Balance Display -->
                                <div class="profile-balance-hero">
                                    <div class="balance-hero-card">
                                        <div class="balance-label">Toplam Bakiye</div>
                                        <div class="balance-amount" id="profileBalanceAmount">₺0.00</div>
                                        <div class="balance-change" id="profileBalanceChange">+₺0.00 (0%)</div>
                                        <div class="balance-quick-actions">
                                            <button class="balance-action-btn deposit" onclick="showSection('deposit')">
                                                <i class="fas fa-plus"></i>
                                                <span>Para Yatır</span>
                                            </button>
                                            <button class="balance-action-btn withdraw" onclick="showWithdrawalComingSoon()">
                                                <i class="fas fa-minus"></i>
                                                <span>Para Çek</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modern Stats Grid -->
                    <div class="modern-stats-container">
                        <div class="stats-grid-mobile">
                            <div class="modern-stat-card trades">
                                <div class="stat-card-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="stat-card-content">
                                    <div class="stat-card-value" id="modernTotalTrades">0</div>
                                    <div class="stat-card-label">Toplam İşlem</div>
                                    <div class="stat-card-trend">
                                        <i class="fas fa-arrow-up"></i>
                                        <span>Bu ay: +5</span>
                                    </div>
                                </div>
                            </div>

                            <div class="modern-stat-card profit">
                                <div class="stat-card-icon">
                                    <i class="fas fa-trophy"></i>
                                </div>
                                <div class="stat-card-content">
                                    <div class="stat-card-value" id="modernProfitLoss">₺0</div>
                                    <div class="stat-card-label">Toplam K/Z</div>
                                    <div class="stat-card-trend positive">
                                        <i class="fas fa-arrow-up"></i>
                                        <span>+12.5%</span>
                                    </div>
                                </div>
                            </div>

                            <div class="modern-stat-card portfolio">
                                <div class="stat-card-icon">
                                    <i class="fas fa-briefcase"></i>
                                </div>
                                <div class="stat-card-content">
                                    <div class="stat-card-value" id="modernPortfolioValue">₺0</div>
                                    <div class="stat-card-label">Portföy Değeri</div>
                                    <div class="stat-card-trend">
                                        <i class="fas fa-coins"></i>
                                        <span>5 varlık</span>
                                    </div>
                                </div>
                            </div>

                            <div class="modern-stat-card membership">
                                <div class="stat-card-icon">
                                    <i class="fas fa-calendar"></i>
                                </div>
                                <div class="stat-card-content">
                                    <div class="stat-card-value" id="modernMemberSince">3</div>
                                    <div class="stat-card-label">Ay Üye</div>
                                    <div class="stat-card-trend">
                                        <i class="fas fa-star"></i>
                                        <span>Aktif</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modern Profile Details -->
                    <div class="modern-profile-details">
                        <div class="profile-details-container">
                            <div class="profile-details-header">
                                <h3 class="profile-details-title">
                                    <i class="fas fa-user-circle"></i>
                                    Hesap Bilgileri
                                </h3>
                                <button class="edit-profile-btn" onclick="editProfileInfo()">
                                    <i class="fas fa-edit"></i>
                                    <span>Düzenle</span>
                                </button>
                            </div>
                            
                            <div class="profile-info-grid" id="modernUserInfo">
                                <div class="loading-state">
                                    <div class="modern-spinner"></div>
                                    <p>Profil bilgileri yükleniyor...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Legacy Profile Info (Hidden but preserved for JS compatibility) -->
                    <div id="userInfo" style="display: none;"></div>
                    <div id="balanceInfo" style="display: none;"></div>
                    <div id="totalTrades" style="display: none;">0</div>
                    <div id="profitLoss" style="display: none;">₺0</div>
                    <div id="memberSince" style="display: none;">0</div>

                    <!-- Modern Transaction History -->
                    <div class="modern-transaction-container">
                        <div class="transaction-container-header">
                            <div class="transaction-title-section">
                                <h3 class="transaction-main-title">
                                    <i class="fas fa-history"></i>
                                    İşlem Geçmişi
                                </h3>
                                <p class="transaction-subtitle">Son işlemleriniz ve detayları</p>
                            </div>
                            <div class="transaction-controls">
                                <div class="transaction-filter-tabs">
                                    <button class="filter-tab active" data-filter="all">Tümü</button>
                                    <button class="filter-tab" data-filter="buy">Alım</button>
                                    <button class="filter-tab" data-filter="sell">Satım</button>
                                    <button class="filter-tab" data-filter="deposit">Yatırım</button>
                                </div>
                                <button class="modern-refresh-btn" onclick="loadTransactionHistory()">
                                    <i class="fas fa-sync-alt"></i>
                                    <span>Yenile</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="modern-transaction-list" id="modernTransactionHistory">
                            <div class="loading-state">
                                <div class="modern-spinner"></div>
                                <p>İşlem geçmişi yükleniyor...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Legacy Transaction History (Hidden but preserved for JS compatibility) -->
                    <div id="transactionHistory" style="display: none;"></div>

                    <!-- Quick Actions Panel -->
                    <div class="profile-quick-actions">
                        <div class="quick-actions-header">
                            <h3>Hızlı İşlemler</h3>
                        </div>
                        <div class="quick-actions-grid">
                            <button class="quick-action-btn" onclick="showSection('markets')">
                                <div class="quick-action-icon">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                                <div class="quick-action-text">
                                    <span>Coin Al</span>
                                    <small>Piyasalara git</small>
                                </div>
                            </button>

                            <button class="quick-action-btn" onclick="showSection('portfolio')">
                                <div class="quick-action-icon">
                                    <i class="fas fa-briefcase"></i>
                                </div>
                                <div class="quick-action-text">
                                    <span>Portföy</span>
                                    <small>Varlıklarım</small>
                                </div>
                            </button>

                            <button class="quick-action-btn" onclick="showSection('deposit')">
                                <div class="quick-action-icon">
                                    <i class="fas fa-plus-circle"></i>
                                </div>
                                <div class="quick-action-text">
                                    <span>Para Yatır</span>
                                    <small>Bakiye ekle</small>
                                </div>
                            </button>

                            <button class="quick-action-btn" onclick="showSection('positions')">
                                <div class="quick-action-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="quick-action-text">
                                    <span>Pozisyonlar</span>
                                    <small>Kaldıraçlı işlemler</small>
                                </div>
                            </button>
                        </div>
                    </div>
                </section>
                
            </div>
        </main>
    </div>

    <script>
        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            setupNavigation();
            setupDepositForm(); // Para yatırma formunu başlat
            
            // Market initialization'ı geciktir
            setTimeout(() => {
                refreshMarketData(); // Sayfa yüklendiğinde piyasaları yükle
            }, 1000);
            
            initTrading(); // Trading sistemini başlat
            refreshPositions(); // Pozisyonları yükle
            
            // Arama kutusu için event listener - null check ekle
            const searchInput = document.getElementById('coinSearch');
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        refreshMarketData();
                    }, 500); // 500ms gecikme ile arama yap
                });
            }
        });

        // Navigasyon sistemi
        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.content-section');
            const pageTitle = document.getElementById('pageTitle');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const targetSection = this.dataset.section;
                    
                    // Aktif nav linkini güncelle
                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Bölümleri gizle/göster
                    sections.forEach(section => {
                        section.classList.remove('active');
                    });
                    document.getElementById(targetSection).classList.add('active');
                    
                    // Sayfa başlığını güncelle
                    const titles = {
                        'dashboard': 'Dashboard',
                        'portfolio': 'Portföyüm',
                        'markets': 'Piyasalar',
                        'trading': 'İşlem Yap',
                        'positions': 'Pozisyonlar',
                        'recommendations': 'Yatırım Tavsiyeleri',
                        'wallet': 'Cüzdan',
                        'deposit': 'Para Yatır',
                        'withdrawal': 'Para Çek',
                        'profile': 'Profil'
                    };
                    pageTitle.textContent = titles[targetSection] || 'Dashboard';
                    
                    // Section-specific loading
                    if (targetSection === 'deposit') {
                        loadRecentDeposits();
                        stopPriceUpdates(); // Diğer sekmelerde fiyat güncellemesini durdur
                    } else if (targetSection === 'withdrawal') {
                        loadRecentWithdrawals();
                        stopPriceUpdates(); // Diğer sekmelerde fiyat güncellemesini durdur
                    } else if (targetSection === 'portfolio') {
                        loadPortfolio();
                        stopPriceUpdates();
                    } else if (targetSection === 'positions') {
                        loadPositions();
                        loadPositionHistory(); // Pozisyon geçmişini de yükle
                        startPriceUpdates(); // Pozisyonlar sekmesinde otomatik fiyat güncelleme başlat
                        initCandlestickChart(); // Candlestick grafiği başlat
                    } else if (targetSection === 'profile') {
                        loadTransactionHistory();
                        stopPriceUpdates();
                    } else {
                        stopPriceUpdates(); // Diğer tüm sekmelerde durdur
                    }
                });
            });
        }

        // Kullanıcı bilgilerini yükle
        function loadUserInfo() {
            fetch('backend/public/profile.php', {
                method: 'GET',
                credentials: 'include'
            })
            .then(r => r.json())
            .then(data => {
                if(data.success) {
                    console.log('✅ Kullanıcı bilgileri yüklendi:', data.user);
                    
                    // Bakiye göster
                    const balance = parseFloat(data.user.balance) || 0;
                    const balanceFormatted = balance.toLocaleString('tr-TR', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    
                    document.getElementById('userBalance').innerHTML = 
                        `<i class="fas fa-wallet"></i> ₺${balanceFormatted}`;
                    
                    document.getElementById('totalBalance').innerHTML = 
                        `<h1 style="font-size: 2rem; color: #00d4aa;">₺${balanceFormatted}</h1>`;
                    
                    // Avatar harfi - element kontrolü ekle (user-avatar elementi kaldırıldığı için bu kod devre dışı)
                    // const firstLetter = data.user.username.charAt(0).toUpperCase();
                    // const userAvatarElement = document.getElementById('userAvatar');
                    // if (userAvatarElement) {
                    //     userAvatarElement.textContent = firstLetter;
                    // }
                    
                    // Profil bilgileri
                    document.getElementById('userInfo').innerHTML = `
                        <div style="line-height: 1.8;">
                            <p><strong>Kullanıcı Adı:</strong> ${data.user.username || 'N/A'}</p>
                            <p><strong>Email:</strong> ${data.user.email || 'N/A'}</p>
                            <p><strong>Ad Soyad:</strong> ${data.user.ad_soyad || 'Belirtilmemiş'}</p>
                            <p><strong>Kayıt Tarihi:</strong> ${data.user.created_at ? new Date(data.user.created_at).toLocaleDateString('tr-TR') : 'N/A'}</p>
                            <p><strong>Son Giriş:</strong> ${data.user.son_giris ? new Date(data.user.son_giris).toLocaleDateString('tr-TR') : 'İlk giriş'}</p>
                            <p><strong>Hesap Tipi:</strong> ${data.user.role === 'admin' ? 'Yönetici' : 'Standart Kullanıcı'}</p>
                            <p><strong>Toplam Bakiye:</strong> <span style="color: #00d4aa; font-weight: 600;">₺${balanceFormatted}</span></p>
                        </div>
                    `;
                    
                    // Bakiye kartı
                    document.getElementById('balanceInfo').innerHTML = `
                        <div style="text-align: center;">
                            <h1 style="font-size: 2.5rem; color: #00d4aa; margin-bottom: 10px;">₺${balanceFormatted}</h1>
                            <p style="color: #8b8fa3; margin-bottom: 15px;">Mevcut Bakiye</p>
                            <div style="display: flex; gap: 10px; justify-content: center;">
                                <button onclick="showSection('deposit')" style="background: #00d4aa; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                    <i class="fas fa-plus"></i> Para Yatır
                                </button>
                                <button onclick="showSection('withdrawal')" style="background: #2d3748; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                    <i class="fas fa-minus"></i> Para Çek
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // İstatistikler
                    document.getElementById('totalTrades').textContent = '12';
                    document.getElementById('profitLoss').textContent = '₺2,450';
                    document.getElementById('memberSince').textContent = '3 ay';
                    
                    // İşlem geçmişi ve mevduatları yükle
                    loadTransactionHistory();
                    if (typeof loadRecentDeposits === 'function') {
                        loadRecentDeposits();
                    }
                    
                    // Diğer dashboard verilerini simüle et
                    setTimeout(() => {
                        document.getElementById('dailyPnl').innerHTML = 
                            `<h2 style="color: #00d4aa;">+₺156.24</h2><small style="color: #8b8fa3;">+2.34%</small>`;
                        
                        document.getElementById('openPositions').innerHTML = 
                            `<h2 style="color: #ffffff;">3</h2><small style="color: #8b8fa3;">Aktif pozisyon</small>`;
                        
                        document.getElementById('recentTrades').innerHTML = 
                            `<p style="color: #8b8fa3;">Henüz işlem yapılmamış</p>`;
                        
                        document.getElementById('marketSummary').innerHTML = 
                            `<p style="color: #8b8fa3;">Piyasa verileri yükleniyor...</p>`;
                    }, 1000);
                    
                } else {
                    console.error('❌ Kullanıcı girişi gerekli:', data.message);
                    showNotification('Oturum süreniz dolmuş. Lütfen tekrar giriş yapın.', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                }
            })
            .catch(err => {
                console.error('❌ API Hatası:', err);
                document.getElementById('totalBalance').innerHTML = '<span style="color: #ef4444;">Bağlantı Hatası</span>';
                document.getElementById('userBalance').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Hata';
                showNotification('Bağlantı hatası. Lütfen sayfayı yenileyin.', 'error');
            });
        }

        // İşlem geçmişi yükle
        async function loadTransactionHistory() {
            const historyContainer = document.getElementById('transactionHistory');
            
            // Loading state göster
            historyContainer.innerHTML = `
                <div class="loading" style="text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <p>İşlem geçmişi yükleniyor...</p>
                </div>
            `;
            
            try {
                const response = await fetch('backend/user/transaction_history.php?action=list&limit=20', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const result = await response.json();
                console.log('✅ Transaction history loaded:', result);
                
                if (result.success && result.data.transactions) {
                    displayTransactionHistory(result.data);
                } else {
                    // Boş durum
                    historyContainer.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: #8b8fa3;">
                            <i class="fas fa-history" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                            <h3 style="color: #ffffff; margin-bottom: 12px;">Henüz İşlem Yok</h3>
                            <p>Henüz hiç işlem yapmamışsınız. İlk işleminizi yapmak için piyasalar sayfasını ziyaret edin.</p>
                        </div>
                    `;
                }
                
                // İstatistikleri güncelle
                if (result.data.stats) {
                    updateProfileStats(result.data.stats);
                }
                
            } catch (error) {
                console.error('Transaction history loading error:', error);
                historyContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 12px;"></i><br>
                        İşlem geçmişi yüklenirken hata oluştu.<br>
                        <button onclick="loadTransactionHistory()" style="background: #4fc3f7; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 12px;">
                            Tekrar Dene
                        </button>
                    </div>
                `;
            }
        }
        
        // İşlem geçmişini göster
        function displayTransactionHistory(data) {
            const historyContainer = document.getElementById('transactionHistory');
            const transactions = data.transactions;
            
            if (!transactions || transactions.length === 0) {
                historyContainer.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #8b8fa3;">
                        <i class="fas fa-history" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                        <h3 style="color: #ffffff; margin-bottom: 12px;">İşlem Geçmişi Boş</h3>
                        <p>Henüz hiç işlem yapmamışsınız.</p>
                    </div>
                `;
                return;
            }
            
            let historyHTML = '';
            transactions.forEach(transaction => {
                const isPositive = parseFloat(transaction.amount) > 0;
                const amount = parseFloat(transaction.amount);
                const formattedAmount = (isPositive ? '+' : '') + '₺' + Math.abs(amount).toLocaleString('tr-TR', { minimumFractionDigits: 2 });
                
                // İşlem tipine göre icon belirle
                let icon = 'fas fa-exchange-alt';
                let iconColor = '#4fc3f7';
                
                if (transaction.type === 'coin_trade') {
                    icon = transaction.sub_type === 'al' ? 'fas fa-arrow-down' : 'fas fa-arrow-up';
                    iconColor = transaction.sub_type === 'al' ? '#00d4aa' : '#ef4444';
                } else if (transaction.type === 'deposit') {
                    icon = 'fas fa-plus-circle';
                    iconColor = '#00d4aa';
                } else if (transaction.type === 'withdrawal') {
                    icon = 'fas fa-minus-circle';
                    iconColor = '#ef4444';
                }
                
                // Status badge
                let statusBadge = '';
                if (transaction.sub_type === 'beklemede') {
                    statusBadge = '<span class="status-badge pending">Beklemede</span>';
                } else if (transaction.sub_type === 'onaylandi' || transaction.sub_type === 'al' || transaction.sub_type === 'sat') {
                    statusBadge = '<span class="status-badge approved">Tamamlandı</span>';
                } else if (transaction.sub_type === 'reddedildi') {
                    statusBadge = '<span class="status-badge rejected">Reddedildi</span>';
                }
                
                historyHTML += `
                    <div class="transaction-item" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div style="width: 40px; height: 40px; background: rgba(${iconColor.substring(1, 3)}, ${iconColor.substring(3, 5)}, ${iconColor.substring(5, 7)}, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="${icon}" style="color: ${iconColor}; font-size: 16px;"></i>
                            </div>
                            <div class="transaction-info">
                                <div class="transaction-type" style="font-weight: 600; color: #ffffff; margin-bottom: 4px;">
                                    ${transaction.description}
                                </div>
                                <div class="transaction-details" style="font-size: 12px; color: #8b8fa3;">
                                    ${new Date(transaction.date).toLocaleDateString('tr-TR', { 
                                        year: 'numeric', 
                                        month: 'short', 
                                        day: 'numeric', 
                                        hour: '2-digit', 
                                        minute: '2-digit' 
                                    })}
                                    ${statusBadge}
                                </div>
                            </div>
                        </div>
                        <div class="transaction-amount" style="font-weight: 600; color: ${isPositive ? '#00d4aa' : '#ef4444'};">
                            ${formattedAmount}
                        </div>
                    </div>
                `;
            });
            
            historyContainer.innerHTML = historyHTML;
        }
        
        // Profil istatistiklerini güncelle
        function updateProfileStats(stats) {
            if (stats.total_trades) {
                document.getElementById('totalTrades').textContent = stats.total_trades;
            }
            
            // Kar/zarar hesapla (gelecekte portföy verisi ile)
            const profitLoss = (stats.total_sell_amount || 0) - (stats.total_buy_amount || 0);
            document.getElementById('profitLoss').textContent = `₺${profitLoss.toLocaleString('tr-TR')}`;
            document.getElementById('profitLoss').style.color = profitLoss >= 0 ? '#00d4aa' : '#ef4444';
        }

        // Çıkış yap
        function logout() {
            fetch('backend/public/logout.php', {
                method: 'GET',
                credentials: 'include'
            })
            .then(() => {
                window.location.href = 'login.html';
            });
        }

        // Para yatırma formu fonksiyonları
        function setupDepositForm() {
            const depositForm = document.getElementById('deposit-form');
            const depositMethod = document.getElementById('deposit-method');
            
            // Yöntem değişikliğinde form alanlarını göster/gizle
            depositMethod.addEventListener('change', function() {
                toggleMethodFields(this.value);
            });
            
            // Form gönderimi
            depositForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitDepositRequest();
            });
            
            // Para çekme formu setup
            setupWithdrawalForm();
        }
        
        // Para çekme formu fonksiyonları
        function setupWithdrawalForm() {
            const withdrawalForm = document.getElementById('withdrawal-form');
            const withdrawalMethod = document.getElementById('withdrawal-method');
            
            if (!withdrawalForm || !withdrawalMethod) return;
            
            // Yöntem değişikliğinde form alanlarını göster/gizle
            withdrawalMethod.addEventListener('change', function() {
                toggleWithdrawalMethodFields(this.value);
            });
            
            // Form gönderimi
            withdrawalForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitWithdrawalRequest();
            });
        }
        
        // Para çekme yöntem alanlarını göster/gizle
        function toggleWithdrawalMethodFields(method) {
            // Tüm method field'larını gizle
            const bankTransferFields = document.getElementById('bank-transfer-fields');
            const paparaWithdrawalFields = document.getElementById('papara-withdrawal-fields');
            
            if (bankTransferFields) bankTransferFields.style.display = 'none';
            if (paparaWithdrawalFields) paparaWithdrawalFields.style.display = 'none';
            
            // Seçilen yönteme göre ilgili alanları göster
            if (method === 'bank_transfer' && bankTransferFields) {
                bankTransferFields.style.display = 'block';
                console.log('🏦 Banka havalesi alanları açıldı');
                // Otomatik ad soyad doldur
                fillRecipientName();
            } else if (method === 'papara' && paparaWithdrawalFields) {
                paparaWithdrawalFields.style.display = 'block';
                console.log('📱 Papara alanları açıldı');
            }
            
            // Kullanıcı bakiyesini güncelle
            updateCurrentBalance();
        }
        
        // Alıcı adı soyadını otomatik doldur
        function fillRecipientName() {
            fetch('backend/public/profile.php', {
                method: 'GET',
                credentials: 'include'
            })
            .then(r => r.json())
            .then(data => {
                if(data.success && data.user) {
                    const recipientNameField = document.getElementById('recipient-name');
                    if (recipientNameField) {
                        // Ad soyad varsa onu kullan, yoksa kullanıcı adını kullan
                        const fullName = data.user.ad_soyad || data.user.username || 'Kullanıcı';
                        recipientNameField.value = fullName;
                    }
                }
            })
            .catch(err => {
                console.error('Kullanıcı bilgisi alınırken hata:', err);
            });
        }
        
        // Mevcut bakiyeyi güncelle
        function updateCurrentBalance() {
            fetch('backend/public/profile.php', {
                method: 'GET',
                credentials: 'include'
            })
            .then(r => r.json())
            .then(data => {
                if(data.success) {
                    const balance = parseFloat(data.user.balance) || 0;
                    window.currentUserBalance = balance;
                    document.getElementById('current-balance-display').textContent = `₺${balance.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
                }
            })
            .catch(err => {
                console.error('Bakiye güncelleme hatası:', err);
            });
        }
        
        // Para çekme talebi gönder
        async function submitWithdrawalRequest() {
            const method = document.getElementById('withdrawal-method').value;
            const amount = parseFloat(document.getElementById('withdrawal-amount').value);
            const note = document.getElementById('withdrawal-note').value;
            
            if (!method) {
                showNotification('Lütfen çekme yöntemini seçin!', 'error');
                return;
            }
            
            if (!amount || amount < 100) {
                showNotification('Minimum çekme tutarı ₺100\'dür!', 'error');
                return;
            }
            
            if (amount > 50000) {
                showNotification('Maksimum çekme tutarı ₺50,000\'dir!', 'error');
                return;
            }
            
            // Mevcut bakiye kontrolü
            const currentBalance = window.currentUserBalance || 0;
            if (amount > currentBalance) {
                showNotification('Yetersiz bakiye!', 'error');
                return;
            }
            
            // Yönteme göre ek alanları kontrol et
            let detailBilgiler = {};
            
            if (method === 'bank_transfer') {
                const recipientName = document.getElementById('recipient-name').value;
                const bankName = document.getElementById('bank-name').value;
                const ibanNumber = document.getElementById('iban-number').value;
                
                if (!recipientName) {
                    showNotification('Lütfen alıcı adı soyadını girin!', 'error');
                    return;
                }
                
                if (!bankName) {
                    showNotification('Lütfen banka adını seçin!', 'error');
                    return;
                }
                
                if (!ibanNumber) {
                    showNotification('Lütfen IBAN numarasını girin!', 'error');
                    return;
                }
                
                // IBAN validasyonu (geliştirilmiş)
                const cleanIban = ibanNumber.replace(/\s/g, '').toUpperCase();
                if (!cleanIban.startsWith('TR')) {
                    showNotification('IBAN numarası TR ile başlamalıdır!', 'error');
                    return;
                }
                if (cleanIban.length !== 26) {
                    showNotification('IBAN numarası tam 26 karakter olmalıdır!', 'error');
                    return;
                }
                // Sadece harf ve rakam kontrolü
                if (!/^[A-Z0-9]+$/.test(cleanIban)) {
                    showNotification('IBAN sadece harf ve rakam içerebilir!', 'error');
                    return;
                }
                
                detailBilgiler = { 
                    recipient_name: recipientName,
                    bank_name: bankName,
                    iban_number: cleanIban
                };
            } else if (method === 'papara') {
                const paparaNumber = document.getElementById('papara-withdrawal-number').value;
                const paparaAccountName = document.getElementById('papara-account-name').value;
                
                if (!paparaNumber) {
                    showNotification('Lütfen Papara numaranızı girin!', 'error');
                    return;
                }
                
                // Papara numarası 10 haneli olmalı ve sadece rakam içermeli
                if (paparaNumber.length !== 10 || !/^\d{10}$/.test(paparaNumber)) {
                    showNotification('Papara numarası tam 10 haneli ve sadece rakam olmalıdır!', 'error');
                    return;
                }
                
                if (!paparaAccountName) {
                    showNotification('Lütfen Papara hesap sahibinin adını girin!', 'error');
                    return;
                }
                
                detailBilgiler = { 
                    papara_number: paparaNumber,
                    account_name: paparaAccountName
                };
            }
            
            try {
                const formData = new FormData();
                formData.append('yontem', method);
                formData.append('tutar', amount);
                formData.append('detay_bilgiler', JSON.stringify(detailBilgiler));
                if (note) formData.append('aciklama', note);
                
                const response = await fetch('backend/user/withdrawals.php?action=create', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Para çekme talebiniz başarıyla gönderildi! Talep ID: ${data.data.id}`, 'success');
                    document.getElementById('withdrawal-form').reset();
                    toggleWithdrawalMethodFields(''); // Hide all method fields
                    loadRecentWithdrawals(); // Reload recent withdrawals
                } else {
                    showNotification('Hata: ' + (data.error || 'Talep gönderilemedi'), 'error');
                }
            } catch (error) {
                console.error('Para çekme hatası:', error);
                showNotification('Talep gönderilirken bir hata oluştu: ' + error.message, 'error');
            }
        }
        
        // Son para çekme taleplerini yükle
        async function loadRecentWithdrawals() {
            const container = document.getElementById('recent-withdrawals');
            
            if (!container) return;
            
            try {
                // Loading state göster
                container.innerHTML = `
                    <div class="loading" style="text-align: center; padding: 40px;">
                        <div class="spinner"></div>
                        <p>Talepler yükleniyor...</p>
                    </div>
                `;
                
                const response = await fetch('backend/user/withdrawals.php?action=list', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    let withdrawalsHTML = '<div style="display: flex; flex-direction: column; gap: 12px;">';
                    
                    data.data.forEach(withdrawal => {
                        const statusClass = withdrawal.durum === 'beklemede' ? 'status-pending' : 
                                          withdrawal.durum === 'onaylandi' ? 'status-approved' : 'status-rejected';
                        const statusText = withdrawal.durum === 'beklemede' ? 'Beklemede' : 
                                         withdrawal.durum === 'onaylandi' ? 'Onaylandı' : 'Reddedildi';
                        
                        // Yöntem adını düzelt
                        let methodName = withdrawal.yontem;
                        const methodNames = {
                            'bank_transfer': 'Banka Havalesi',
                            'papara': 'Papara'
                        };
                        methodName = methodNames[withdrawal.yontem] || methodName;
                        
                        withdrawalsHTML += `
                            <div style="background: rgba(255, 255, 255, 0.05); padding: 16px; border-radius: 12px; border-left: 4px solid ${withdrawal.durum === 'beklemede' ? '#fbbf24' : withdrawal.durum === 'onaylandi' ? '#00d4aa' : '#ef4444'};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div>
                                        <strong style="color: #ffffff;">${methodName}</strong>
                                        <span style="margin-left: 12px; color: #8b8fa3;">₺${parseFloat(withdrawal.tutar).toLocaleString()}</span>
                                    </div>
                                    <span class="status-badge ${statusClass}" style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">${statusText}</span>
                                </div>
                                <div style="color: #8b8fa3; font-size: 12px;">
                                    ${new Date(withdrawal.tarih).toLocaleDateString('tr-TR')} ${new Date(withdrawal.tarih).toLocaleTimeString('tr-TR')}
                                </div>
                            </div>
                        `;
                    });
                    
                    withdrawalsHTML += '</div>';
                    container.innerHTML = withdrawalsHTML;
                } else {
                    // Mock data göster (backend hazır değilse)
                    container.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="background: rgba(255, 255, 255, 0.05); padding: 16px; border-radius: 12px; border-left: 4px solid #fbbf24;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div>
                                        <strong style="color: #ffffff;">Banka Havalesi</strong>
                                        <span style="margin-left: 12px; color: #8b8fa3;">₺5,000</span>
                                    </div>
                                    <span style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; background: rgba(251, 191, 36, 0.2); color: #fbbf24;">Beklemede</span>
                                </div>
                                <div style="color: #8b8fa3; font-size: 12px;">
                                    ${new Date().toLocaleDateString('tr-TR')} ${new Date().toLocaleTimeString('tr-TR')}
                                </div>
                            </div>
                            <div style="background: rgba(255, 255, 255, 0.05); padding: 16px; border-radius: 12px; border-left: 4px solid #00d4aa;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div>
                                        <strong style="color: #ffffff;">Papara</strong>
                                        <span style="margin-left: 12px; color: #8b8fa3;">₺2,500</span>
                                    </div>
                                    <span style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; background: rgba(16, 185, 129, 0.2); color: #00d4aa;">Onaylandı</span>
                                </div>
                                <div style="color: #8b8fa3; font-size: 12px;">
                                    ${new Date(Date.now() - 86400000).toLocaleDateString('tr-TR')} ${new Date(Date.now() - 86400000).toLocaleTimeString('tr-TR')}
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Para çekme talepleri yüklenirken hata:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 12px;"></i>
                        <p>Talepler yüklenirken bir hata oluştu.</p>
                        <button onclick="loadRecentWithdrawals()" style="background: #4fc3f7; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 12px;">
                            Tekrar Dene
                        </button>
                    </div>
                `;
            }
        }
        
        // Yöntem alanlarını göster/gizle
        function toggleMethodFields(method) {
            const methodFields = document.querySelectorAll('.method-fields');
            methodFields.forEach(field => {
                field.style.display = 'none';
            });
            
            if (method) {
                const selectedMethodFields = document.getElementById(method + '-fields');
                if (selectedMethodFields) {
                    selectedMethodFields.style.display = 'block';
                }
            }
        }
        
        // Para yatırma talebi gönder
        async function submitDepositRequest() {
            const method = document.getElementById('deposit-method').value;
            const amount = parseFloat(document.getElementById('deposit-amount').value);
            const note = document.getElementById('deposit-note').value;
            
            if (!method) {
                showNotification('Lütfen yatırma yöntemini seçin!', 'error');
                return;
            }
            
            if (!amount || amount < 10) {
                showNotification('Minimum yatırım tutarı ₺10\'dur!', 'error');
                return;
            }
            
            if (amount > 50000) {
                showNotification('Maksimum yatırım tutarı ₺50,000\'dir!', 'error');
                return;
            }
            
            // Yönteme göre ek alanları kontrol et
            let detailBilgiler = {};
            
            if (method === 'papara') {
                const paparaNumber = document.getElementById('papara-number').value;
                if (!paparaNumber) {
                    showNotification('Lütfen Papara numaranızı girin!', 'error');
                    return;
                }
                detailBilgiler = { papara_number: paparaNumber };
            } else if (['ziraat', 'garanti', 'isbank', 'akbank', 'yapikredi'].includes(method)) {
                // Banka havalesi için sadece seçilen banka bilgisi
                detailBilgiler = { selected_bank: method };
            }
            
            try {
                const formData = new FormData();
                formData.append('yontem', method);
                formData.append('tutar', amount);
                formData.append('detay_bilgiler', JSON.stringify(detailBilgiler));
                if (note) formData.append('aciklama', note);
                
                const response = await fetch('backend/user/deposits.php?action=create', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Para yatırma talebiniz başarıyla gönderildi! Talep ID: ${data.data.id}`, 'success');
                    document.getElementById('deposit-form').reset();
                    toggleMethodFields(''); // Hide all method fields
                    loadRecentDeposits(); // Reload recent deposits
                } else {
                    showNotification('Hata: ' + (data.error || 'Talep gönderilemedi'), 'error');
                }
            } catch (error) {
                console.error('Para yatırma hatası:', error);
                showNotification('Talep gönderilirken bir hata oluştu: ' + error.message, 'error');
            }
        }
        
        // Son para yatırma taleplerini yükle
        async function loadRecentDeposits() {
            const container = document.getElementById('recent-deposits');
            
            try {
                const response = await fetch('backend/user/deposits.php?action=list', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success && data.data.length > 0) {
                    let depositsHTML = '<div style="display: flex; flex-direction: column; gap: 12px;">';
                    
                    data.data.forEach(deposit => {
                        const statusClass = deposit.durum === 'beklemede' ? 'status-pending' : 
                                          deposit.durum === 'onaylandi' ? 'status-approved' : 'status-rejected';
                        const statusText = deposit.durum === 'beklemede' ? 'Beklemede' : 
                                         deposit.durum === 'onaylandi' ? 'Onaylandı' : 'Reddedildi';
                        
                        // Yöntem adını düzelt
                        let methodName = deposit.yontem;
                        const methodNames = {
                            'papara': 'Papara',
                            'ziraat': 'Ziraat Bankası',
                            'garanti': 'Garanti BBVA',
                            'isbank': 'İş Bankası',
                            'akbank': 'Akbank',
                            'yapikredi': 'Yapı Kredi'
                        };
                        methodName = methodNames[deposit.yontem] || methodName;
                        
                        depositsHTML += `
                            <div style="background: rgba(255, 255, 255, 0.05); padding: 16px; border-radius: 12px; border-left: 4px solid ${deposit.durum === 'beklemede' ? '#fbbf24' : deposit.durum === 'onaylandi' ? '#00d4aa' : '#ef4444'};">
                                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
                                    <div>
                                        <strong style="color: #ffffff;">${methodName}</strong>
                                        <span style="margin-left: 12px; color: #8b8fa3;">₺${parseFloat(deposit.tutar).toLocaleString()}</span>
                                    </div>
                                    <span class="status-badge ${statusClass}" style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">${statusText}</span>
                                </div>
                                <div style="color: #8b8fa3; font-size: 12px;">
                                    ${new Date(deposit.tarih).toLocaleDateString('tr-TR')} ${new Date(deposit.tarih).toLocaleTimeString('tr-TR')}
                                </div>
                            </div>
                        `;
                    });
                    
                    depositsHTML += '</div>';
                    container.innerHTML = depositsHTML;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #8b8fa3;">
                            <i class="fas fa-info-circle" style="font-size: 24px; margin-bottom: 12px;"></i>
                            <p>Henüz para yatırma talebiniz bulunmuyor.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Para yatırma talepleri yüklenirken hata:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 12px;"></i>
                        <p>Talepler yüklenirken bir hata oluştu.</p>
                    </div>
                `;
            }
        }
        
        // Balance menüsü aç/kapat
        function openBalanceMenu() {
            // Mevcut menüyü kapat
            closeBalanceMenu();
            
            // Menü HTML'i oluştur
            const menuHTML = `
                <div id="balanceMenu" class="balance-menu">
                    <div class="balance-menu-overlay" onclick="closeBalanceMenu()"></div>
                    <div class="balance-menu-content">
                        <div class="balance-menu-header">
                            <h3><i class="fas fa-wallet"></i> Cüzdan İşlemleri</h3>
                            <button class="balance-menu-close" onclick="closeBalanceMenu()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="balance-menu-body">
                            <div class="balance-menu-item" onclick="navigateToDeposit()">
                                <div class="balance-menu-icon deposit">
                                    <i class="fas fa-plus-circle"></i>
                                </div>
                                <div class="balance-menu-text">
                                    <h4>Para Yatır</h4>
                                    <p>Hesabınıza para yatırın</p>
                                </div>
                                <div class="balance-menu-arrow">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </div>
                            <div class="balance-menu-item" onclick="showWithdrawalComingSoon()">
                                <div class="balance-menu-icon withdrawal">
                                    <i class="fas fa-minus-circle"></i>
                                </div>
                                <div class="balance-menu-text">
                                    <h4>Para Çek</h4>
                                    <p>Yakında gelecek</p>
                                </div>
                                <div class="balance-menu-arrow">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Menüyü sayfaya ekle
            document.body.insertAdjacentHTML('beforeend', menuHTML);
            
            // Animasyon ile göster
            setTimeout(() => {
                const menu = document.getElementById('balanceMenu');
                if (menu) {
                    menu.style.opacity = '1';
                    const content = menu.querySelector('.balance-menu-content');
                    if (content) {
                        content.style.transform = 'translateY(0)';
                    }
                }
            }, 10);
        }
        
        // Balance menüsünü kapat
        function closeBalanceMenu() {
            const existingMenu = document.getElementById('balanceMenu');
            if (existingMenu) {
                const content = existingMenu.querySelector('.balance-menu-content');
                if (content) {
                    content.style.transform = 'translateY(-20px)';
                }
                existingMenu.style.opacity = '0';
                setTimeout(() => {
                    existingMenu.remove();
                }, 300);
            }
        }
        
        // Para yatırma sayfasına yönlendir
        function navigateToDeposit() {
            closeBalanceMenu();
            
            // Sol menüdeki "Para Yatır" linkini aktif et
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.dataset.section === 'deposit') {
                    link.classList.add('active');
                }
            });
            
            // Deposit bölümünü göster
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('deposit').classList.add('active');
            
            // Sayfa başlığını güncelle
            document.getElementById('pageTitle').textContent = 'Para Yatır';
            
            // Para yatırma taleplerini yükle
            if (typeof loadRecentDeposits === 'function') {
                loadRecentDeposits();
            }
        }
        
        // Para çekme sayfasına yönlendir
        function showWithdrawalComingSoon() {
            closeBalanceMenu();
            navigateToWithdrawal();
        }
        
        // Para çekme sayfasına yönlendir
        function navigateToWithdrawal() {
            // Sol menüdeki "Para Çek" linkini aktif et
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.dataset.section === 'withdrawal') {
                    link.classList.add('active');
                }
            });
            
            // Withdrawal bölümünü göster
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('withdrawal').classList.add('active');
            
            // Sayfa başlığını güncelle
            document.getElementById('pageTitle').textContent = 'Para Çek';
            
            // Para çekme taleplerini yükle
            if (typeof loadRecentWithdrawals === 'function') {
                loadRecentWithdrawals();
            }
            
            // Mevcut bakiyeyi güncelle
            if (typeof updateCurrentBalance === 'function') {
                updateCurrentBalance();
            }
        }

        // Notification göster
        function showNotification(message, type = 'info') {
            // Notification container oluştur
            let container = document.getElementById('notification-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notification-container';
                container.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    max-width: 400px;
                `;
                document.body.appendChild(container);
            }
            
            // Notification elemanı oluştur
            const notification = document.createElement('div');
            notification.style.cssText = `
                background: ${type === 'success' ? '#00d4aa' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 16px 20px;
                border-radius: 12px;
                margin-bottom: 12px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.2);
                transform: translateX(100%);
                transition: transform 0.3s ease;
                font-weight: 500;
                display: flex;
                align-items: center;
                gap: 12px;
            `;
            
            const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
            notification.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
            
            container.appendChild(notification);
            
            // Animasyon
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Otomatik kaldır
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }

        // Mobile menu toggle
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
        }

        // Close mobile menu
        function closeMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
        }

        // Close mobile menu when clicking navigation items
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', closeMobileMenu);
        });

        // Window resize event for responsive design
        window.addEventListener('resize', function() {
            // Re-render coins if needed
            if (window.innerWidth <= 768) {
                const mobileGrid = document.getElementById('mobileCoinsGrid');
                if (mobileGrid && mobileGrid.children.length > 0) {
                    // Mobile grid is already rendered, no need to re-render
                }
            } else {
                const mobileGrid = document.getElementById('mobileCoinsGrid');
                if (mobileGrid) {
                    mobileGrid.style.display = 'none';
                    document.getElementById('marketTable').style.display = 'block';
                }
            }
        });

         // Modern sistem - coins.php ile çalışır
         async function fetchMarketData() {
             const searchInput = document.getElementById('coinSearch') ? document.getElementById('coinSearch').value.toLowerCase() : '';
             const marketLoader = document.getElementById('marketLoader');

             try {
                 // Loading state göster
                 if (marketLoader) {
                     marketLoader.style.display = 'flex';
                     marketLoader.innerHTML = `
                         <div style="text-align: center; padding: 40px;">
                             <div style="width: 48px; height: 48px; border: 3px solid rgba(79, 195, 247, 0.3); border-top: 3px solid #4fc3f7; border-radius: 50%; margin: 0 auto 16px; animation: spin 1s linear infinite;"></div>
                             <p style="color: #8896ab;">Piyasa verileri yükleniyor...</p>
                         </div>
                     `;
                 }
                 
                 // coins.php endpoint'den veri çek - coins_hybrid.php kaldırıldı, sadece coins.php kullanılıyor
                 let url = 'backend/user/coins.php';
                 
                 if (searchInput) {
                     url += `?search=${encodeURIComponent(searchInput)}`;
                 }
                 
                 const response = await fetch(url, {
                     method: 'GET',
                     credentials: 'include'
                 });
                 
                 if (!response.ok) {
                     throw new Error(`API Error: ${response.status} ${response.statusText}`);
                 }
                 
                 const result = await response.json();
                 console.log('✅ Market data loaded:', result);

                 if (result.success && result.data && Array.isArray(result.data) && result.data.length > 0) {
                     // Modern card-based rendering kullan
                     renderModernCoins(result.data);
                     
                     // Loader'ı gizle
                     if (marketLoader) {
                         marketLoader.style.display = 'none';
                     }
                     
                     console.log(`📊 ${result.data.length} coin yüklendi`);
                     
                 } else if (result.success && result.coins && Array.isArray(result.coins) && result.coins.length > 0) {
                     // Alternatif data yapısı - coins array
                     renderModernCoins(result.coins);
                     
                     if (marketLoader) {
                         marketLoader.style.display = 'none';
                     }
                     
                     console.log(`📊 ${result.coins.length} coin yüklendi (coins array)`);
                     
                 } else {
                     console.warn('❌ Coin verisi bulunamadı:', result);
                     showNoCoinsMessage(searchInput);
                     if (marketLoader) {
                         marketLoader.style.display = 'none';
                     }
                 }
                 
             } catch (error) {
                 console.error('❌ Error fetching market data:', error);
                 showErrorMessage();
             }
         }
         
                 // refreshMarketData alias - geriye uyumluluk için
        function refreshMarketData() {
            return fetchMarketData();
        }
        
        // Portföy yükle - Geliştirilmiş hata yakalama
        async function loadPortfolio() {
            const loader = document.getElementById('portfolioLoader');
            const empty = document.getElementById('portfolioEmpty');
            const table = document.getElementById('portfolioTable');
            
            // Loading state göster
            if (loader) loader.style.display = 'block';
            if (empty) empty.style.display = 'none';
            if (table) table.style.display = 'none';
            
            try {
                console.log('🔄 Starting portfolio load...');
                
                const response = await fetch('backend/user/trading.php?action=portfolio', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                console.log('📡 Portfolio response status:', response.status);
                console.log('📡 Portfolio response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Response'u önce text olarak al, sonra JSON parse et
                const responseText = await response.text();
                console.log('📄 Raw portfolio response length:', responseText.length);
                console.log('📄 Raw portfolio response preview:', responseText.substring(0, 500));
                
                // HTML içeriği kontrolü
                if (responseText.trim().startsWith('<')) {
                    console.error('❌ Server returned HTML instead of JSON');
                    console.error('📄 HTML Content:', responseText.substring(0, 1000));
                    throw new Error('Server returned HTML instead of JSON. This usually indicates a PHP error or redirect.');
                }
                
                // Boş response kontrolü
                if (!responseText.trim()) {
                    console.error('❌ Empty response from server');
                    throw new Error('Server returned empty response');
                }
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('❌ JSON Parse Error:', parseError);
                    console.error('📄 Response that failed to parse:', responseText);
                    
                    // JSON parse hatasının detayını analiz et
                    let errorDetail = parseError.message;
                    if (responseText.includes('Unexpected token \'<\'')) {
                        errorDetail = 'Server returned HTML instead of JSON (likely a PHP error)';
                    } else if (responseText.includes('PHP Fatal error')) {
                        errorDetail = 'PHP Fatal Error occurred on server';
                    } else if (responseText.includes('PHP Warning')) {
                        errorDetail = 'PHP Warning occurred on server';
                    }
                    
                    throw new Error(`JSON Parse Error: ${errorDetail}`);
                }
                
                console.log('✅ Portfolio JSON parsed successfully:', result);
                
                if (result.success) {
                    if (result.data && result.data.portfolio && Array.isArray(result.data.portfolio) && result.data.portfolio.length > 0) {
                        console.log('📊 Displaying portfolio with', result.data.portfolio.length, 'items');
                        displayPortfolio(result.data);
                    } else {
                        console.log('📭 Portfolio is empty, showing empty state');
                        // Portföy boş
                        if (loader) loader.style.display = 'none';
                        if (empty) empty.style.display = 'block';
                        
                        // Sıfır değerleri göster
                        const totalValue = document.getElementById('portfolioTotalValue');
                        const profitLoss = document.getElementById('portfolioProfitLoss');
                        const profitPercent = document.getElementById('profitLossPercent');
                        const coinCount = document.getElementById('portfolioCoinCount');
                        
                        if (totalValue) totalValue.textContent = '₺0';
                        if (profitLoss) profitLoss.textContent = '₺0';
                        if (profitPercent) profitPercent.textContent = '0%';
                        if (coinCount) coinCount.textContent = '0';
                    }
                } else {
                    throw new Error(result.message || result.error || 'Portfolio API returned success: false');
                }
                
            } catch (error) {
                console.error('❌ Portfolio loading error:', error);
                
                // Loading'i gizle
                if (loader) loader.style.display = 'none';
                if (empty) empty.style.display = 'none';
                if (table) table.style.display = 'block';
                
                // Hata türüne göre farklı mesajlar ve çözümler
                let errorMessage = 'Portföy verilerini yüklerken hata oluştu.';
                let errorDetails = '';
                let technicalDetails = error.message;
                
                if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                    errorMessage = 'Oturum süreniz dolmuş. Lütfen tekrar giriş yapın.';
                    errorDetails = '<button onclick="window.location.href=\'login.html\'" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 12px;">Giriş Yap</button>';
                } else if (error.message.includes('500') || error.message.includes('Internal Server Error')) {
                    errorMessage = 'Sunucu hatası oluştu. Lütfen daha sonra tekrar deneyin.';
                    errorDetails = '<button onclick="loadPortfolio()" style="background: #4fc3f7; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 12px;">Tekrar Dene</button>';
                } else if (error.message.includes('missing_table')) {
                    errorMessage = 'Veritabanı tabloları eksik. Sistem yöneticisi ile iletişime geçin.';
                    errorDetails = '<button onclick="setupDatabase()" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 12px;">Veritabanını Kur</button>';
                } else if (error.message.includes('HTML instead of JSON')) {
                    errorMessage = 'Sunucuda PHP hatası oluştu. Lütfen sistem yöneticisi ile iletişime geçin.';
                    errorDetails = '<button onclick="loadPortfolio()" style="background: #4fc3f7; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 12px;">Tekrar Dene</button>';
                } else if (error.message.includes('JSON Parse Error')) {
                    errorMessage = 'Sunucu yanıtı işlenirken hata oluştu.';
                    errorDetails = '<button onclick="loadPortfolio()" style="background: #4fc3f7; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 12px;">Tekrar Dene</button>';
                } else if (error.message.includes('Empty response')) {
                    errorMessage = 'Sunucudan boş yanıt alındı.';
                    errorDetails = '<button onclick="loadPortfolio()" style="background: #4fc3f7; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 12px;">Tekrar Dene</button>';
                } else {
                    errorDetails = '<button onclick="loadPortfolio()" style="background: #4fc3f7; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 12px;">Tekrar Dene</button>';
                }
                
                // Hata mesajını göster
                const portfolioTableBody = document.getElementById('portfolioTableBody');
                if (portfolioTableBody) {
                    portfolioTableBody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: #ef4444;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 12px;"></i><br>
                                <strong>${errorMessage}</strong><br>
                                <small style="color: #8896ab; margin-top: 8px; display: block;">Teknik detay: ${technicalDetails}</small>
                                ${errorDetails}
                            </td>
                        </tr>
                    `;
                }
                
                // Notification da göster
                showNotification(errorMessage, 'error');
            }
        }
        
        // Global portfolio view state
        let currentPortfolioView = 'cards';
        
        // Portföy görünüm değiştirme
        function togglePortfolioView(view) {
            currentPortfolioView = view;
            const cardsContainer = document.getElementById('portfolioCards');
            const tableContainer = document.getElementById('portfolioTable');
            const cardViewBtn = document.getElementById('cardViewBtn');
            const tableViewBtn = document.getElementById('tableViewBtn');
            
            if (view === 'cards') {
                cardsContainer.style.display = 'grid';
                tableContainer.style.display = 'none';
                cardViewBtn.classList.add('active');
                tableViewBtn.classList.remove('active');
            } else {
                cardsContainer.style.display = 'none';
                tableContainer.style.display = 'block';
                cardViewBtn.classList.remove('active');
                tableViewBtn.classList.add('active');
            }
        }
        
        // Portföy verilerini göster
        function displayPortfolio(data) {
            const loader = document.getElementById('portfolioLoader');
            const cardsContainer = document.getElementById('portfolioCards');
            const tableContainer = document.getElementById('portfolioTable');
            const tbody = document.getElementById('portfolioTableBody');
            
            // Loading'i gizle
            loader.style.display = 'none';
            
            // Özet bilgilerini güncelle
            const summary = data.summary;
            updatePortfolioSummary(summary, data.portfolio);
            
            // Kart görünümü oluştur
            displayPortfolioCards(data.portfolio, cardsContainer);
            
            // Tablo görünümü oluştur
            displayPortfolioTable(data.portfolio, tbody);
            
            // Aktif görünümü göster
            togglePortfolioView(currentPortfolioView);
            
            // Başarı mesajı göster
            if (typeof showNotification === 'function') {
                showNotification(`Portföy yüklendi: ${summary.coin_count} farklı varlık`, 'success');
            }
        }
        
        // Portföy özet kartlarını güncelle
        function updatePortfolioSummary(summary, portfolio = []) {
            // Güvenli element güncellemeleri
            const totalValueEl = document.getElementById('portfolioTotalValue');
            const profitLossEl = document.getElementById('portfolioProfitLoss');
            const profitPercentElement = document.getElementById('profitLossPercent');
            const totalValueTrend = document.getElementById('totalValueTrend');
            const profitLossTrend = document.getElementById('profitLossTrend');
            const coinCountEl = document.getElementById('portfolioCoinCount');
            
            // Güvenli değer kontrolü ile güncelleme
            if (totalValueEl && summary && typeof summary.total_value !== 'undefined') {
                totalValueEl.textContent = `₺${summary.total_value.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            }
            
            if (profitLossEl && summary && typeof summary.total_profit_loss !== 'undefined') {
                profitLossEl.textContent = `₺${summary.total_profit_loss.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
                
                // Kar/Zarar rengini ayarla
                const isProfit = summary.total_profit_loss >= 0;
                const color = isProfit ? '#10b981' : '#ef4444';
                const icon = isProfit ? 'fa-arrow-up' : 'fa-arrow-down';
                
                profitLossEl.style.color = color;
                
                if (profitPercentElement && typeof summary.total_profit_loss_percent !== 'undefined') {
                    profitPercentElement.textContent = `${isProfit ? '+' : ''}${summary.total_profit_loss_percent.toFixed(2)}%`;
                    profitPercentElement.style.color = color;
                }
                
                // Trend ikonlarını güncelle
                if (totalValueTrend) {
                    totalValueTrend.className = `fas ${icon}`;
                    totalValueTrend.style.color = color;
                }
                if (profitLossTrend) {
                    profitLossTrend.className = `fas ${icon}`;
                    profitLossTrend.style.color = color;
                }
            }
            
            // Coin count
            if (coinCountEl && summary && typeof summary.coin_count !== 'undefined') {
                coinCountEl.textContent = summary.coin_count;
            }
            
            // En iyi performans - Güvenli array kontrolü
            if (portfolio && Array.isArray(portfolio) && portfolio.length > 0) {
                const bestPerformer = portfolio.reduce((best, current) => 
                    current.profit_loss_percent > best.profit_loss_percent ? current : best
                );
                
                const bestPerformerValue = document.getElementById('bestPerformerValue');
                const bestPerformerChange = document.getElementById('bestPerformerChange');
                
                if (bestPerformerValue && bestPerformerChange) {
                    bestPerformerValue.textContent = bestPerformer.coin_kodu;
                    bestPerformerChange.textContent = `+${bestPerformer.profit_loss_percent.toFixed(2)}%`;
                    bestPerformerChange.style.color = bestPerformer.profit_loss_percent >= 0 ? '#10b981' : '#ef4444';
                }
            }
        }
        
        // Portföy kartlarını göster (Enhanced with real-time features)
        function displayPortfolioCardsWithRealTime(portfolio, container) {
            container.innerHTML = '';
            
            portfolio.forEach(item => {
                const profitLossColor = item.profit_loss >= 0 ? '#10b981' : '#ef4444';
                const trendClass = item.profit_loss >= 0 ? 'positive' : 'negative';
                const trendIcon = item.profit_loss >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                const logoUrl = item.logo_url || coinLogos[item.coin_kodu] || `https://via.placeholder.com/40/4fc3f7/ffffff?text=${item.coin_kodu.charAt(0)}`;
                
                const card = document.createElement('div');
                card.className = 'portfolio-asset-card';
                card.setAttribute('data-coin-id', item.coin_id);
                card.innerHTML = `
                    <div class="asset-card-header">
                        <div class="asset-info">
                            <img src="${logoUrl}" alt="${item.coin_adi}" class="asset-logo"
                                 onerror="this.src='https://via.placeholder.com/40/4fc3f7/ffffff?text=${item.coin_kodu.charAt(0)}'">
                            <div class="asset-details">
                                <h4 onclick="navigateToMarkets('${item.coin_kodu}')" style="cursor: pointer; color: #4fc3f7;" title="Piyasalarda ${item.coin_kodu} görüntüle">${item.coin_adi}</h4>
                                <p>${item.coin_kodu}</p>
                            </div>
                        </div>
                        <div class="asset-trend ${trendClass}">
                            <i class="fas ${trendIcon}"></i>
                            ${item.profit_loss_percent >= 0 ? '+' : ''}${parseFloat(item.profit_loss_percent).toFixed(2)}%
                        </div>
                    </div>
                    
                    <div class="asset-metrics">
                        <div class="metric">
                            <div class="metric-label">Miktar</div>
                            <div class="metric-value">${parseFloat(item.net_miktar).toFixed(6)}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Değer</div>
                            <div class="metric-value">₺${parseFloat(item.current_value).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Ort. Fiyat</div>
                            <div class="metric-value">₺${parseFloat(item.avg_buy_price).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">K/Z</div>
                            <div class="metric-value" style="color: ${profitLossColor};">
                                ${item.profit_loss >= 0 ? '+' : ''}₺${parseFloat(item.profit_loss).toLocaleString('tr-TR', {minimumFractionDigits: 2})}
                            </div>
                        </div>
                    </div>
                    
                    <div class="asset-actions">
                        <button class="asset-action-btn sell ${item.profit_loss >= 0 ? 'profit-sell' : 'loss-sell'}" onclick="portfolioSellAsset('${item.coin_id}', '${item.coin_adi}', '${item.coin_kodu}', ${item.net_miktar})"
                                title="${item.coin_kodu} sat (Mevcut: ${parseFloat(item.net_miktar).toFixed(6)}) - ${item.profit_loss >= 0 ? 'Kar' : 'Zarar'}: ${item.profit_loss >= 0 ? '+' : ''}₺${parseFloat(item.profit_loss).toLocaleString('tr-TR', {minimumFractionDigits: 2})}">
                            <i class="fas fa-minus"></i> Sat
                        </button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }
        
        // Portföy kartlarını göster (alias for compatibility)
        function displayPortfolioCards(portfolio, container) {
            return displayPortfolioCardsWithRealTime(portfolio, container);
        }
        
        // Portföy tablosunu göster
        function displayPortfolioTable(portfolio, tbody) {
            tbody.innerHTML = '';
            
            portfolio.forEach(item => {
                const profitLossColor = item.profit_loss >= 0 ? '#10b981' : '#ef4444';
                const logoUrl = item.logo_url || `https://via.placeholder.com/32/4fc3f7/ffffff?text=${item.coin_kodu.charAt(0)}`;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <img src="${logoUrl}" alt="${item.coin_adi}" 
                                 style="width: 32px; height: 32px; border-radius: 50%;"
                                 onerror="this.src='https://via.placeholder.com/32/4fc3f7/ffffff?text=${item.coin_kodu.charAt(0)}'">
                            <div>
                                <div style="font-weight: 600; color: #ffffff;">${item.coin_adi}</div>
                                <div style="font-size: 12px; color: #8b8fa3;">${item.coin_kodu}</div>
                            </div>
                        </div>
                    </td>
                    <td style="font-family: monospace;">${parseFloat(item.net_miktar).toFixed(6)}</td>
                    <td>₺${parseFloat(item.avg_buy_price).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                    <td>₺${parseFloat(item.current_price).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                    <td style="font-weight: 600;">₺${parseFloat(item.current_value).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                    <td style="color: ${profitLossColor}; font-weight: 600;">
                        ${item.profit_loss >= 0 ? '+' : ''}₺${parseFloat(item.profit_loss).toLocaleString('tr-TR', {minimumFractionDigits: 2})}
                    </td>
                    <td style="color: ${profitLossColor}; font-weight: 600;">
                        ${item.profit_loss_percent >= 0 ? '+' : ''}${parseFloat(item.profit_loss_percent).toFixed(2)}%
                    </td>
                    <td>
                        <div style="display: flex; gap: 8px; justify-content: center;">
                            <button onclick="portfolioSellAsset('${item.coin_id}', '${item.coin_adi}', '${item.coin_kodu}', ${item.net_miktar})" 
                                    style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                <i class="fas fa-minus"></i> Sat
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
         
         // API durum bilgisini göster
         function showApiStatusInfo(totalCount, apiActiveCount) {
             // Başlığın altına bilgi kutusu ekle
             const statusInfo = document.createElement('div');
             statusInfo.className = 'api-status-info';
             statusInfo.style.cssText = `
                 background: linear-gradient(135deg, rgba(79, 195, 247, 0.1) 0%, rgba(41, 182, 246, 0.05) 100%);
                 border: 1px solid rgba(79, 195, 247, 0.2);
                 border-radius: 12px;
                 padding: 16px 24px;
                 margin: 16px 32px;
                 display: flex;
                 align-items: center;
                 gap: 12px;
                 font-size: 13px;
                 color: #8896ab;
             `;
             statusInfo.innerHTML = `
                 <i class="fas fa-info-circle" style="color: #4fc3f7;"></i>
                 <span>📊 ${totalCount} coin yüklendi • 🟢 ${apiActiveCount} canlı fiyat • 🔴 ${totalCount - apiActiveCount} sabit fiyat</span>
             `;
             
             // Eski status info'yu kaldır
             const existingStatus = document.querySelector('.api-status-info');
             if (existingStatus) existingStatus.remove();
             
             // Yeni status info'yu ekle
             const marketContainer = document.querySelector('.modern-market-container');
             const marketFilters = document.querySelector('.market-filters');
             marketContainer.insertBefore(statusInfo, marketFilters.nextSibling);
         }
         
         // Realistic Mini Chart çizme fonksiyonu
         function drawRealisticMiniChart(coinId, currentPrice) {
             const canvas = document.getElementById('miniPriceChart');
             if (!canvas) return;
             
             // Responsive canvas boyutları
             const isMobile = window.innerWidth <= 768;
             const canvasWidth = isMobile ? 120 : 140;
             const canvasHeight = isMobile ? 65 : 70;
             
             canvas.width = canvasWidth;
             canvas.height = canvasHeight;
             
             const ctx = canvas.getContext('2d');
             const width = canvas.width;
             const height = canvas.height;
             const padding = 4; // Chart padding
             const chartWidth = width - padding * 2;
             const chartHeight = height - padding * 2;
             
             // Canvas'ı temizle
             ctx.clearRect(0, 0, width, height);
             
             // Daha gerçekçi fiyat verisi oluştur (25 nokta)
             const dataPoints = 25;
             const priceData = [];
             let basePrice = parseFloat(currentPrice) || 45000;
             
             // Crypto volatility ve momentum simulation
             let momentum = 0;
             let currentPricePoint = basePrice;
             
             for (let i = 0; i < dataPoints; i++) {
                 // Realistic crypto volatility (%1.5)
                 const volatility = (Math.random() - 0.5) * 0.015;
                 
                 // Market trend (subtle sine wave)
                 const marketTrend = Math.sin((i / dataPoints) * Math.PI * 1.5) * 0.008;
                 
                 // Momentum factor (simulates buying/selling pressure)
                 momentum = momentum * 0.7 + (Math.random() - 0.5) * 0.005;
                 
                 // Random walk with mean reversion
                 const meanReversion = (basePrice - currentPricePoint) / basePrice * 0.1;
                 
                 // Combine all factors
                 const priceChange = volatility + marketTrend + momentum + meanReversion;
                 currentPricePoint *= (1 + priceChange);
                 
                 // Ensure price doesn't go negative or too extreme
                 currentPricePoint = Math.max(currentPricePoint, basePrice * 0.85);
                 currentPricePoint = Math.min(currentPricePoint, basePrice * 1.15);
                 
                 priceData.push(currentPricePoint);
             }
             
             // Calculate trend and price range
             const minPrice = Math.min(...priceData);
             const maxPrice = Math.max(...priceData);
             const priceRange = maxPrice - minPrice || 1; // Prevent division by zero
             const isUpTrend = priceData[priceData.length - 1] > priceData[0];
             const trendStrength = Math.abs(priceData[priceData.length - 1] - priceData[0]) / priceData[0];
             
             // Professional color scheme
             const trendColor = isUpTrend ? '#00E676' : '#FF5252'; // Material Design colors
             const trendColorRGB = isUpTrend ? '0, 230, 118' : '255, 82, 82';
             
             // Create sophisticated gradient
             const fillGradient = ctx.createLinearGradient(0, padding, 0, height - padding);
             fillGradient.addColorStop(0, `rgba(${trendColorRGB}, ${0.35 + trendStrength * 0.2})`);
             fillGradient.addColorStop(0.6, `rgba(${trendColorRGB}, ${0.15 + trendStrength * 0.1})`);
             fillGradient.addColorStop(1, `rgba(${trendColorRGB}, 0.02)`);
             
             // Draw subtle grid lines
             ctx.strokeStyle = `rgba(79, 195, 247, 0.08)`;
             ctx.lineWidth = 0.5;
             
             // Horizontal grid lines
             for (let i = 1; i <= 2; i++) {
                 const y = padding + (chartHeight / 3) * i;
                 ctx.beginPath();
                 ctx.moveTo(padding, y);
                 ctx.lineTo(width - padding, y);
                 ctx.stroke();
             }
             
             // Draw main price line
             ctx.strokeStyle = trendColor;
             ctx.lineWidth = 2.2;
             ctx.lineCap = 'round';
             ctx.lineJoin = 'round';
             ctx.shadowColor = trendColor;
             ctx.shadowBlur = 3;
             ctx.shadowOffsetY = 0;
             
             ctx.beginPath();
             priceData.forEach((price, index) => {
                 const x = padding + (chartWidth / (dataPoints - 1)) * index;
                 const y = padding + chartHeight - ((price - minPrice) / priceRange) * chartHeight;
                 
                 if (index === 0) {
                     ctx.moveTo(x, y);
                 } else {
                     ctx.lineTo(x, y);
                 }
             });
             ctx.stroke();
             ctx.shadowBlur = 0; // Reset shadow
             
             // Fill area under curve
             ctx.fillStyle = fillGradient;
             ctx.beginPath();
             priceData.forEach((price, index) => {
                 const x = padding + (chartWidth / (dataPoints - 1)) * index;
                 const y = padding + chartHeight - ((price - minPrice) / priceRange) * chartHeight;
                 
                 if (index === 0) {
                     ctx.moveTo(x, y);
                 } else {
                     ctx.lineTo(x, y);
                 }
             });
             ctx.lineTo(width - padding, height - padding);
             ctx.lineTo(padding, height - padding);
             ctx.closePath();
             ctx.fill();
             
             // Draw last price point highlight
             const lastIndex = priceData.length - 1;
             const lastX = padding + (chartWidth / (dataPoints - 1)) * lastIndex;
             const lastY = padding + chartHeight - ((priceData[lastIndex] - minPrice) / priceRange) * chartHeight;
             
             // Outer glow
             ctx.beginPath();
             ctx.arc(lastX, lastY, 4, 0, 2 * Math.PI);
             ctx.fillStyle = `rgba(${trendColorRGB}, 0.3)`;
             ctx.fill();
             
             // Inner point
             ctx.beginPath();
             ctx.arc(lastX, lastY, 2, 0, 2 * Math.PI);
             ctx.fillStyle = trendColor;
             ctx.fill();
             ctx.strokeStyle = '#ffffff';
             ctx.lineWidth = 1;
             ctx.stroke();
             
             // Update trend indicators
             updateTrendIndicators(isUpTrend, trendStrength);
         }
         
         // Trend indicator güncelleme fonksiyonu
         function updateTrendIndicators(isUpTrend, trendStrength) {
             const trendIcon = document.querySelector('.trend-icon');
             const chartIndicator = document.querySelector('.chart-trend-indicator');
             
             if (trendIcon) {
                 trendIcon.className = `fas fa-trending-${isUpTrend ? 'up' : 'down'} trend-icon${isUpTrend ? '' : ' down'}`;
             }
             
             if (chartIndicator) {
                 const intensity = Math.min(trendStrength * 3, 0.4); // Max 0.4 opacity
                 chartIndicator.style.background = isUpTrend 
                     ? `rgba(0, 230, 118, ${0.25 + intensity})` 
                     : `rgba(255, 82, 82, ${0.25 + intensity})`;
             }
         }
         
         // Mini chart kaldırıldı - Sadece Chart.js kullanıyoruz
         
         // Chart.js ile animasyonlu grafik oluştur
         let tradingChart = null;
         
         // Sayfa yüklendiğinde Chart.js'in hazır olduğunu garanti et
         window.addEventListener('load', function() {
            // Chart.js hazır
         });
         
         function initTradingChart() {
             console.log('🚀🚀🚀 initTradingChart başlatıldı!');
             
             // Chart.js yüklenmiş mi kontrol et
             if (typeof Chart === 'undefined') {
                 console.error('❌❌❌ Chart.js yüklenmemiş!');
                 setTimeout(initTradingChart, 1000); // 1 saniye bekle ve tekrar dene
                 return;
             }
             
             console.log('✅✅✅ Chart.js yüklendi');
             
             const chartContainer = document.querySelector('.chart-container-modern');
             console.log('📦 Chart container:', chartContainer);
             
             const ctx = document.getElementById('tradingChart');
             console.log('📊 Canvas element:', ctx);
             
             if (!ctx) {
                 console.error('❌❌❌ tradingChart canvas bulunamadı!');
                 return;
             }
             
             console.log('✅✅✅ Canvas bulundu!');
             console.log('📏 Canvas dimensions:', ctx.width, 'x', ctx.height);
             console.log('🎨 Canvas style:', ctx.style.cssText);
             
             if (!ctx) {
                 console.error('❌ tradingChart canvas bulunamadı!');
                 return;
             }
             
             // Eğer önceki chart varsa yok et
             if (tradingChart) {
                 tradingChart.destroy();
             }
             
                         // Çok basit test verisi
             const data = [];
             for (let i = 0; i < 20; i++) { // Sadece 20 nokta
                 data.push({
                     x: i,
                     y: 45000 + (i * 100) + (Math.random() * 200 - 100) // Basit artan trend
                 });
             }
             
             // Çok basit chart konfigürasyonu
             const config = {
                 type: 'line',
                 data: {
                     labels: data.map((_, index) => index),
                     datasets: [{
                         label: 'Test',
                         data: data.map(d => d.y),
                         borderColor: '#ff0000',
                         backgroundColor: 'rgba(255, 0, 0, 0.5)',
                         borderWidth: 5,
                         fill: false,
                         tension: 0,
                         pointRadius: 5,
                         pointBackgroundColor: '#ff0000',
                         pointBorderColor: '#ffffff',
                         pointBorderWidth: 2,
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     plugins: {
                         legend: {
                             display: true
                         }
                     },
                     scales: {
                         x: {
                             type: 'linear',
                             display: true,
                             grid: {
                                 color: '#ffffff',
                                 drawBorder: true,
                             },
                             ticks: {
                                 color: '#ffffff',
                                 font: {
                                     size: 14
                                 }
                             }
                         },
                         y: {
                             display: true,
                             grid: {
                                 color: '#ffffff',
                                 drawBorder: true,
                             },
                             ticks: {
                                 color: '#ffffff',
                                 font: {
                                     size: 14
                                 }
                             }
                         }
                     },
                     animation: {
                         duration: 0 // Kendi animasyonumuzu kullanacağız
                     },
                     interaction: {
                         intersect: false,
                         mode: 'index'
                     }
                 }
             };
             
             // Chart'ı oluştur
                          try {
                 console.log('🎨🎨🎨 Chart oluşturuluyor...');
                 console.log('📊 Data length:', data.length);
                 console.log('📊 Sample data:', data.slice(0, 5));
                 console.log('⚙️ Config type:', config.type);
                 
                 tradingChart = new Chart(ctx, config);
                 console.log('✅✅✅ Chart başarıyla oluşturuldu');
                 
                 tradingChart.update();
                 console.log('✅✅✅ Chart render edildi');
                 
                 // Chart'ın gerçekten render edilip edilmediğini kontrol et
                 setTimeout(() => {
                     console.log('🔍 Chart render kontrolü...');
                     console.log('📊 Chart data:', tradingChart.data);
                     console.log('📏 Chart canvas size:', tradingChart.canvas.width, 'x', tradingChart.canvas.height);
                 }, 1000);
                 
             } catch (error) {
                 console.error('❌❌❌ Chart oluşturulurken hata:', error);
                 console.error('❌❌❌ Error stack:', error.stack);
             }
         }
         
         // Modal kapanırken chart'ı temizle
         function destroyTradingChart() {
             if (tradingChart) {
                 tradingChart.destroy();
                 tradingChart = null;
             }
         }
         
         // Coin bulunamadı mesajı
         function showNoCoinsMessage(searchInput) {
             const marketLoader = document.getElementById('marketLoader');
             marketLoader.innerHTML = `
                 <div style="text-align: center; color: #8896ab; padding: 40px;">
                     <i class="fas fa-search" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                     <h3 style="color: #ffffff; margin-bottom: 12px;">
                         ${searchInput ? 'Coin Bulunamadı' : 'Coin Listesi Boş'}
                     </h3>
                     <p style="margin-bottom: 20px;">
                         ${searchInput ? 'Aradığınız kripto para bulunamadı' : 'Veritabanında coin bulunamadı'}
                     </p>
                     <button onclick="fetchMarketData()" style="background: #4fc3f7; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">
                         <i class="fas fa-sync-alt"></i> Yenile
                     </button>
                 </div>
             `;
         }
         
         // Hata mesajı
         function showErrorMessage() {
             const marketLoader = document.getElementById('marketLoader');
             if (marketLoader) {
                 marketLoader.style.display = 'flex';
                 marketLoader.innerHTML = `
                     <div style="text-align: center; color: #f44336; padding: 40px;">
                         <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                         <h3 style="color: #ffffff; margin-bottom: 12px;">Bağlantı Hatası</h3>
                         <p style="color: #8896ab; margin-bottom: 20px;">Piyasa verileri yüklenirken hata oluştu. API bağlantısını kontrol edin.</p>
                         <button onclick="refreshMarketData()" style="background: #4fc3f7; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-right: 10px;">
                             <i class="fas fa-redo"></i> Tekrar Dene
                         </button>
                         <button onclick="showMockMarketData()" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">
                             <i class="fas fa-eye"></i> Demo Veriler
                         </button>
                     </div>
                 `;
             }
             
             // Kullanıcıya bildirim göster
             if (typeof showNotification === 'function') {
                 showNotification('Piyasa verileri yüklenemedi. Demo veriler gösteriliyor.', 'error');
             }
         }
         
         // Mock piyasa verileri göster
         function showMockMarketData() {
             const mockCoins = [
                 {
                     id: 1,
                     coin_adi: 'Bitcoin',
                     coin_kodu: 'BTC',
                     current_price: 96480.50,
                     price_change_24h: 2.35,
                     market_cap: 1900000000000,
                     logo_url: 'https://assets.coingecko.com/coins/images/1/large/bitcoin.png'
                 },
                 {
                     id: 2,
                     coin_adi: 'Ethereum',
                     coin_kodu: 'ETH',
                     current_price: 3420.75,
                     price_change_24h: -1.22,
                     market_cap: 410000000000,
                     logo_url: 'https://assets.coingecko.com/coins/images/279/large/ethereum.png'
                 },
                 {
                     id: 3,
                     coin_adi: 'BNB',
                     coin_kodu: 'BNB',
                     current_price: 685.20,
                     price_change_24h: 0.88,
                     market_cap: 99000000000,
                     logo_url: 'https://assets.coingecko.com/coins/images/825/large/bnb-icon2_2x.png'
                 },
                 {
                     id: 4,
                     coin_adi: 'Solana',
                     coin_kodu: 'SOL',
                     current_price: 238.45,
                     price_change_24h: 4.65,
                     market_cap: 113000000000,
                     logo_url: 'https://assets.coingecko.com/coins/images/4128/large/solana.png'
                 },
                 {
                     id: 5,
                     coin_adi: 'XRP',
                     coin_kodu: 'XRP',
                     current_price: 2.35,
                     price_change_24h: 12.88,
                     market_cap: 133000000000,
                     logo_url: 'https://assets.coingecko.com/coins/images/44/large/xrp-symbol-white-128.png'
                 }
             ];
             
             renderModernCoins(mockCoins);
             document.getElementById('marketLoader').style.display = 'none';
             
             // Başarı mesajı göster
             if (typeof showNotification === 'function') {
                 showNotification('Demo piyasa verileri yüklendi.', 'success');
             }
         }

        // Enhanced Trading Modal - coins.php ile çalışır
        function openTradingModal(coinId, coinName, currentPrice, direction = 'buy', coinSymbol = '') {
            console.log('🚀 ENHANCED TRADING MODAL AÇILIYOR!', { coinId, coinName, currentPrice, direction, coinSymbol });
            const modal = document.getElementById('tradingModal');
            
            // Global değişkenlere kaydet
            window.currentTradingCoin = {
                id: coinId,
                name: coinName,
                price: parseFloat(currentPrice),
                symbol: coinSymbol || coinName.substring(0, 3).toUpperCase(),
                direction: direction
            };
            
            // Fiyat zaten TL cinsinden (backend'den geliyor)
            const priceInTL = parseFloat(currentPrice);
            window.currentTradingCoin.priceInTL = priceInTL;
            
            // Modal'ı göster
            modal.style.display = 'flex';
            
            // Coin bilgilerini modal'a yükle
            const symbol = coinSymbol || coinName.substring(0, 3).toUpperCase();
            document.getElementById('modalCoinName').textContent = coinName;
            document.getElementById('modalCoinSymbol').textContent = symbol;
            document.getElementById('modalCoinPrice').textContent = `₺${priceInTL.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            
            // DÜZELTME: Modal coin icon'unu dinamik olarak ayarla
            updateModalCoinIcon(symbol);
            
            // Price change göster
            const changeElement = document.getElementById('modalCoinChange');
            const change = (Math.random() - 0.5) * 10; // Random değişim %
            changeElement.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
            changeElement.className = `price-change ${change >= 0 ? 'positive' : 'negative'}`;
            
            // Al/Sat fiyatlarını güncelle (0.1% spread)
            const buyPrice = priceInTL * 1.001;
            const sellPrice = priceInTL * 0.999;
            document.getElementById('buyPrice').textContent = `₺${buyPrice.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            document.getElementById('sellPrice').textContent = `₺${sellPrice.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            
            // Summary'de coin fiyatını göster
            document.getElementById('currentCoinPrice').textContent = `₺${priceInTL.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            
            // Quantity suffix'i güncelle
            document.getElementById('quantitySuffix').textContent = symbol;
            
            // Global değişkenleri güncelle
            currentCoinPrice = priceInTL;
            currentCoinSymbol = symbol;
            
            // Direction'a göre initial state ayarla
            setTradingDirection(direction);
            
            // Kullanıcının mevcut bakiyesini yükle
            loadUserBalance();
            
            // Form'u sıfırla
            resetTradingForm();
            
            // Event listener'ları setup et
            setupEnhancedTradingModalEvents();
        }
        
        // Trading direction ayarla
        function setTradingDirection(direction) {
            const buyBtn = document.querySelector('.direction-btn.buy-btn');
            const sellBtn = document.querySelector('.direction-btn.sell-btn');
            const executeBtn = document.getElementById('executeOrderBtn');
            const executeText = document.getElementById('executeText');
            
            if (currentLeverageMode === 'leverage') {
                // Kaldıraçlı işlemde pozisyon tipine göre buton metni
                const positionText = currentPositionType === 'long' ? 'Long Pozisyon Aç' : 'Short Pozisyon Aç';
                executeBtn.className = `execute-btn ${currentPositionType === 'long' ? 'buy-order' : 'sell-order'}`;
                executeText.textContent = `${window.currentTradingCoin.symbol} ${positionText}`;
                
                // Direction butonlarını gizle (kaldıraçta pozisyon tipi kullanılır)
                buyBtn.style.display = 'none';
                sellBtn.style.display = 'none';
            } else {
                // Spot işlemde normal buy/sell
                buyBtn.style.display = 'flex';
                sellBtn.style.display = 'flex';
                
                if (direction === 'buy') {
                    buyBtn.classList.add('active');
                    sellBtn.classList.remove('active');
                    executeBtn.className = 'execute-btn buy-order';
                    executeText.textContent = `${window.currentTradingCoin.symbol} Satın Al`;
                } else {
                    sellBtn.classList.add('active');
                    buyBtn.classList.remove('active');
                    executeBtn.className = 'execute-btn sell-order';
                    executeText.textContent = `${window.currentTradingCoin.symbol} Sat`;
                }
            }
            
            window.currentTradingCoin.direction = direction;
            calculateTrade();
            updateTradingCalculations();
        }
        
        // Kullanıcı bakiyesini yükle
        async function loadUserBalance() {
            try {
                const response = await fetch('backend/public/profile.php', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const result = await response.json();
                if (result.success && result.user) {
                    window.currentUserBalance = parseFloat(result.user.balance) || 0;
                    document.getElementById('currentBalance').textContent = `₺${window.currentUserBalance.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
                } else {
                    window.currentUserBalance = 0;
                    document.getElementById('currentBalance').textContent = '₺0.00';
                }
            } catch (error) {
                console.error('Balance loading error:', error);
                window.currentUserBalance = 0;
                document.getElementById('currentBalance').textContent = '₺0.00';
            }
        }
        
        // Trading form'u sıfırla
        function resetTradingForm() {
            document.getElementById('coinAmount').value = '';
            document.getElementById('totalAmount').value = '';
            
            // Input tabs - default olarak miktar sekmesi aktif
            document.querySelector('.input-tab[data-tab="amount"]').classList.add('active');
            document.querySelector('.input-tab[data-tab="total"]').classList.remove('active');
            document.getElementById('amountSection').style.display = 'block';
            document.getElementById('totalSection').style.display = 'none';
            
            // Percentage butonlarını sıfırla
            document.querySelectorAll('.percent-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Summary'yi sıfırla
            resetSummary();
            
            // Execute butonunu deaktif et
            document.getElementById('executeOrderBtn').disabled = true;
            
            // Balance warning'i gizle
            document.getElementById('balanceWarning').style.display = 'none';
        }
        
        // Summary'yi sıfırla
        function resetSummary() {
            document.getElementById('calculatedAmount').textContent = `0.00000000 ${window.currentTradingCoin.symbol}`;
            document.getElementById('calculatedTotal').textContent = '₺0.00';
            document.getElementById('calculatedFee').textContent = '₺0.00';
            document.getElementById('finalTotal').textContent = '₺0.00';
            document.getElementById('remainingBalance').textContent = `₺${(window.currentUserBalance || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            document.getElementById('executeOrderBtn').disabled = true;
        }
        
        // Enhanced modal event listener'ları
        function setupEnhancedTradingModalEvents() {
            // Direction butonları
            document.querySelectorAll('.direction-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const direction = this.dataset.direction;
                    setTradingDirection(direction);
                });
            });
            
            // Input tabs
            document.querySelectorAll('.input-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabType = this.dataset.tab;
                    
                    // Tab'ları güncelle
                    document.querySelectorAll('.input-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Bölümleri göster/gizle
                    if (tabType === 'amount') {
                        document.getElementById('amountSection').style.display = 'block';
                        document.getElementById('totalSection').style.display = 'none';
                    } else {
                        document.getElementById('amountSection').style.display = 'none';
                        document.getElementById('totalSection').style.display = 'block';
                    }
                    
                    calculateTrade();
                });
            });
            
            // Input field'lar için hesaplama
            document.getElementById('coinAmount').addEventListener('input', function() {
                calculateTrade();
                updateTradingCalculations();
            });
            
            document.getElementById('totalAmount').addEventListener('input', function() {
                calculateTradeFromTotal();
                updateTradingCalculations();
            });
            
            // Percentage butonları
            document.querySelectorAll('.percent-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const percent = parseInt(this.dataset.percent);
                    
                    // Aktif percentage butonunu güncelle
                    document.querySelectorAll('.percent-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    applyPercentage(percent);
                });
            });
            
            // Execute butonu
            document.getElementById('executeOrderBtn').addEventListener('click', executeEnhancedOrder);
        }
        
        // Miktar bazlı hesaplama
        function calculateTrade() {
            const coinAmount = parseFloat(document.getElementById('coinAmount').value) || 0;
            const coinPrice = window.currentTradingCoin.priceInTL;
            const direction = window.currentTradingCoin.direction;
            
            if (coinAmount <= 0) {
                resetSummary();
                return;
            }
            
            // İşlem tutarını hesapla
            const tradeTotal = coinAmount * coinPrice;
            const fee = tradeTotal * 0.001; // 0.1% komisyon
            const finalTotal = tradeTotal + fee;
            
            // Summary'yi güncelle
            document.getElementById('calculatedAmount').textContent = `${coinAmount.toFixed(8)} ${window.currentTradingCoin.symbol}`;
            document.getElementById('calculatedTotal').textContent = `₺${tradeTotal.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            document.getElementById('calculatedFee').textContent = `₺${fee.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            document.getElementById('finalTotal').textContent = `₺${finalTotal.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            
            // Kalan bakiye hesapla
            const currentBalance = window.currentUserBalance || 0;
            let remainingBalance = currentBalance;
            
            if (direction === 'buy') {
                remainingBalance = currentBalance - finalTotal;
            } else {
                remainingBalance = currentBalance + tradeTotal - fee;
            }
            
            document.getElementById('remainingBalance').textContent = `₺${remainingBalance.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            
            // Execute butonunu aktif/deaktif et ve balance warning göster
            const executeBtn = document.getElementById('executeOrderBtn');
            const balanceWarning = document.getElementById('balanceWarning');
            
            if (direction === 'buy') {
                if (finalTotal > currentBalance) {
                    executeBtn.disabled = true;
                    balanceWarning.style.display = 'flex';
                } else {
                    executeBtn.disabled = coinAmount <= 0;
                    balanceWarning.style.display = 'none';
                }
            } else {
                executeBtn.disabled = coinAmount <= 0;
                balanceWarning.style.display = 'none';
            }
        }
        
        // Toplam tutar bazlı hesaplama
        function calculateTradeFromTotal() {
            const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
            const coinPrice = window.currentTradingCoin.priceInTL;
            const direction = window.currentTradingCoin.direction;
            
            if (totalAmount <= 0) {
                resetSummary();
                return;
            }
            
            // Komisyon dahil toplam tutardan net tutarı hesapla
            const fee = totalAmount * 0.001; // 0.1% komisyon
            const netAmount = totalAmount - fee;
            const coinAmount = netAmount / coinPrice;
            
            // Summary'yi güncelle
            document.getElementById('calculatedAmount').textContent = `${coinAmount.toFixed(8)} ${window.currentTradingCoin.symbol}`;
            document.getElementById('calculatedTotal').textContent = `₺${netAmount.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            document.getElementById('calculatedFee').textContent = `₺${fee.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            document.getElementById('finalTotal').textContent = `₺${totalAmount.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            
            // Coin amount input'u güncelle
            document.getElementById('coinAmount').value = coinAmount.toFixed(8);
            
            // Kalan bakiye hesapla
            const currentBalance = window.currentUserBalance || 0;
            let remainingBalance = currentBalance;
            
            if (direction === 'buy') {
                remainingBalance = currentBalance - totalAmount;
            } else {
                remainingBalance = currentBalance + netAmount;
            }
            
            document.getElementById('remainingBalance').textContent = `₺${remainingBalance.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            
            // Execute butonunu aktif/deaktif et ve balance warning göster
            const executeBtn = document.getElementById('executeOrderBtn');
            const balanceWarning = document.getElementById('balanceWarning');
            
            if (direction === 'buy') {
                if (totalAmount > currentBalance) {
                    executeBtn.disabled = true;
                    balanceWarning.style.display = 'flex';
                } else {
                    executeBtn.disabled = coinAmount <= 0;
                    balanceWarning.style.display = 'none';
                }
            } else {
                executeBtn.disabled = coinAmount <= 0;
                balanceWarning.style.display = 'none';
            }
        }
        
        // Yüzdelik hesaplama uygula
        function applyPercentage(percent) {
            const currentBalance = window.currentUserBalance || 0;
            const direction = window.currentTradingCoin.direction;
            
            // Hangi tab aktif olduğunu kontrol et
            const activeTab = document.querySelector('.input-tab.active');
            const currentTabType = activeTab ? activeTab.dataset.tab : 'amount';
            
            if (direction === 'buy') {
                // Satın alma için
                if (currentTabType === 'total') {
                    // Toplam ₺ tab'ındaysa - bakiyenin %'ini harcanacak tutar olarak ayarla
                    const targetAmount = (currentBalance * percent) / 100;
                    document.getElementById('totalAmount').value = targetAmount.toFixed(2);
                    calculateTradeFromTotal();
                } else {
                    // Miktar tab'ındaysa - önce toplam ₺'yi hesapla, sonra miktar tab'ında göster
                    const targetTotalAmount = (currentBalance * percent) / 100;
                    const coinPrice = window.currentTradingCoin.priceInTL;
                    const coinAmount = targetTotalAmount / coinPrice;
                    document.getElementById('coinAmount').value = coinAmount.toFixed(8);
                    calculateTrade();
                }
            } else {
                // Satış için - portföydeki coin'in %'ini sat
                const coinPrice = window.currentTradingCoin.priceInTL;
                
                if (currentTabType === 'amount') {
                    // Miktar tab'ındaysa
                    const targetAmount = (currentBalance * percent) / (100 * coinPrice);
                    document.getElementById('coinAmount').value = targetAmount.toFixed(8);
                    calculateTrade();
                } else {
                    // Toplam ₺ tab'ındaysa
                    const targetTotalAmount = (currentBalance * percent) / 100;
                    document.getElementById('totalAmount').value = targetTotalAmount.toFixed(2);
                    calculateTradeFromTotal();
                }
            }
        }
        
        // Enhanced order execution
        async function executeEnhancedOrder() {
            console.log('🎯 Execute button tıklandı!');
            console.log('🔍 Mevcut mod:', currentLeverageMode);
            
            if (!window.currentTradingCoin) {
                console.error('❌ currentTradingCoin bulunamadı');
                showNotification('Coin bilgisi bulunamadı', 'error');
                return;
            }
            
            // Kaldıraçlı işlem kontrolü
            if (currentLeverageMode === 'leverage') {
                console.log('🔄 Kaldıraçlı işlem başlatılıyor...', {
                    mode: currentLeverageMode,
                    leverage: currentLeverage,
                    positionType: currentPositionType,
                    coinSymbol: window.currentTradingCoin?.symbol,
                    price: window.currentTradingCoin?.priceInTL
                });
                
                // Miktar hesapla
                const coinAmount = parseFloat(document.getElementById('coinAmount').value) || 0;
                const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
                let investedAmount = 0;
                
                if (totalAmount > 0) {
                    investedAmount = totalAmount;
                } else if (coinAmount > 0) {
                    investedAmount = (coinAmount * window.currentTradingCoin.priceInTL) / currentLeverage;
                } else {
                    showNotification('Lütfen bir miktar giriniz', 'error');
                    return;
                }
                
                console.log('💰 Yatırım miktarı hesaplandı:', investedAmount);
                
                await executeLeverageOrder({
                    coin_symbol: window.currentTradingCoin.symbol,
                    invested_amount: investedAmount,
                    entry_price: window.currentTradingCoin.priceInTL
                });
                return;
            }
            
            const direction = window.currentTradingCoin.direction;
            const coinAmount = parseFloat(document.getElementById('coinAmount').value);
            const currentPrice = window.currentTradingCoin.priceInTL;
            
            if (!coinAmount || coinAmount <= 0) {
                showNotification('Geçerli bir miktar giriniz', 'error');
                return;
            }
            
            // Bakiye kontrolü
            const tradeTotal = coinAmount * currentPrice;
            const fee = tradeTotal * 0.001;
            const finalTotal = tradeTotal + fee;
            
            if (direction === 'buy' && finalTotal > (window.currentUserBalance || 0)) {
                showNotification('Yetersiz bakiye', 'error');
                return;
            }
            
            // Loading state
            const executeBtn = document.getElementById('executeOrderBtn');
            const executeText = document.getElementById('executeText');
            const originalText = executeText.textContent;
            
            executeBtn.disabled = true;
            executeText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> İşleniyor...';
            
            try {
                const formData = new FormData();
                formData.append('coin_id', window.currentTradingCoin.id);
                formData.append('miktar', coinAmount);
                formData.append('fiyat', currentPrice);
                
                const response = await fetch(`backend/user/trading.php?action=${direction}`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                const result = await response.json();
                console.log('🔄 Enhanced Trading result:', result);
                
                if (result.success) {
                    const directionText = direction === 'buy' ? 'SATIN ALMA' : 'SATIM';
                    const totalAmount = result.data.toplam_tutar;
                    
                    // Başarı bildirimi
                    showNotification(
                        `✅ ${directionText} İşlemi Başarılı!\n${coinAmount.toFixed(8)} ${window.currentTradingCoin.symbol} - ₺${totalAmount.toLocaleString('tr-TR')}`,
                        'success'
                    );
                    
                    // Modal'ı kapat
                    closeTradingModal();
                    
                    // Kullanıcı bilgilerini ve portföyü güncelle
                    setTimeout(() => {
                        loadUserInfo();
                        if (typeof loadPortfolio === 'function') {
                            loadPortfolio();
                        }
                    }, 500);
                    
                } else {
                    showNotification(`❌ İşlem Hatası: ${result.message}`, 'error');
                    executeBtn.disabled = false;
                    executeText.textContent = originalText;
                }
                
            } catch (error) {
                console.error('Enhanced Trading API Error:', error);
                showNotification('❌ Bağlantı hatası. Lütfen tekrar deneyin.', 'error');
                executeBtn.disabled = false;
                executeText.textContent = originalText;
            }
        }

        // Modal coin icon'unu dinamik olarak güncelle - DÜZELTME: String parsing ve hizalama sorunları
        function updateModalCoinIcon(coinSymbol) {
            const modalCoinIconContainer = document.querySelector('.coin-icon-container');
            if (!modalCoinIconContainer) return;
            
            // Güvenli string işleme için coinSymbol'ü temizle
            const safeCoinSymbol = String(coinSymbol).trim().toUpperCase();
            
            // Gerçek coin logoları (piyasalardaki gibi)
            const coinLogos = {
                'BTC': 'https://assets.coingecko.com/coins/images/1/large/bitcoin.png',
                'ETH': 'https://assets.coingecko.com/coins/images/279/large/ethereum.png',
                'BNB': 'https://assets.coingecko.com/coins/images/825/large/bnb-icon2_2x.png',
                'ADA': 'https://assets.coingecko.com/coins/images/975/large/cardano.png',
                'SOL': 'https://assets.coingecko.com/coins/images/4128/large/solana.png',
                'XRP': 'https://assets.coingecko.com/coins/images/44/large/xrp-symbol-white-128.png',
                'DOT': 'https://assets.coingecko.com/coins/images/12171/large/polkadot.png',
                'DOGE': 'https://assets.coingecko.com/coins/images/5/large/dogecoin.png',
                'AVAX': 'https://assets.coingecko.com/coins/images/12559/large/Avalanche_Circle_RedWhite_Trans.png',
                'SHIB': 'https://assets.coingecko.com/coins/images/11939/large/shiba.png',
                'LINK': 'https://assets.coingecko.com/coins/images/877/large/chainlink-new-logo.png',
                'TRX': 'https://assets.coingecko.com/coins/images/1094/large/tron-logo.png',
                'MATIC': 'https://assets.coingecko.com/coins/images/4713/large/matic-token-icon.png',
                'LTC': 'https://assets.coingecko.com/coins/images/2/large/litecoin.png',
                'BCH': 'https://assets.coingecko.com/coins/images/780/large/bitcoin-cash-circle.png',
                'UNI': 'https://assets.coingecko.com/coins/images/12504/large/uniswap-uni.png',
                'ATOM': 'https://assets.coingecko.com/coins/images/1481/large/cosmos_hub.png',
                'XLM': 'https://assets.coingecko.com/coins/images/100/large/Stellar_symbol_black_RGB.png',
                'VET': 'https://assets.coingecko.com/coins/images/1167/large/VeChain-Logo-768x725.png',
                'FIL': 'https://assets.coingecko.com/coins/images/12817/large/filecoin.png',
                'THETA': 'https://assets.coingecko.com/coins/images/2538/large/theta-token-logo.png',
                'ICP': 'https://assets.coingecko.com/coins/images/14495/large/Internet_Computer_logo.png',
                'ALGO': 'https://assets.coingecko.com/coins/images/4380/large/download.png',
                'XTZ': 'https://assets.coingecko.com/coins/images/976/large/Tezos-logo.png',
                'EGLD': 'https://assets.coingecko.com/coins/images/12335/large/egld-token-logo.png',
                'AAVE': 'https://assets.coingecko.com/coins/images/12645/large/AAVE.png',
                'EOS': 'https://assets.coingecko.com/coins/images/738/large/eos-eos-logo.png',
                'XMR': 'https://assets.coingecko.com/coins/images/69/large/monero_logo.png',
                'MANA': 'https://assets.coingecko.com/coins/images/878/large/decentraland-mana.png',
                'SAND': 'https://assets.coingecko.com/coins/images/12129/large/sandbox_logo.jpg',
                'CRO': 'https://assets.coingecko.com/coins/images/7310/large/cypto.png',
                'NEAR': 'https://assets.coingecko.com/coins/images/10365/large/near_icon.png',
                'APE': 'https://assets.coingecko.com/coins/images/24383/large/apecoin.jpg',
                'LDO': 'https://assets.coingecko.com/coins/images/13573/large/Lido_DAO.png',
                'USDT': 'https://assets.coingecko.com/coins/images/325/large/Tether.png',
                'USDC': 'https://assets.coingecko.com/coins/images/6319/large/USD_Coin_icon.png',
                'BUSD': 'https://assets.coingecko.com/coins/images/9576/large/BUSD.png',
                'DAI': 'https://assets.coingecko.com/coins/images/9956/large/4943.png'
            };
            
            // Logo URL'ini belirle
            const logoUrl = coinLogos[safeCoinSymbol];
            const firstLetter = safeCoinSymbol.charAt(0) || 'C';
            
            // Container'ı temizle
            modalCoinIconContainer.innerHTML = '';
            
            if (logoUrl) {
                // Logo ile container oluştur - DÜZELTME: Hizalama ve fallback
                const logoImg = document.createElement('img');
                logoImg.src = logoUrl;
                logoImg.alt = safeCoinSymbol;
                logoImg.style.cssText = `
                    width: 100%;
                    height: 100%;
                    border-radius: 50%;
                    object-fit: cover;
                    object-position: center;
                    display: block;
                    margin: 0;
                    padding: 0;
                `;
                
                // Hata durumunda fallback
                logoImg.onerror = function() {
                    console.warn(`Logo yüklenemedi: ${logoUrl}`);
                    modalCoinIconContainer.innerHTML = `
                        <div style="
                            width: 100%;
                            height: 100%;
                            border-radius: 50%;
                            background: linear-gradient(135deg, #ff7c4c 0%, #ff9a3c 100%);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 24px;
                            color: white;
                            font-weight: bold;
                            margin: 0;
                            padding: 0;
                        ">${firstLetter}</div>
                    `;
                };
                
                modalCoinIconContainer.appendChild(logoImg);
                
            } else {
                // Logo yoksa sadece harf göster - DÜZELTME: Merkezi hizalama
                modalCoinIconContainer.innerHTML = `
                    <div style="
                        width: 100%;
                        height: 100%;
                        border-radius: 50%;
                        background: linear-gradient(135deg, #ff7c4c 0%, #ff9a3c 100%);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 24px;
                        color: white;
                        font-weight: bold;
                        margin: 0;
                        padding: 0;
                    ">${firstLetter}</div>
                `;
            }
            
            console.log(`🎨 Modal logo güncellendi: ${safeCoinSymbol} -> ${logoUrl || 'Letter: ' + firstLetter}`);
        }

        // Enhanced Trading modalını kapat
        function closeTradingModal() {
            const modal = document.getElementById('tradingModal');
            if (!modal) return;
            
            const container = modal.querySelector('.modal-container-enhanced');
            
            // Animasyon ile kapat
            if (container) {
                container.style.transform = 'scale(0.9) translateY(20px)';
                container.style.opacity = '0';
            }
            
            // Modal overlay'i de gizle
            const overlay = modal.querySelector('.modal-overlay');
            if (overlay) {
                overlay.style.opacity = '0';
            }
            
            setTimeout(() => {
                modal.style.display = 'none';
                
                // Container'ı sıfırla
                if (container) {
                    container.style.transform = '';
                    container.style.opacity = '';
                }
                
                // Overlay'i sıfırla
                if (overlay) {
                    overlay.style.opacity = '';
                }
                
                // Global değişkenleri temizle
                window.currentTradingCoin = null;
                window.currentUserBalance = null;
                currentCoinPrice = 0;
                currentCoinSymbol = '';
                
                // Form'u tamamen sıfırla
                resetTradingFormCompletely();
                
                // Event listener'ları temizle
                cleanupModalEventListeners();
                
            }, 300);
        }
        
        // Trading form'u tamamen sıfırla
        function resetTradingFormCompletely() {
            // Input alanlarını temizle
            const coinAmountInput = document.getElementById('coinAmount');
            const totalAmountInput = document.getElementById('totalAmount');
            
            if (coinAmountInput) coinAmountInput.value = '';
            if (totalAmountInput) totalAmountInput.value = '';
            
            // Tab'ları sıfırla
            const amountTab = document.querySelector('.input-tab[data-tab="amount"]');
            const totalTab = document.querySelector('.input-tab[data-tab="total"]');
            
            if (amountTab) amountTab.classList.add('active');
            if (totalTab) totalTab.classList.remove('active');
            
            // Section'ları sıfırla
            const amountSection = document.getElementById('amountSection');
            const totalSection = document.getElementById('totalSection');
            
            if (amountSection) amountSection.style.display = 'block';
            if (totalSection) totalSection.style.display = 'none';
            
            // Percentage butonlarını sıfırla
            document.querySelectorAll('.percent-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Direction butonlarını sıfırla
            const buyBtn = document.querySelector('.direction-btn.buy-btn');
            const sellBtn = document.querySelector('.direction-btn.sell-btn');
            
            if (buyBtn) buyBtn.classList.add('active');
            if (sellBtn) sellBtn.classList.remove('active');
            
            // Execute butonunu deaktif et
            const executeBtn = document.getElementById('executeOrderBtn');
            if (executeBtn) {
                executeBtn.disabled = true;
                executeBtn.className = 'execute-btn buy-order';
            }
            
            // Balance warning'i gizle
            const balanceWarning = document.getElementById('balanceWarning');
            if (balanceWarning) {
                balanceWarning.style.display = 'none';
            }
            
            // Kaldıraç ayarlarını sıfırla
            currentLeverageMode = 'spot';
            currentLeverage = 1;
            currentPositionType = 'long';
            
            // Mode tab'larını sıfırla
            document.querySelectorAll('.mode-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.mode === 'spot') {
                    tab.classList.add('active');
                }
            });
            
            // Leverage selection'ı gizle
            const leverageSelection = document.getElementById('leverageSelection');
            if (leverageSelection) {
                leverageSelection.style.display = 'none';
            }
            
            // Summary'yi sıfırla
            resetSummaryCompletely();
        }
        
        // Summary'yi tamamen sıfırla
        function resetSummaryCompletely() {
            const elements = [
                'calculatedAmount',
                'calculatedTotal', 
                'calculatedFee',
                'finalTotal',
                'currentBalance',
                'remainingBalance',
                'currentCoinPrice'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (id === 'calculatedAmount') {
                        element.textContent = '0.00000000 BTC';
                    } else if (id === 'currentCoinPrice') {
                        element.textContent = '₺0.00';
                    } else {
                        element.textContent = '₺0.00';
                    }
                }
            });
        }
        
        // Modal event listener'ları temizle
        function cleanupModalEventListeners() {
            // Yeni event listener'lar eklemeden önce eskilerini temizle
            const modal = document.getElementById('tradingModal');
            if (!modal) return;
            
            // Clone node to remove all event listeners
            const newModal = modal.cloneNode(true);
            modal.parentNode.replaceChild(newModal, modal);
        }

         // Trading modal event listener'ları
         function setupTradingModalEvents() {
             // Direction toggle
             document.querySelectorAll('.direction-btn').forEach(btn => {
                 btn.addEventListener('click', function() {
                     document.querySelectorAll('.direction-btn').forEach(b => b.classList.remove('active'));
                     this.classList.add('active');
                     
                     const direction = this.dataset.direction;
                     const executeBtn = document.getElementById('executeOrderBtn');
                     const executeText = document.getElementById('executeText');
                     const coinSymbol = document.getElementById('modalCoinSymbol').textContent;
                     
                     if (direction === 'buy') {
                         executeBtn.className = 'execute-btn buy-order';
                         executeText.textContent = `${coinSymbol} Al`;
                     } else {
                         executeBtn.className = 'execute-btn sell-order';
                         executeText.textContent = `${coinSymbol} Sat`;
                     }
                 });
             });

             // Order type değişikliği
             document.getElementById('orderType').addEventListener('change', function() {
                 const priceGroup = document.getElementById('priceGroup');
                 if (this.value === 'limit' || this.value === 'stop_limit') {
                     priceGroup.style.display = 'block';
                 } else {
                     priceGroup.style.display = 'none';
                 }
             });

             // Amount tabs
             document.querySelectorAll('.amount-tab').forEach(tab => {
                 tab.addEventListener('click', function() {
                     document.querySelectorAll('.amount-tab').forEach(t => t.classList.remove('active'));
                     this.classList.add('active');
                     
                     const type = this.dataset.type;
                     const quantityGroup = document.getElementById('quantityGroup');
                     const totalGroup = document.getElementById('totalGroup');
                     
                     if (type === 'quantity') {
                         quantityGroup.style.display = 'block';
                         totalGroup.style.display = 'none';
                     } else {
                         quantityGroup.style.display = 'none';
                         totalGroup.style.display = 'block';
                     }
                 });
             });

             // Percentage buttons
             document.querySelectorAll('.percent-btn').forEach(btn => {
                 btn.addEventListener('click', function() {
                     const percent = parseInt(this.dataset.percent);
                     const balance = 10000; // User balance (gerçek değer backend'den gelecek)
                     const price = parseFloat(document.getElementById('modalCoinPrice').textContent.replace('₺', '').replace(',', ''));
                     
                     const totalAmount = (balance * percent) / 100;
                     const quantity = totalAmount / price;
                     
                     document.getElementById('orderQuantity').value = quantity.toFixed(6);
                     updateOrderSummary();
                 });
             });

             // Input değişiklikleri
             ['orderQuantity', 'orderTotal', 'orderPrice'].forEach(id => {
                 const element = document.getElementById(id);
                 if (element) {
                     element.addEventListener('input', updateOrderSummary);
                 }
             });

             // Timeframe buttons
             document.querySelectorAll('.timeframe-btn').forEach(btn => {
                 btn.addEventListener('click', function() {
                     document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
                     this.classList.add('active');
                     
                     // Grafik timeframe'ini değiştir
                     const timeframe = this.dataset.timeframe;
                     updateChartTimeframe(timeframe);
                 });
             });

             // Execute order - bu event listener kaldırıldı (çakışma önlenmesi için)
         }

         // Order özeti güncelle
         function updateOrderSummary() {
             const quantity = parseFloat(document.getElementById('orderQuantity').value) || 0;
             const price = parseFloat(document.getElementById('modalCoinPrice').textContent.replace('₺', '').replace(',', '')) || 0;
             const orderPrice = parseFloat(document.getElementById('orderPrice').value) || price;
             
             const total = quantity * orderPrice;
             const fee = total * 0.001; // 0.1% fee
             const totalWithFee = total + fee;
             
             document.getElementById('orderTotalValue').textContent = `₺${total.toFixed(2)}`;
             document.getElementById('tradingFee').textContent = `₺${fee.toFixed(2)}`;
             
             // Execute button'ı etkinleştir/devre dışı bırak
             const executeBtn = document.getElementById('executeOrderBtn');
             executeBtn.disabled = quantity <= 0 || total <= 0;
         }

                 // Order'ı execute et
        async function executeOrder() {
            if (!window.currentTradingCoin) {
                showNotification('Coin bilgisi bulunamadı', 'error');
                return;
            }
            
            const direction = document.querySelector('.direction-btn.active').dataset.direction;
            const quantity = parseFloat(document.getElementById('orderQuantity').value);
            const currentPrice = window.currentTradingCoin.price * 30; // USD -> TL
            
            if (!quantity || quantity <= 0) {
                showNotification('Geçerli bir miktar giriniz', 'error');
                return;
            }
            
            // Loading state
            const executeBtn = document.getElementById('executeOrderBtn');
            const originalText = executeBtn.innerHTML;
            executeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> İşleniyor...';
            executeBtn.disabled = true;
            
            try {
                const formData = new FormData();
                formData.append('coin_id', window.currentTradingCoin.id);
                formData.append('miktar', quantity);
                formData.append('fiyat', currentPrice);
                
                const response = await fetch(`backend/user/trading.php?action=${direction}`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const directionText = direction === 'buy' ? 'SATIN ALMA' : 'SATIM';
                    const totalAmount = result.data.toplam_tutar;
                    
                    showNotification(
                        `✅ ${directionText} İşlemi Başarılı!\n` +
                        `${quantity} ${window.currentTradingCoin.symbol} - ₺${totalAmount.toLocaleString('tr-TR')}`,
                        'success'
                    );
                    
                    // Modal'ı kapat
                    closeTradingModal();
                    
                    // Kullanıcı bilgilerini ve portföyü güncelle
                    loadUserInfo();
                    if (typeof loadPortfolio === 'function') {
                        loadPortfolio();
                    }
                    
                } else {
                    showNotification(`❌ İşlem Hatası: ${result.message}`, 'error');
                }
                
            } catch (error) {
                console.error('Trading API Error:', error);
                showNotification('❌ Bağlantı hatası. Lütfen tekrar deneyin.', 'error');
            } finally {
                // Loading state'i kaldır
                executeBtn.innerHTML = originalText;
                executeBtn.disabled = false;
            }
        }

                 // Sahte grafik yükle
         function loadFakeChart(symbol) {
             const fakeChart = document.getElementById('fake-chart');
             const placeholder = document.getElementById('chartPlaceholder');
             
             // Placeholder'ı gizle
             placeholder.style.display = 'none';
             fakeChart.style.display = 'block';
             
             // Canvas grafik çiz
             createFakePriceChart(symbol);
         }
         
         // Sahte fiyat grafiği oluştur
         function createFakePriceChart(symbol) {
             const canvas = document.getElementById('priceChart');
             const ctx = canvas.getContext('2d');
             
             // Canvas boyutlarını ayarla
             canvas.width = canvas.offsetWidth;
             canvas.height = canvas.offsetHeight;
             
             // Gerçekçi fiyat verisi oluştur
             const prices = generateFakePriceData();
             drawPriceChart(ctx, prices, symbol);
             
             // Animasyonlu fiyat güncellemesi
             setInterval(() => {
                 updateFakePrice(ctx, symbol);
             }, 3000);
         }
         
         // Sahte fiyat verisi oluştur
         function generateFakePriceData() {
             const data = [];
             let price = 45000 + Math.random() * 5000;
             
             for (let i = 0; i < 100; i++) {
                 price += (Math.random() - 0.5) * 200;
                 data.push({
                     x: i,
                     y: price
                 });
             }
             
             return data;
         }
         
         // Grafik çiz
         function drawPriceChart(ctx, data, symbol) {
             const width = ctx.canvas.width;
             const height = ctx.canvas.height;
             
             // Arka plan
             ctx.fillStyle = '#141927';
             ctx.fillRect(0, 0, width, height);
             
             // Grid çizgileri
             ctx.strokeStyle = '#2a2f3e';
             ctx.lineWidth = 1;
             
             for (let i = 0; i <= 10; i++) {
                 const y = (height / 10) * i;
                 ctx.beginPath();
                 ctx.moveTo(0, y);
                 ctx.lineTo(width, y);
                 ctx.stroke();
             }
             
             // Fiyat çizgisi
             ctx.strokeStyle = '#00d4aa';
             ctx.lineWidth = 2;
             ctx.beginPath();
             
             data.forEach((point, index) => {
                 const x = (width / data.length) * index;
                 const y = height - ((point.y - 40000) / 10000) * height;
                 
                 if (index === 0) {
                     ctx.moveTo(x, y);
                 } else {
                     ctx.lineTo(x, y);
                 }
             });
             
             ctx.stroke();
             
             // Fiyat etiketi
             ctx.fillStyle = '#ffffff';
             ctx.font = '14px Arial';
             ctx.fillText(`${symbol.toUpperCase()}: ₺${data[data.length - 1].y.toFixed(2)}`, 10, 20);
         }
         
         // Fiyat güncelle
         function updateFakePrice(ctx, symbol) {
             const currentPrice = 45000 + Math.random() * 5000;
             
             // Fiyat etiketini güncelle
             ctx.fillStyle = '#141927';
             ctx.fillRect(0, 0, 200, 30);
             
             ctx.fillStyle = '#ffffff';
             ctx.font = '14px Arial';
             ctx.fillText(`${symbol.toUpperCase()}: ₺${currentPrice.toFixed(2)}`, 10, 20);
         }
         
         // Advanced options toggle
        function toggleAdvancedOptions() {
            const content = document.getElementById('advancedContent');
            const icon = document.querySelector('.advanced-toggle i');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // Modern coin rendering - her iki platform için
        function renderModernCoins(coins) {
            const marketLoader = document.getElementById('marketLoader');
            const desktopGrid = document.getElementById('desktopCoinsGrid');
            const mobileGrid = document.getElementById('mobileCoinsGrid');
            
            marketLoader.style.display = 'none';
            
            // Desktop grid render
            renderDesktopCoins(coins, desktopGrid);
            
            // Mobile grid render
            renderMobileCoins(coins, mobileGrid);
            
            // Grids'i göster
            desktopGrid.style.display = window.innerWidth > 768 ? 'grid' : 'none';
            mobileGrid.style.display = window.innerWidth <= 768 ? 'grid' : 'none';
            
            // Update last update time
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('tr-TR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Desktop coin kartları render et
        function renderDesktopCoins(coins, container) {
            container.innerHTML = '';
            
            coins.forEach((coin, index) => {
                const priceChangeClass = coin.price_change_24h >= 0 ? 'positive' : 'negative';
                const priceChangeIcon = coin.price_change_24h >= 0 ? '▲' : '▼';
                
                // Orijinal coin logoları
                const coinLogos = {
                    'BTC': 'https://assets.coingecko.com/coins/images/1/large/bitcoin.png',
                    'ETH': 'https://assets.coingecko.com/coins/images/279/large/ethereum.png',
                    'BNB': 'https://assets.coingecko.com/coins/images/825/large/bnb-icon2_2x.png',
                    'ADA': 'https://assets.coingecko.com/coins/images/975/large/cardano.png',
                    'SOL': 'https://assets.coingecko.com/coins/images/4128/large/solana.png',
                    'XRP': 'https://assets.coingecko.com/coins/images/44/large/xrp-symbol-white-128.png',
                    'DOT': 'https://assets.coingecko.com/coins/images/12171/large/polkadot.png',
                    'DOGE': 'https://assets.coingecko.com/coins/images/5/large/dogecoin.png',
                    'AVAX': 'https://assets.coingecko.com/coins/images/12559/large/Avalanche_Circle_RedWhite_Trans.png',
                    'SHIB': 'https://assets.coingecko.com/coins/images/11939/large/shiba.png',
                    'LINK': 'https://assets.coingecko.com/coins/images/877/large/chainlink-new-logo.png',
                    'TRX': 'https://assets.coingecko.com/coins/images/1094/large/tron-logo.png',
                    'MATIC': 'https://assets.coingecko.com/coins/images/4713/large/matic-token-icon.png',
                    'LTC': 'https://assets.coingecko.com/coins/images/2/large/litecoin.png',
                    'BCH': 'https://assets.coingecko.com/coins/images/780/large/bitcoin-cash-circle.png',
                    'UNI': 'https://assets.coingecko.com/coins/images/12504/large/uniswap-uni.png',
                    'ATOM': 'https://assets.coingecko.com/coins/images/1481/large/cosmos_hub.png',
                    'XLM': 'https://assets.coingecko.com/coins/images/100/large/Stellar_symbol_black_RGB.png',
                    'VET': 'https://assets.coingecko.com/coins/images/1167/large/VeChain-Logo-768x725.png',
                    'FIL': 'https://assets.coingecko.com/coins/images/12817/large/filecoin.png',
                    'THETA': 'https://assets.coingecko.com/coins/images/2538/large/theta-token-logo.png',
                    'ICP': 'https://assets.coingecko.com/coins/images/14495/large/Internet_Computer_logo.png',
                    'ALGO': 'https://assets.coingecko.com/coins/images/4380/large/download.png',
                    'XTZ': 'https://assets.coingecko.com/coins/images/976/large/Tezos-logo.png',
                    'EGLD': 'https://assets.coingecko.com/coins/images/12335/large/egld-token-logo.png',
                    'AAVE': 'https://assets.coingecko.com/coins/images/12645/large/AAVE.png',
                    'EOS': 'https://assets.coingecko.com/coins/images/738/large/eos-eos-logo.png',
                    'XMR': 'https://assets.coingecko.com/coins/images/69/large/monero_logo.png',
                    'MANA': 'https://assets.coingecko.com/coins/images/878/large/decentraland-mana.png',
                    'SAND': 'https://assets.coingecko.com/coins/images/12129/large/sandbox_logo.jpg',
                    'CRO': 'https://assets.coingecko.com/coins/images/7310/large/cypto.png',
                    'NEAR': 'https://assets.coingecko.com/coins/images/10365/large/near_icon.png',
                    'APE': 'https://assets.coingecko.com/coins/images/24383/large/apecoin.jpg',
                    'LDO': 'https://assets.coingecko.com/coins/images/13573/large/Lido_DAO.png',
                    'USDT': 'https://assets.coingecko.com/coins/images/325/large/Tether.png',
                    'USDC': 'https://assets.coingecko.com/coins/images/6319/large/USD_Coin_icon.png',
                    'BUSD': 'https://assets.coingecko.com/coins/images/9576/large/BUSD.png',
                    'DAI': 'https://assets.coingecko.com/coins/images/9956/large/4943.png'
                };
                
                const logoUrl = coin.logo_url || coinLogos[coin.coin_kodu] || `https://via.placeholder.com/48/4fc3f7/ffffff?text=${coin.coin_kodu.charAt(0)}`;
                
                        const card = document.createElement('div');
                        card.className = 'desktop-coin-card';
                        card.onclick = () => openTradingModal(coin.id, coin.coin_adi, coin.current_price, 'buy', coin.coin_kodu);
                        
                        card.innerHTML = `
                            <div class="coin-card-header">
                                <div class="coin-info">
                                    <div class="coin-logo">
                                        <img src="${logoUrl}" alt="${coin.coin_adi}" 
                                             onerror="this.style.display='none'; this.parentNode.textContent='${coin.coin_kodu.charAt(0)}'">
                                    </div>
                                    <div class="coin-details">
                                        <h4>${coin.coin_adi}</h4>
                                        <span class="coin-symbol">${coin.coin_kodu}</span>
                                    </div>
                                </div>
                                <div class="coin-price">
                                    <div class="price">₺${parseFloat(coin.current_price).toLocaleString('tr-TR', { 
                                        minimumFractionDigits: 2, 
                                        maximumFractionDigits: 2 
                                    })}</div>
                                    <div class="rank">#${index + 1}</div>
                                </div>
                            </div>
                    
                    <div class="coin-stats">
                        <div class="price-change ${priceChangeClass}">
                            <i class="fas fa-${coin.price_change_24h >= 0 ? 'arrow-up' : 'arrow-down'}"></i>
                            ${parseFloat(coin.price_change_24h).toFixed(2)}%
                        </div>
                        <div class="volume-info">
                            Piyasa Değeri: $${coin.market_cap ? (parseInt(coin.market_cap) / 1000000).toFixed(1) + 'M' : 'N/A'}
                        </div>
                    </div>
                    
                    <div class="coin-actions">
                        <button class="trade-btn buy" onclick="event.stopPropagation(); openTradingModal('${coin.id}', '${coin.coin_adi}', '${coin.current_price}', 'buy', '${coin.coin_kodu}')">
                            <i class="fas fa-arrow-up"></i> Alış
                        </button>
                        <button class="trade-btn sell" onclick="event.stopPropagation(); openTradingModal('${coin.id}', '${coin.coin_adi}', '${coin.current_price}', 'sell', '${coin.coin_kodu}')">
                            <i class="fas fa-arrow-down"></i> Satış
                        </button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // Mobil coin kartları render et
        function renderMobileCoins(coins, container) {
            container.innerHTML = '';
            
            coins.forEach((coin, index) => {
                const priceChangeClass = coin.price_change_24h >= 0 ? 'positive' : 'negative';
                const priceChangeIcon = coin.price_change_24h >= 0 ? '▲' : '▼';
                
                // Orijinal coin logoları
                const coinLogos = {
                    'BTC': 'https://assets.coingecko.com/coins/images/1/large/bitcoin.png',
                    'ETH': 'https://assets.coingecko.com/coins/images/279/large/ethereum.png',
                    'BNB': 'https://assets.coingecko.com/coins/images/825/large/bnb-icon2_2x.png',
                    'ADA': 'https://assets.coingecko.com/coins/images/975/large/cardano.png',
                    'SOL': 'https://assets.coingecko.com/coins/images/4128/large/solana.png',
                    'XRP': 'https://assets.coingecko.com/coins/images/44/large/xrp-symbol-white-128.png',
                    'DOT': 'https://assets.coingecko.com/coins/images/12171/large/polkadot.png',
                    'DOGE': 'https://assets.coingecko.com/coins/images/5/large/dogecoin.png',
                    'AVAX': 'https://assets.coingecko.com/coins/images/12559/large/Avalanche_Circle_RedWhite_Trans.png',
                    'SHIB': 'https://assets.coingecko.com/coins/images/11939/large/shiba.png',
                    'LINK': 'https://assets.coingecko.com/coins/images/877/large/chainlink-new-logo.png',
                    'TRX': 'https://assets.coingecko.com/coins/images/1094/large/tron-logo.png',
                    'MATIC': 'https://assets.coingecko.com/coins/images/4713/large/matic-token-icon.png',
                    'LTC': 'https://assets.coingecko.com/coins/images/2/large/litecoin.png',
                    'BCH': 'https://assets.coingecko.com/coins/images/780/large/bitcoin-cash-circle.png',
                    'UNI': 'https://assets.coingecko.com/coins/images/12504/large/uniswap-uni.png',
                    'ATOM': 'https://assets.coingecko.com/coins/images/1481/large/cosmos_hub.png',
                    'XLM': 'https://assets.coingecko.com/coins/images/100/large/Stellar_symbol_black_RGB.png',
                    'VET': 'https://assets.coingecko.com/coins/images/1167/large/VeChain-Logo-768x725.png',
                    'FIL': 'https://assets.coingecko.com/coins/images/12817/large/filecoin.png',
                    'THETA': 'https://assets.coingecko.com/coins/images/2538/large/theta-token-logo.png',
                    'ICP': 'https://assets.coingecko.com/coins/images/14495/large/Internet_Computer_logo.png',
                    'ALGO': 'https://assets.coingecko.com/coins/images/4380/large/download.png',
                    'XTZ': 'https://assets.coingecko.com/coins/images/976/large/Tezos-logo.png',
                    'EGLD': 'https://assets.coingecko.com/coins/images/12335/large/egld-token-logo.png',
                    'AAVE': 'https://assets.coingecko.com/coins/images/12645/large/AAVE.png',
                    'EOS': 'https://assets.coingecko.com/coins/images/738/large/eos-eos-logo.png',
                    'XMR': 'https://assets.coingecko.com/coins/images/69/large/monero_logo.png',
                    'MANA': 'https://assets.coingecko.com/coins/images/878/large/decentraland-mana.png',
                    'SAND': 'https://assets.coingecko.com/coins/images/12129/large/sandbox_logo.jpg',
                    'CRO': 'https://assets.coingecko.com/coins/images/7310/large/cypto.png',
                    'NEAR': 'https://assets.coingecko.com/coins/images/10365/large/near_icon.png',
                    'APE': 'https://assets.coingecko.com/coins/images/24383/large/apecoin.jpg',
                    'LDO': 'https://assets.coingecko.com/coins/images/13573/large/Lido_DAO.png',
                    'USDT': 'https://assets.coingecko.com/coins/images/325/large/Tether.png',
                    'USDC': 'https://assets.coingecko.com/coins/images/6319/large/USD_Coin_icon.png',
                    'BUSD': 'https://assets.coingecko.com/coins/images/9576/large/BUSD.png',
                    'DAI': 'https://assets.coingecko.com/coins/images/9956/large/4943.png'
                };
                
                const logoUrl = coin.logo_url || coinLogos[coin.coin_kodu] || `https://via.placeholder.com/50/4fc3f7/ffffff?text=${coin.coin_kodu.charAt(0)}`;
                
                const card = document.createElement('div');
                card.className = 'mobile-coin-card';
                card.innerHTML = `
                    <div class="mobile-coin-header">
                        <div class="mobile-coin-info">
                            <div class="mobile-coin-logo">
                                <img src="${logoUrl}" alt="${coin.coin_adi}" 
                                     style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;"
                                     onerror="this.style.display='none'; this.parentNode.textContent='${coin.coin_kodu.charAt(0)}'">
                            </div>
                            <div class="mobile-coin-details">
                                <h3>${coin.coin_adi}</h3>
                                <span class="coin-symbol">${coin.coin_kodu}</span>
                            </div>
                        </div>
                        <div class="mobile-coin-price">
                            $${parseFloat(coin.current_price).toLocaleString('en-US', { 
                                minimumFractionDigits: 2, 
                                maximumFractionDigits: 6 
                            })}
                        </div>
                    </div>
                    
                    <div class="mobile-coin-stats">
                        <div class="mobile-coin-change ${priceChangeClass}">
                            ${priceChangeIcon} ${parseFloat(coin.price_change_24h).toFixed(2)}%
                        </div>
                        <div class="mobile-coin-volume">
                            Vol: $${coin.market_cap ? (parseInt(coin.market_cap) / 1000000).toFixed(1) + 'M' : 'N/A'}
                        </div>
                    </div>
                    
                    <div class="mobile-coin-actions">
                        <button class="mobile-trade-btn buy" onclick="openTradingModal('${coin.id}', '${coin.coin_adi}', '${coin.current_price}', 'buy', '${coin.coin_kodu}')">
                            <i class="fas fa-arrow-up"></i> Alış
                        </button>
                        <button class="mobile-trade-btn sell" onclick="openTradingModal('${coin.id}', '${coin.coin_adi}', '${coin.current_price}', 'sell', '${coin.coin_kodu}')">
                            <i class="fas fa-arrow-down"></i> Satış
                        </button>
                    </div>
                `;
                
                container.appendChild(card);
            });
         }

         // Global chart variables
         let chartAnimationFrame;
         let chartData = {
             priceData: [],
             timeLabels: [],
             animationProgress: 0,
             isAnimating: false,
             lastUpdate: 0,
             coinId: '',
             basePrice: 0
         };

         // Animasyonlu grafik çizme fonksiyonu
         function drawPriceChart(coinId, currentPrice) {
             const canvas = document.getElementById('priceChart');
             const placeholder = document.getElementById('chartPlaceholder');
             const ctx = canvas.getContext('2d');
             
             // Canvas boyutlarını ayarla
             const rect = canvas.getBoundingClientRect();
             canvas.width = rect.width * window.devicePixelRatio;
             canvas.height = rect.height * window.devicePixelRatio;
             ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
             
             // Placeholder'ı gizle
             placeholder.style.display = 'none';
             canvas.style.display = 'block';
             
             // Chart data'yı inicialize et
             initializeChartData(coinId, currentPrice);
             
             // Animasyonu başlat
             startChartAnimation(ctx, rect);
         }

         // Chart data'yı inicialize et
         function initializeChartData(coinId, currentPrice) {
             chartData.coinId = coinId;
             chartData.basePrice = parseFloat(currentPrice);
             chartData.priceData = [];
             chartData.timeLabels = [];
             chartData.animationProgress = 0;
             chartData.isAnimating = true;
             
             const dataPoints = 50;
             
             for (let i = dataPoints; i >= 0; i--) {
                 const variation = (Math.random() - 0.5) * 0.15; // %15 varyasyon
                 const trend = Math.sin((i / dataPoints) * Math.PI * 2) * 0.05; // Sinüs trend
                 const noise = (Math.random() - 0.5) * 0.03; // Küçük gürültü
                 const price = chartData.basePrice * (1 + variation + trend + noise);
                 chartData.priceData.push(price);
                 
                 const time = new Date();
                 time.setMinutes(time.getMinutes() - i * 5);
                 chartData.timeLabels.push(time.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }));
             }
         }

         // Chart animasyonunu başlat
         function startChartAnimation(ctx, rect) {
             const startTime = performance.now();
             
             function animate(currentTime) {
                 const elapsed = currentTime - startTime;
                 const duration = 2000; // 2 saniye animasyon
                 
                 chartData.animationProgress = Math.min(elapsed / duration, 1);
                 
                 // Canvas'ı temizle
                 ctx.clearRect(0, 0, rect.width, rect.height);
                 
                 // Grafiği çiz
                 drawAnimatedChart(ctx, rect);
                 
                 if (chartData.animationProgress < 1) {
                     chartAnimationFrame = requestAnimationFrame(animate);
                 } else {
                     // Animasyon tamamlandı, canlı güncellemeleri başlat
                     startLiveUpdates(ctx, rect);
                 }
             }
             
             chartAnimationFrame = requestAnimationFrame(animate);
         }

         // Animasyonlu chart çiz
         function drawAnimatedChart(ctx, rect) {
             const padding = 40;
             const chartWidth = rect.width - padding * 2;
             const chartHeight = rect.height - padding * 2;
             
             // Min/Max değerleri bul
             const minPrice = Math.min(...chartData.priceData);
             const maxPrice = Math.max(...chartData.priceData);
             const priceRange = maxPrice - minPrice;
             
             // Grid çiz (fade in)
             const gridOpacity = chartData.animationProgress * 0.1;
             ctx.strokeStyle = `rgba(255, 255, 255, ${gridOpacity})`;
             ctx.lineWidth = 1;
             
             // Yatay grid çizgileri
             for (let i = 0; i <= 5; i++) {
                 const y = padding + (chartHeight / 5) * i;
                 ctx.beginPath();
                 ctx.moveTo(padding, y);
                 ctx.lineTo(padding + chartWidth, y);
                 ctx.stroke();
                 
                 // Fiyat etiketleri (fade in)
                 const price = maxPrice - (priceRange / 5) * i;
                 ctx.fillStyle = `rgba(136, 150, 171, ${chartData.animationProgress})`;
                 ctx.font = '12px Inter, sans-serif';
                 ctx.textAlign = 'right';
                 ctx.fillText('$' + price.toFixed(2), padding - 10, y + 4);
             }
             
             // Dikey grid çizgileri
             for (let i = 0; i <= 10; i++) {
                 const x = padding + (chartWidth / 10) * i;
                 ctx.beginPath();
                 ctx.moveTo(x, padding);
                 ctx.lineTo(x, padding + chartHeight);
                 ctx.stroke();
             }
             
             // Animasyonlu fiyat çizgisi
             const dataPoints = chartData.priceData.length;
             const currentPoints = Math.floor(dataPoints * chartData.animationProgress);
             
             if (currentPoints > 1) {
                 // Ana çizgi
                 ctx.strokeStyle = '#4fc3f7';
                 ctx.lineWidth = 3;
                 ctx.beginPath();
                 
                 for (let i = 0; i < currentPoints; i++) {
                     const x = padding + (chartWidth / (dataPoints - 1)) * i;
                     const y = padding + chartHeight - ((chartData.priceData[i] - minPrice) / priceRange) * chartHeight;
                     
                     if (i === 0) {
                         ctx.moveTo(x, y);
                     } else {
                         ctx.lineTo(x, y);
                     }
                 }
                 ctx.stroke();
                 
                 // Gradient fill (animasyonlu)
                 const gradient = ctx.createLinearGradient(0, padding, 0, padding + chartHeight);
                 const fillOpacity = chartData.animationProgress * 0.3;
                 gradient.addColorStop(0, `rgba(79, 195, 247, ${fillOpacity})`);
                 gradient.addColorStop(1, `rgba(79, 195, 247, ${fillOpacity * 0.1})`);
                 
                 ctx.fillStyle = gradient;
                 ctx.beginPath();
                 
                 for (let i = 0; i < currentPoints; i++) {
                     const x = padding + (chartWidth / (dataPoints - 1)) * i;
                     const y = padding + chartHeight - ((chartData.priceData[i] - minPrice) / priceRange) * chartHeight;
                     
                     if (i === 0) {
                         ctx.moveTo(x, y);
                     } else {
                         ctx.lineTo(x, y);
                     }
                 }
                 
                 // Fill to bottom
                 if (currentPoints > 0) {
                     const lastX = padding + (chartWidth / (dataPoints - 1)) * (currentPoints - 1);
                     ctx.lineTo(lastX, padding + chartHeight);
                     ctx.lineTo(padding, padding + chartHeight);
                 }
                 ctx.closePath();
                 ctx.fill();
                 
                 // Animating dot at the end
                 if (currentPoints > 0) {
                     const lastIndex = currentPoints - 1;
                     const lastX = padding + (chartWidth / (dataPoints - 1)) * lastIndex;
                     const lastY = padding + chartHeight - ((chartData.priceData[lastIndex] - minPrice) / priceRange) * chartHeight;
                     
                     // Pulsing effect
                     const pulseScale = 1 + Math.sin(performance.now() * 0.01) * 0.3;
                     
                     ctx.beginPath();
                     ctx.arc(lastX, lastY, 6 * pulseScale, 0, 2 * Math.PI);
                     ctx.fillStyle = '#4fc3f7';
                     ctx.fill();
                     ctx.strokeStyle = '#ffffff';
                     ctx.lineWidth = 2;
                     ctx.stroke();
                 }
             }
             
             // Başlık (fade in)
             ctx.fillStyle = `rgba(255, 255, 255, ${chartData.animationProgress})`;
             ctx.font = 'bold 16px Inter, sans-serif';
             ctx.textAlign = 'left';
             ctx.fillText(`${chartData.coinId.toUpperCase()}/USD Price Chart`, padding, 25);
             
             // Son fiyat (fade in)
             if (chartData.priceData.length > 0) {
                 ctx.fillStyle = `rgba(79, 195, 247, ${chartData.animationProgress})`;
                 ctx.font = 'bold 14px Inter, sans-serif';
                 ctx.textAlign = 'right';
                 const currentIndex = Math.min(Math.floor(chartData.priceData.length * chartData.animationProgress), chartData.priceData.length - 1);
                 ctx.fillText('$' + chartData.priceData[currentIndex].toFixed(6), rect.width - padding, 25);
             }
         }

         // Canlı güncellemeleri başlat
         function startLiveUpdates(ctx, rect) {
             function updatePrice() {
                 // Yeni fiyat noktası ekle
                 const lastPrice = chartData.priceData[chartData.priceData.length - 1];
                 const change = (Math.random() - 0.5) * 0.02; // %2 değişim
                 const newPrice = lastPrice * (1 + change);
                 
                 // Array'i kaydır ve yeni fiyat ekle
                 chartData.priceData.shift();
                 chartData.priceData.push(newPrice);
                 
                 // Time label'ı güncelle
                 chartData.timeLabels.shift();
                 const now = new Date();
                 chartData.timeLabels.push(now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }));
                 
                 // Grafiği yeniden çiz
                 ctx.clearRect(0, 0, rect.width, rect.height);
                 chartData.animationProgress = 1; // Tam görünür
                 drawAnimatedChart(ctx, rect);
                 
                 // Modal price'ı güncelle
                 document.getElementById('modalCoinPrice').textContent = `$${newPrice.toLocaleString()}`;
                 
                 // 3 saniye sonra tekrar güncelle
                 setTimeout(updatePrice, 3000);
             }
             
             // İlk güncellemeyi 3 saniye sonra başlat
             setTimeout(updatePrice, 3000);
         }

                   // Modal kapandığında animasyonu durdur
          function stopChartAnimation() {
              if (chartAnimationFrame) {
                  cancelAnimationFrame(chartAnimationFrame);
                  chartAnimationFrame = null;
              }
              chartData.isAnimating = false;
          }

          // Timeframe değiştir
          function updateChartTimeframe(timeframe) {
              if (!chartData.isAnimating && chartData.priceData.length > 0) {
                  // Farklı timeframe'ler için farklı data pattern'leri
                  const patterns = {
                      '1m': { volatility: 0.01, trend: 0.02 },
                      '5m': { volatility: 0.02, trend: 0.03 },
                      '15m': { volatility: 0.03, trend: 0.04 },
                      '1h': { volatility: 0.05, trend: 0.06 },
                      '4h': { volatility: 0.08, trend: 0.08 },
                      '1d': { volatility: 0.12, trend: 0.10 }
                  };
                  
                  const pattern = patterns[timeframe] || patterns['1h'];
                  
                  // Yeni data generate et
                  const dataPoints = 50;
                  const newPriceData = [];
                  
                  for (let i = 0; i < dataPoints; i++) {
                      const variation = (Math.random() - 0.5) * pattern.volatility;
                      const trend = Math.sin((i / dataPoints) * Math.PI * 3) * pattern.trend;
                      const noise = (Math.random() - 0.5) * (pattern.volatility * 0.3);
                      const price = chartData.basePrice * (1 + variation + trend + noise);
                      newPriceData.push(price);
                  }
                  
                  chartData.priceData = newPriceData;
                  
                  // Grafiği smooth transition ile güncelle
                  const canvas = document.getElementById('priceChart');
                  const ctx = canvas.getContext('2d');
                  const rect = canvas.getBoundingClientRect();
                  
                  // Kısa animasyonla güncelle
                  let progress = 0;
                  function updateTransition() {
                      progress += 0.1;
                      if (progress <= 1) {
                          ctx.clearRect(0, 0, rect.width, rect.height);
                          chartData.animationProgress = 1;
                          drawAnimatedChart(ctx, rect);
                          requestAnimationFrame(updateTransition);
                      }
                  }
                  requestAnimationFrame(updateTransition);
              }
          }

         // Filter fonksiyonları
        function initializeMarketFilters() {
            const filterChips = document.querySelectorAll('.filter-chip');
            filterChips.forEach(chip => {
                chip.addEventListener('click', function() {
                    // Aktif filter'ı değiştir
                    filterChips.forEach(f => f.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Filter uygula (şimdilik demo)
                    const filter = this.dataset.filter;
                    console.log('Filter uygulandı:', filter);
                    
                    // Burada gerçek filtreleme mantığı olacak
                    // fetchMarketData() çağrısı ile backend'e filter parametresi gönderilebilir
                });
            });
        }
        
        // Search input için debounced arama
        function initializeCoinSearch() {
            const searchInput = document.getElementById('coinSearch');
            let searchTimeout;
            
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    fetchMarketData();
                }, 500); // 500ms debounce
            });
        }
        
        // Responsive listener
        function initializeResponsiveListeners() {
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    // Grid görünümlerini tekrar düzenle
                    const desktopGrid = document.getElementById('desktopCoinsGrid');
                    const mobileGrid = document.getElementById('mobileCoinsGrid');
                    
                    if (desktopGrid && mobileGrid) {
                        if (window.innerWidth > 768) {
                            desktopGrid.style.display = 'grid';
                            mobileGrid.style.display = 'none';
                        } else {
                            desktopGrid.style.display = 'none';
                            mobileGrid.style.display = 'grid';
                        }
                    }
                }, 250);
            });
        }
        
        // Page init
        function initializeMarketPage() {
            initializeMarketFilters();
            initializeCoinSearch();
            initializeResponsiveListeners();
            
            // İlk veri yüklemesi
            fetchMarketData();
          }

         // Sayfa yüklendiğinde piyasaları yükle
        async function refreshMarketData() {
            await fetchMarketData();
        }

        // Trading sistem değişkenleri
        let selectedForexPair = null;
        let currentTradeDirection = 'long';

        // Trading sistemini başlat
        function initTrading() {
            loadForexPairs();
            setupTradingEventListeners();
        }

        // Forex pair'leri yükle
        async function loadForexPairs() {
            const forexLoader = document.getElementById('forexLoader');
            const forexPairsList = document.getElementById('forexPairsList');

            try {
                // Şimdilik mock data kullan - sonra backend endpoint eklenecek
                const mockForexData = [
                    { id: 1, symbol: 'EURUSD', display_name: 'EUR/USD', category: 'major', current_price: 1.08500, bid_price: 1.08480, ask_price: 1.08520, spread: 4.0, pip_value: 0.0001, max_leverage: 500 },
                    { id: 2, symbol: 'GBPUSD', display_name: 'GBP/USD', category: 'major', current_price: 1.26800, bid_price: 1.26780, ask_price: 1.26820, spread: 4.0, pip_value: 0.0001, max_leverage: 500 },
                    { id: 3, symbol: 'USDJPY', display_name: 'USD/JPY', category: 'major', current_price: 148.250, bid_price: 148.230, ask_price: 148.270, spread: 4.0, pip_value: 0.01, max_leverage: 500 },
                    { id: 4, symbol: 'XAUUSD', display_name: 'Gold', category: 'commodities', current_price: 2685.50, bid_price: 2685.00, ask_price: 2686.00, spread: 10.0, pip_value: 0.01, max_leverage: 200 },
                    { id: 5, symbol: 'US30', display_name: 'Dow Jones', category: 'indices', current_price: 42580.50, bid_price: 42578.0, ask_price: 42583.0, spread: 5.0, pip_value: 1.0, max_leverage: 100 }
                ];

                renderForexPairs(mockForexData);
                forexLoader.style.display = 'none';
                forexPairsList.style.display = 'block';

            } catch (error) {
                console.error('Forex pairs yükleme hatası:', error);
                forexPairsList.innerHTML = '<p style="color: #ff4757; text-align: center; padding: 20px;">Forex verileri yüklenemedi</p>';
                forexLoader.style.display = 'none';
                forexPairsList.style.display = 'block';
            }
        }

        // Forex pair'leri renderla
        function renderForexPairs(pairs) {
            const container = document.getElementById('forexPairsList');
            container.innerHTML = '';

            pairs.forEach(pair => {
                const priceDirection = Math.random() > 0.5 ? 'up' : 'down';
                const priceColor = priceDirection === 'up' ? '#00d4aa' : '#ff4757';
                const priceIcon = priceDirection === 'up' ? '▲' : '▼';

                const pairElement = document.createElement('div');
                pairElement.className = 'forex-pair-item';
                pairElement.dataset.pairId = pair.id;
                pairElement.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div class="pair-symbol">${pair.display_name}</div>
                            <div class="pair-category">${pair.category} • Max Leverage 1:${pair.max_leverage}</div>
                        </div>
                        <div style="text-align: right; min-width: 120px;">
                            <div class="pair-price ${priceDirection === 'up' ? 'price-up' : 'price-down'}">
                                ${pair.current_price} ${priceIcon}
                            </div>
                            <div class="pair-spread">Spread ${pair.spread} pips</div>
                        </div>
                    </div>
                `;

                pairElement.addEventListener('click', () => selectForexPair(pair));
                container.appendChild(pairElement);
            });
        }

        // Forex pair seç
        function selectForexPair(pair) {
            selectedForexPair = pair;

            // Seçili pair'i görsel olarak işaretle
            document.querySelectorAll('.forex-pair-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector(`[data-pair-id="${pair.id}"]`).classList.add('selected');

            // Trading form'unu aktif et
            document.getElementById('tradingForm').style.display = 'block';
            document.getElementById('noSelectionMessage').style.display = 'none';

            // Pair bilgilerini güncelle
            document.getElementById('selectedPairInfo').innerHTML = `
                <strong>${pair.display_name}</strong> | Price: ${pair.current_price} | Spread: ${pair.spread} pips | Max Leverage: 1:${pair.max_leverage}
            `;

            // Kaldıraç seçeneklerini güncelle
            updateLeverageOptions(pair.max_leverage);

            // Hesaplamaları güncelle
            updateTradeCalculations();
        }

        // Kaldıraç seçeneklerini güncelle
        function updateLeverageOptions(maxLeverage) {
            const leverageSelect = document.getElementById('leverageRatio');
            leverageSelect.innerHTML = '';

            const leverageOptions = [10, 50, 100, 200, 500].filter(lev => lev <= maxLeverage);
            leverageOptions.forEach(leverage => {
                const option = document.createElement('option');
                option.value = leverage;
                option.textContent = `1:${leverage}`;
                if (leverage === 100 && leverage <= maxLeverage) option.selected = true;
                leverageSelect.appendChild(option);
            });
        }

        // Trade hesaplamalarını güncelle
        function updateTradeCalculations() {
            if (!selectedForexPair) return;

            const lotSize = parseFloat(document.getElementById('lotSize').value);
            const leverage = parseInt(document.getElementById('leverageRatio').value);

            // Basit margin hesaplaması
            const contractSize = 100000; // Standard lot size
            const price = selectedForexPair.current_price;
            const requiredMargin = (lotSize * contractSize * price) / leverage;

            // Pip değeri hesaplama
            const pipValue = lotSize * contractSize * selectedForexPair.pip_value;

            // DOM'u güncelle
            document.getElementById('requiredMargin').textContent = `$${requiredMargin.toFixed(2)}`;
            document.getElementById('pipValue').textContent = `$${pipValue.toFixed(2)}`;
            document.getElementById('spreadValue').textContent = `${selectedForexPair.spread} pips`;
            document.getElementById('contractSize').textContent = `${(lotSize * contractSize).toLocaleString()}`;

            // Trade butonunu aktif et
            document.getElementById('openTradeBtn').disabled = false;
        }

        // Trading event listener'ları kurulum
        function setupTradingEventListeners() {
            // Direction buttons
            document.getElementById('longBtn').addEventListener('click', function() {
                setTradeDirection('long');
            });
            document.getElementById('shortBtn').addEventListener('click', function() {
                setTradeDirection('short');
            });

            // Form değişiklikleri
            ['lotSize', 'leverageRatio'].forEach(id => {
                document.getElementById(id).addEventListener('change', updateTradeCalculations);
            });

            // Trade açma butonu
            document.getElementById('openTradeBtn').addEventListener('click', openTrade);

            // Kategori filtreleri
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Filter logic burada eklenecek
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        // Trade direction değiştir
        function setTradeDirection(direction) {
            currentTradeDirection = direction;
            document.querySelectorAll('.trade-direction-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(direction + 'Btn').classList.add('active');
        }

        // Trade aç
        async function openTrade() {
            if (!selectedForexPair) {
                alert('Lütfen bir forex pair seçin');
                return;
            }

            const tradeData = {
                pair_id: selectedForexPair.id,
                trade_type: currentTradeDirection,
                lot_size: parseFloat(document.getElementById('lotSize').value),
                leverage_ratio: parseInt(document.getElementById('leverageRatio').value),
                stop_loss: document.getElementById('stopLoss').value || null,
                take_profit: document.getElementById('takeProfit').value || null
            };

            try {
                // Şimdilik mock response - sonra gerçek backend endpoint eklenecek
                console.log('Trade açılıyor:', tradeData);
                
                alert(`🚀 ${selectedForexPair.display_name} için ${currentTradeDirection.toUpperCase()} pozisyonu açıldı!\n\nLot: ${tradeData.lot_size}\nKaldıraç: 1:${tradeData.leverage_ratio}\n\nPozisyon yönetimi için backend entegrasyonu yakında...`);
                
                // Form'u resetle
                resetTradingForm();
                
            } catch (error) {
                console.error('Trade açma hatası:', error);
                alert('Trade açılırken hata oluştu');
            }
        }

        // Trading form'unu resetle
        function resetTradingForm() {
            document.getElementById('stopLoss').value = '';
            document.getElementById('takeProfit').value = '';
            updateTradeCalculations();
        }

        // Pozisyonları yenile
        function refreshPositions() {
            const positionsLoader = document.getElementById('positionsLoader');
            const positionsList = document.getElementById('openPositionsList');
            
            positionsLoader.style.display = 'block';
            positionsList.style.display = 'none';
            
            // Mock pozisyon verisi
            setTimeout(() => {
                positionsList.innerHTML = `
                    <div style="text-align: center; color: #8b8fa3; padding: 30px;">
                        <i class="fas fa-chart-line" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
                        <p>Açık pozisyon bulunmuyor</p>
                        <small>Forex pair seçerek trading başlayabilirsiniz</small>
                    </div>
                `;
                positionsLoader.style.display = 'none';
                positionsList.style.display = 'block';
            }, 1000);
        }
        
        // Sayfa yüklendiğinde initialization yap
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Trading Dashboard başlatılıyor...');
            
            // Market sayfası için özel initialization
            if (document.getElementById('coinSearch')) {
                initializeMarketPage();
            }
            
            // Trading sistemi başlat
            if (document.getElementById('forexPairsContainer')) {
                initTrading();
            }
            
            // Kullanıcı verilerini yükle
            loadUserInfo();
        });

        // Kaldıraçlı İşlem Sistemi
        let currentLeverageMode = 'spot';
        let currentLeverage = 1;
        let currentPositionType = 'long';
        let currentCoinPrice = 0;
        let currentCoinSymbol = 'BTC';

        // Trading modal'ı başlat
        function initTradingModal() {
            // Mode tab event listeners
            document.querySelectorAll('.mode-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    currentLeverageMode = this.dataset.mode;
                    toggleLeverageSelection();
                    updateTradingCalculations();
                    
                    // Execute button'ı güncelle
                    setTradingDirection(window.currentTradingCoin?.direction || 'buy');
                });
            });

            // Leverage button event listeners
            document.querySelectorAll('.leverage-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.leverage-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    currentLeverage = parseFloat(this.dataset.leverage);
                    updateTradingCalculations();
                });
            });

            // Position type event listeners
            document.querySelectorAll('.position-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.position-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    currentPositionType = this.dataset.position;
                    updateTradingCalculations();
                    
                    // Execute button metnini güncelle
                    if (currentLeverageMode === 'leverage') {
                        const executeText = document.getElementById('executeText');
                        const positionText = currentPositionType === 'long' ? 'Long Pozisyon Aç' : 'Short Pozisyon Aç';
                        executeText.textContent = `${currentCoinSymbol} ${positionText}`;
                        
                        const executeBtn = document.getElementById('executeOrderBtn');
                        executeBtn.className = `execute-btn ${currentPositionType === 'long' ? 'buy-order' : 'sell-order'}`;
                    }
                });
            });
        }

        // Kaldıraç seçimini göster/gizle
        function toggleLeverageSelection() {
            const leverageSelection = document.getElementById('leverageSelection');
            const leverageSummaryRows = document.getElementById('leverageSummaryRows');
            const executeBtn = document.getElementById('executeOrderBtn');
            
            if (currentLeverageMode === 'leverage') {
                leverageSelection.style.display = 'block';
                leverageSummaryRows.style.display = 'block';
                
                // Kaldıraç modunda execute button'ı aktif et
                executeBtn.disabled = false;
            } else {
                leverageSelection.style.display = 'none';
                leverageSummaryRows.style.display = 'none';
            }
        }

        // Trading hesaplamalarını güncelle
        function updateTradingCalculations() {
            if (currentLeverageMode === 'leverage') {
                updateLeverageCalculations();
            }
        }

        // Kaldıraç hesaplamalarını güncelle (DÜZELTME: Doğru formüller)
        function updateLeverageCalculations() {
            const coinAmount = parseFloat(document.getElementById('coinAmount').value) || 0;
            const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
            const currentPrice = parseFloat(currentCoinPrice) || 0;

            if (currentPrice > 0) {
                let investedAmount = 0;
                let positionSize = 0;

                if (coinAmount > 0) {
                    // Coin miktarından yatırım hesapla
                    const totalPositionValue = coinAmount * currentPrice;
                    investedAmount = totalPositionValue / currentLeverage;
                    positionSize = coinAmount;
                } else if (totalAmount > 0) {
                    // Toplam tutardan pozisyon hesapla
                    investedAmount = totalAmount;
                    const totalPositionValue = totalAmount * currentLeverage;
                    positionSize = totalPositionValue / currentPrice;
                }

                // Liquidation price hesapla (DÜZELTME: Doğru formül)
                const liquidationPercentage = 0.8; // %80 zarar durumunda liquidation
                const marginCallThreshold = liquidationPercentage / currentLeverage;
                let liquidationPrice = 0;
                
                if (currentPositionType === 'long') {
                    // Long: Fiyat düştüğünde liquidation
                    liquidationPrice = currentPrice * (1 - marginCallThreshold);
                } else {
                    // Short: Fiyat yükseldiğinde liquidation
                    liquidationPrice = currentPrice * (1 + marginCallThreshold);
                }

                // Potansiyel kar/zarar hesapla
                const potentialPnL = calculatePotentialPnL(investedAmount, currentPrice, liquidationPrice);

                // UI'yı güncelle
                document.getElementById('leverageRatio').textContent = currentLeverage + 'x';
                document.getElementById('positionSize').textContent = positionSize.toFixed(8) + ' ' + currentCoinSymbol;
                document.getElementById('liquidationPrice').textContent = '₺' + liquidationPrice.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                document.getElementById('investedAmount').textContent = '₺' + investedAmount.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                
                // Risk uyarısı ekle
                const riskPercentage = (Math.abs(currentPrice - liquidationPrice) / currentPrice) * 100;
                updateRiskIndicator(riskPercentage);
            }
        }
        
        // Potansiyel kar/zarar hesaplama fonksiyonu
        function calculatePotentialPnL(investedAmount, entryPrice, targetPrice) {
            const priceChangePercentage = (targetPrice - entryPrice) / entryPrice;
            let pnl = 0;
            
            if (currentPositionType === 'long') {
                pnl = priceChangePercentage * investedAmount * currentLeverage;
            } else {
                pnl = -priceChangePercentage * investedAmount * currentLeverage;
            }
            
            return pnl;
        }
        
        // Risk göstergesi güncelle
        function updateRiskIndicator(riskPercentage) {
            const riskElement = document.getElementById('riskIndicator');
            if (!riskElement) return;
            
            let riskLevel = 'low';
            let riskColor = '#10b981';
            let riskText = 'Düşük Risk';
            
            if (riskPercentage < 5) {
                riskLevel = 'high';
                riskColor = '#ef4444';
                riskText = 'Yüksek Risk - Liquidation Yakın!';
            } else if (riskPercentage < 15) {
                riskLevel = 'medium';
                riskColor = '#f59e0b';
                riskText = 'Orta Risk';
            }
            
            riskElement.style.color = riskColor;
            riskElement.textContent = `${riskText} (${riskPercentage.toFixed(1)}%)`;
        }

        // Pozisyonları yükle
        async function loadPositions() {
            try {
                const response = await fetch('backend/user/leverage_trading.php?action=positions', {
                    credentials: 'include'
                });

                const data = await response.json();
                
                if (data.success) {
                    // Pozisyonları global değişkende sakla
                    window.currentPositions = data.positions;
                    displayPositions(data.positions);
                    updatePositionStats(data.positions);
                } else {
                    throw new Error(data.error || 'Pozisyonlar yüklenemedi');
                }
            } catch (error) {
                console.error('Pozisyon yükleme hatası:', error);
                document.getElementById('positionsTable').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Pozisyonlar yüklenirken hata oluştu</span>
                        <br>
                        <small>Hata: ${error.message}</small>
                    </div>
                `;
            }
        }

        // Pozisyonları görüntüle - DÜZELTME: Kullanıcı dostu pozisyon kapatma
        function displayPositions(positions) {
            const container = document.getElementById('positionsTable');
            
            if (positions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h3>Henüz Pozisyon Yok</h3>
                        <p>Kaldıraçlı işlem yapmak için piyasalar sayfasından coin seçip kaldıraçlı mod ile işlem yapabilirsiniz</p>
                        <button class="btn-primary" onclick="showSection('markets')">
                            <i class="fas fa-plus"></i>
                            İlk Pozisyonu Aç
                        </button>
                    </div>
                `;
                return;
            }

            let positionsHTML = `
                <div class="modern-positions-container">
            `;

            positions.forEach(position => {
                const pnlClass = position.unrealized_pnl >= 0 ? 'positive' : 'negative';
                const pnlSign = position.unrealized_pnl >= 0 ? '+' : '';
                const pnlPercentage = parseFloat(position.pnl_percentage || 0).toFixed(1);
                const currentPrice = parseFloat(position.market_price || position.current_price);
                const entryPrice = parseFloat(position.entry_price);
                const priceChangePercent = ((currentPrice - entryPrice) / entryPrice * 100).toFixed(2);
                const priceChangeClass = currentPrice >= entryPrice ? 'positive' : 'negative';
                
                // Risk seviyesi hesapla
                const liquidationPrice = parseFloat(position.liquidation_price || 0);
                let riskLevel = 'low';
                let riskColor = '#10b981';
                let riskText = 'Düşük Risk';
                
                if (liquidationPrice > 0) {
                    const distanceToLiquidation = Math.abs(currentPrice - liquidationPrice) / currentPrice * 100;
                    if (distanceToLiquidation < 5) {
                        riskLevel = 'critical';
                        riskColor = '#ef4444';
                        riskText = 'KRİTİK RİSK!';
                    } else if (distanceToLiquidation < 15) {
                        riskLevel = 'high';
                        riskColor = '#f59e0b';
                        riskText = 'Yüksek Risk';
                    } else if (distanceToLiquidation < 30) {
                        riskLevel = 'medium';
                        riskColor = '#3b82f6';
                        riskText = 'Orta Risk';
                    }
                }
                
                positionsHTML += `
                    <div class="modern-position-card ${position.position_type} risk-${riskLevel}">
                        <!-- Risk Uyarısı -->
                        ${riskLevel === 'critical' ? `
                        <div class="risk-warning critical">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>LIQUIDATION RİSKİ! Pozisyonu kapatmayı düşünün</span>
                        </div>
                        ` : ''}
                        
                        <div class="position-main-info">
                            <div class="coin-section">
                                <div class="coin-icon">
                                    <i class="fab fa-bitcoin"></i>
                                </div>
                                <div class="coin-details">
                                    <h3 class="coin-name">${position.coin_symbol}</h3>
                                    <div class="position-type ${position.position_type}">
                                        <i class="fas fa-arrow-${position.position_type === 'long' ? 'up' : 'down'}"></i>
                                        <span>${position.position_type === 'long' ? 'LONG' : 'SHORT'} ${position.leverage_ratio}x</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="pnl-section ${pnlClass}">
                                <div class="pnl-amount">
                                    ${pnlSign}₺${Math.abs(parseFloat(position.unrealized_pnl)).toLocaleString('tr-TR', {minimumFractionDigits: 0})}
                                </div>
                                <div class="pnl-percentage">
                                    ${pnlSign}${pnlPercentage}%
                                </div>
                            </div>
                        </div>
                        
                        <!-- Fiyat Bilgileri -->
                        <div class="price-info-section">
                            <div class="price-row">
                                <span class="price-label">Giriş Fiyatı:</span>
                                <span class="price-value">₺${entryPrice.toLocaleString('tr-TR', {minimumFractionDigits: 0})}</span>
                            </div>
                            <div class="price-row">
                                <span class="price-label">Güncel Fiyat:</span>
                                <span class="price-value ${priceChangeClass}">
                                    ₺${currentPrice.toLocaleString('tr-TR', {minimumFractionDigits: 0})}
                                    <small>(${priceChangePercent >= 0 ? '+' : ''}${priceChangePercent}%)</small>
                                </span>
                            </div>
                            ${liquidationPrice > 0 ? `
                            <div class="price-row liquidation">
                                <span class="price-label">Liquidation:</span>
                                <span class="price-value" style="color: ${riskColor};">₺${liquidationPrice.toLocaleString('tr-TR', {minimumFractionDigits: 0})}</span>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="position-stats">
                            <div class="stat-item">
                                <span class="stat-label">Yatırım</span>
                                <span class="stat-value">₺${parseFloat(position.invested_amount).toLocaleString('tr-TR', {minimumFractionDigits: 0})}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Pozisyon Büyüklüğü</span>
                                <span class="stat-value">${parseFloat(position.position_size || 0).toFixed(6)} ${position.coin_symbol}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Risk Seviyesi</span>
                                <span class="stat-value" style="color: ${riskColor};">${riskText}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Açılış Zamanı</span>
                                <span class="stat-value">${new Date(position.created_at).toLocaleDateString('tr-TR')}</span>
                            </div>
                        </div>
                        
                        <div class="position-chart">
                            <div class="mini-chart-container" id="miniChart_${position.id}_${position.coin_symbol}"></div>
                        </div>
                        
                        <!-- Gelişmiş Pozisyon Kapatma Butonları -->
                        <div class="position-actions-enhanced">
                            <div class="action-buttons-row">
                                <button class="btn-close-position quick-close" 
                                        onclick="quickClosePosition(${position.id}, '${position.coin_symbol}', ${currentPrice}, 'market')"
                                        title="Mevcut piyasa fiyatından hemen kapat">
                                    <i class="fas fa-bolt"></i>
                                    <span>Hızlı Kapat</span>
                                    <small>Piyasa Fiyatı</small>
                                </button>
                                
                                <button class="btn-close-position advanced-close" 
                                        onclick="openAdvancedCloseModal(${position.id}, '${position.coin_symbol}', ${currentPrice}, ${entryPrice}, ${position.leverage_ratio})"
                                        title="Gelişmiş kapatma seçenekleri">
                                    <i class="fas fa-cog"></i>
                                    <span>Gelişmiş Kapat</span>
                                    <small>Limit/Stop</small>
                                </button>
                            </div>
                            
                            <!-- Hızlı Kar Al / Zarar Durdur -->
                            <div class="quick-actions-row">
                                <button class="btn-quick-action take-profit" 
                                        onclick="setQuickTakeProfit(${position.id}, ${currentPrice}, ${position.position_type})"
                                        title="Hızlı kar al emri">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>Kar Al</span>
                                </button>
                                
                                <button class="btn-quick-action stop-loss" 
                                        onclick="setQuickStopLoss(${position.id}, ${currentPrice}, ${position.position_type})"
                                        title="Hızlı zarar durdur emri">
                                    <i class="fas fa-arrow-down"></i>
                                    <span>Zarar Durdur</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            positionsHTML += `
                </div>
            `;

            container.innerHTML = positionsHTML;

            // Küçük candlestick grafiklerini oluştur
            createMiniCandlestickCharts(positions);

            // Candlestick coin listesini güncelle
            updateCandlestickCoinList();
        }

        // Pozisyon istatistiklerini güncelle (DÜZELTME: Doğru hesaplamalar)
        function updatePositionStats(positions) {
            const totalPositions = positions.length;
            const totalInvested = positions.reduce((sum, pos) => sum + parseFloat(pos.invested_amount), 0);
            const totalUnrealizedPnL = positions.reduce((sum, pos) => sum + parseFloat(pos.unrealized_pnl), 0);
            
            // Toplam pozisyon değeri (yatırım + kar/zarar)
            const totalPositionValue = totalInvested + totalUnrealizedPnL;
            
            // Kar/zarar yüzdesi
            const pnlPercentage = totalInvested > 0 ? (totalUnrealizedPnL / totalInvested) * 100 : 0;

            document.getElementById('totalPositions').textContent = totalPositions;
            document.getElementById('totalInvested').textContent = '₺' + totalInvested.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            
            const pnlElement = document.getElementById('totalUnrealizedPnL');
            const pnlSign = totalUnrealizedPnL >= 0 ? '+' : '';
            pnlElement.textContent = pnlSign + '₺' + Math.abs(totalUnrealizedPnL).toLocaleString('tr-TR', {minimumFractionDigits: 2});
            pnlElement.className = 'stat-value ' + (totalUnrealizedPnL >= 0 ? 'positive' : 'negative');

            // Kar/zarar yüzdesini güncelle
            const pnlPercentageElement = document.getElementById('pnlPercentage');
            if (pnlPercentageElement) {
                pnlPercentageElement.textContent = `${pnlSign}${Math.abs(pnlPercentage).toFixed(2)}%`;
                pnlPercentageElement.className = 'stat-change ' + (totalUnrealizedPnL >= 0 ? 'positive' : 'negative');
            }

            // En iyi pozisyonu bul
            if (positions.length > 0) {
                const bestPosition = positions.reduce((best, current) => {
                    const currentPnL = parseFloat(current.unrealized_pnl);
                    const bestPnL = parseFloat(best.unrealized_pnl);
                    return currentPnL > bestPnL ? current : best;
                });
                
                const bestPositionValueElement = document.getElementById('bestPositionValue');
                const bestPositionChangeElement = document.getElementById('bestPositionChange');
                
                if (bestPositionValueElement && bestPositionChangeElement) {
                    bestPositionValueElement.textContent = bestPosition.coin_symbol;
                    const bestPnL = parseFloat(bestPosition.unrealized_pnl);
                    const bestPnLPercentage = parseFloat(bestPosition.pnl_percentage || 0);
                    bestPositionChangeElement.textContent = `${bestPnL >= 0 ? '+' : ''}₺${Math.abs(bestPnL).toLocaleString('tr-TR')} (${bestPnL >= 0 ? '+' : ''}${bestPnLPercentage.toFixed(1)}%)`;
                    bestPositionChangeElement.style.color = bestPnL >= 0 ? '#10b981' : '#ef4444';
                }
            }

            // Pozisyon sayısını nav menüsünde göster
            const positionCount = document.getElementById('positionCount');
            if (totalPositions > 0) {
                positionCount.textContent = totalPositions;
                positionCount.style.display = 'flex';
            } else {
                positionCount.style.display = 'none';
            }
        }

        // Pozisyon kapat
        async function closePosition(positionId, coinSymbol, currentPrice) {
            if (!confirm(`${coinSymbol} pozisyonunu kapatmak istediğinizden emin misiniz?`)) {
                return;
            }

            try {
                const response = await fetch('backend/user/leverage_trading.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        action: 'close_position',
                        position_id: positionId,
                        close_price: currentPrice
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Pozisyon başarıyla kapatıldı! K/Z: ₺${parseFloat(data.pnl).toLocaleString('tr-TR', {minimumFractionDigits: 2})}`, 'success');
                    loadPositions(); // Pozisyonları yenile
                    loadUserInfo(); // Bakiyeyi güncelle
                } else {
                    throw new Error(data.error || 'Pozisyon kapatılamadı');
                }
            } catch (error) {
                console.error('Pozisyon kapatma hatası:', error);
                showNotification('Pozisyon kapatılırken hata oluştu', 'error');
            }
        }

        // Hızlı pozisyon kapatma
        async function quickClosePosition(positionId, coinSymbol, currentPrice, orderType = 'market') {
            console.log(`🚀 Quick close position: ${positionId} - ${coinSymbol} at ${currentPrice}`);
            
            // Onay dialogu
            const confirmMessage = `${coinSymbol} pozisyonunu ${orderType === 'market' ? 'piyasa fiyatından' : 'limit fiyatından'} hemen kapatmak istediğinizden emin misiniz?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                // Loading state göster
                const button = event.target.closest('.btn-close-position');
                if (button) {
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kapatılıyor...';
                    button.disabled = true;
                }

                const response = await fetch('backend/user/leverage_trading.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        action: 'close_position',
                        position_id: positionId,
                        close_price: currentPrice,
                        order_type: orderType
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    const pnl = parseFloat(data.pnl || 0);
                    const pnlText = pnl >= 0 ? `+₺${pnl.toLocaleString('tr-TR')}` : `-₺${Math.abs(pnl).toLocaleString('tr-TR')}`;
                    
                    showNotification(`✅ ${coinSymbol} pozisyonu kapatıldı! K/Z: ${pnlText}`, 'success');
                    
                    // Pozisyonları ve bakiyeyi güncelle
                    await Promise.all([
                        loadPositions(),
                        loadUserInfo()
                    ]);
                    
                } else {
                    throw new Error(data.error || 'Pozisyon kapatılamadı');
                }
            } catch (error) {
                console.error('Hızlı pozisyon kapatma hatası:', error);
                showNotification(`❌ Pozisyon kapatılırken hata: ${error.message}`, 'error');
                
                // Button'ı eski haline getir
                if (button) {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            }
        }

        // Gelişmiş pozisyon kapatma modalı
        function openAdvancedCloseModal(positionId, coinSymbol, currentPrice, entryPrice, leverage) {
            console.log(`🔧 Opening advanced close modal for position ${positionId}`);
            
            // Modal HTML'i oluştur
            const modalHTML = `
                <div id="advancedCloseModal" class="trading-modal-enhanced" style="display: flex;">
                    <div class="modal-overlay" onclick="closeAdvancedCloseModal()"></div>
                    <div class="modal-container-enhanced" style="max-width: 500px;">
                        <div class="modal-header-enhanced">
                            <div class="coin-info">
                                <div class="coin-icon-container">
                                    <i class="fab fa-bitcoin"></i>
                                </div>
                                <div class="coin-details">
                                    <h2>${coinSymbol} Pozisyonu Kapat</h2>
                                    <span>Gelişmiş Kapatma Seçenekleri</span>
                                </div>
                            </div>
                            <button class="close-btn" onclick="closeAdvancedCloseModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="modal-body-enhanced">
                            <!-- Pozisyon Bilgileri -->
                            <div class="position-info-summary">
                                <div class="info-row">
                                    <span>Giriş Fiyatı:</span>
                                    <span>₺${parseFloat(entryPrice).toLocaleString('tr-TR')}</span>
                                </div>
                                <div class="info-row">
                                    <span>Güncel Fiyat:</span>
                                    <span>₺${parseFloat(currentPrice).toLocaleString('tr-TR')}</span>
                                </div>
                                <div class="info-row">
                                    <span>Kaldıraç:</span>
                                    <span>${leverage}x</span>
                                </div>
                            </div>
                            
                            <!-- Kapatma Seçenekleri -->
                            <div class="close-options">
                                <h4>Kapatma Türü Seçin:</h4>
                                
                                <div class="close-option-buttons">
                                    <button class="close-option-btn market-close active" data-type="market">
                                        <i class="fas fa-bolt"></i>
                                        <span>Piyasa Emri</span>
                                        <small>Anında kapat</small>
                                    </button>
                                    
                                    <button class="close-option-btn limit-close" data-type="limit">
                                        <i class="fas fa-target"></i>
                                        <span>Limit Emri</span>
                                        <small>Belirli fiyatta kapat</small>
                                    </button>
                                </div>
                                
                                <!-- Limit Fiyat Input -->
                                <div id="limitPriceSection" style="display: none;">
                                    <label>Limit Fiyatı (₺):</label>
                                    <input type="number" id="limitPrice" placeholder="${currentPrice}" step="0.01" min="0">
                                </div>
                                
                                <!-- Kısmi Kapatma -->
                                <div class="partial-close-section">
                                    <label>
                                        <input type="checkbox" id="partialClose"> Kısmi Kapatma
                                    </label>
                                    <div id="partialCloseOptions" style="display: none;">
                                        <label>Kapatılacak Yüzde (%):</label>
                                        <div class="percentage-buttons">
                                            <button class="percent-btn" data-percent="25">25%</button>
                                            <button class="percent-btn" data-percent="50">50%</button>
                                            <button class="percent-btn" data-percent="75">75%</button>
                                        </div>
                                        <input type="range" id="partialPercentage" min="1" max="100" value="50">
                                        <span id="partialPercentageValue">50%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tahmini Sonuç -->
                            <div class="estimated-result">
                                <h4>Tahmini Sonuç:</h4>
                                <div class="result-row">
                                    <span>Tahmini K/Z:</span>
                                    <span id="estimatedPnL">₺0</span>
                                </div>
                                <div class="result-row">
                                    <span>Komisyon:</span>
                                    <span id="estimatedFee">₺0</span>
                                </div>
                                <div class="result-row total">
                                    <span>Net Tutar:</span>
                                    <span id="netAmount">₺0</span>
                                </div>
                            </div>
                            
                            <!-- Execute Button -->
                            <button id="executeAdvancedClose" class="execute-btn">
                                <i class="fas fa-check"></i>
                                <span>Pozisyonu Kapat</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Modal'ı sayfaya ekle
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Event listener'ları kur
            setupAdvancedCloseModalEvents(positionId, coinSymbol, currentPrice, entryPrice, leverage);
        }

        // Gelişmiş kapatma modal event'leri
        function setupAdvancedCloseModalEvents(positionId, coinSymbol, currentPrice, entryPrice, leverage) {
            // Close option buttons
            document.querySelectorAll('.close-option-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.close-option-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const type = this.dataset.type;
                    const limitSection = document.getElementById('limitPriceSection');
                    
                    if (type === 'limit') {
                        limitSection.style.display = 'block';
                    } else {
                        limitSection.style.display = 'none';
                    }
                    
                    updateEstimatedResult();
                });
            });
            
            // Partial close checkbox
            document.getElementById('partialClose').addEventListener('change', function() {
                const options = document.getElementById('partialCloseOptions');
                options.style.display = this.checked ? 'block' : 'none';
                updateEstimatedResult();
            });
            
            // Percentage buttons
            document.querySelectorAll('.percent-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const percent = parseInt(this.dataset.percent);
                    document.getElementById('partialPercentage').value = percent;
                    document.getElementById('partialPercentageValue').textContent = percent + '%';
                    updateEstimatedResult();
                });
            });
            
            // Percentage slider
            document.getElementById('partialPercentage').addEventListener('input', function() {
                document.getElementById('partialPercentageValue').textContent = this.value + '%';
                updateEstimatedResult();
            });
            
            // Limit price input
            document.getElementById('limitPrice').addEventListener('input', updateEstimatedResult);
            
            // Execute button
            document.getElementById('executeAdvancedClose').addEventListener('click', function() {
                executeAdvancedClose(positionId, coinSymbol, currentPrice, entryPrice, leverage);
            });
            
            // Initial calculation
            updateEstimatedResult();
            
            function updateEstimatedResult() {
                // Bu fonksiyon tahmini sonuçları hesaplar
                const isPartial = document.getElementById('partialClose').checked;
                const percentage = isPartial ? parseInt(document.getElementById('partialPercentage').value) : 100;
                const closeType = document.querySelector('.close-option-btn.active').dataset.type;
                const limitPrice = closeType === 'limit' ? parseFloat(document.getElementById('limitPrice').value) || currentPrice : currentPrice;
                
                // Basit K/Z hesaplama
                const priceChange = limitPrice - entryPrice;
                const pnlPercentage = (priceChange / entryPrice) * leverage;
                const estimatedPnL = 1000 * pnlPercentage * (percentage / 100); // Örnek yatırım tutarı
                const fee = Math.abs(estimatedPnL) * 0.001; // %0.1 komisyon
                const netAmount = estimatedPnL - fee;
                
                document.getElementById('estimatedPnL').textContent = `${estimatedPnL >= 0 ? '+' : ''}₺${Math.abs(estimatedPnL).toLocaleString('tr-TR')}`;
                document.getElementById('estimatedPnL').style.color = estimatedPnL >= 0 ? '#10b981' : '#ef4444';
                document.getElementById('estimatedFee').textContent = `₺${fee.toLocaleString('tr-TR')}`;
                document.getElementById('netAmount').textContent = `${netAmount >= 0 ? '+' : ''}₺${Math.abs(netAmount).toLocaleString('tr-TR')}`;
                document.getElementById('netAmount').style.color = netAmount >= 0 ? '#10b981' : '#ef4444';
            }
        }

        // Gelişmiş kapatma işlemini gerçekleştir
        async function executeAdvancedClose(positionId, coinSymbol, currentPrice, entryPrice, leverage) {
            const closeType = document.querySelector('.close-option-btn.active').dataset.type;
            const isPartial = document.getElementById('partialClose').checked;
            const percentage = isPartial ? parseInt(document.getElementById('partialPercentage').value) : 100;
            const limitPrice = closeType === 'limit' ? parseFloat(document.getElementById('limitPrice').value) : currentPrice;
            
            if (closeType === 'limit' && (!limitPrice || limitPrice <= 0)) {
                showNotification('Geçerli bir limit fiyatı girin', 'error');
                return;
            }
            
            try {
                const response = await fetch('backend/user/leverage_trading.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        action: 'close_position',
                        position_id: positionId,
                        close_type: closeType,
                        close_price: limitPrice,
                        partial_percentage: percentage
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    const pnl = parseFloat(data.pnl || 0);
                    const pnlText = pnl >= 0 ? `+₺${pnl.toLocaleString('tr-TR')}` : `-₺${Math.abs(pnl).toLocaleString('tr-TR')}`;
                    
                    showNotification(`✅ ${coinSymbol} pozisyonu ${closeType === 'limit' ? 'limit emri ile' : 'piyasa fiyatından'} kapatıldı! K/Z: ${pnlText}`, 'success');
                    
                    closeAdvancedCloseModal();
                    
                    // Pozisyonları ve bakiyeyi güncelle
                    await Promise.all([
                        loadPositions(),
                        loadUserInfo()
                    ]);
                    
                } else {
                    throw new Error(data.error || 'Pozisyon kapatılamadı');
                }
            } catch (error) {
                console.error('Gelişmiş pozisyon kapatma hatası:', error);
                showNotification(`❌ Pozisyon kapatılırken hata: ${error.message}`, 'error');
            }
        }

        // Gelişmiş kapatma modalını kapat
        function closeAdvancedCloseModal() {
            const modal = document.getElementById('advancedCloseModal');
            if (modal) {
                modal.remove();
            }
        }

        // Hızlı kar al emri
        function setQuickTakeProfit(positionId, currentPrice, positionType) {
            const profitPercentage = 10; // %10 kar hedefi
            let targetPrice;
            
            if (positionType === 'long') {
                targetPrice = currentPrice * 1.1; // %10 yukarı
            } else {
                targetPrice = currentPrice * 0.9; // %10 aşağı
            }
            
            const confirmMessage = `${profitPercentage}% kar hedefi ile kar al emri oluşturulsun mu?\nHedef fiyat: ₺${targetPrice.toLocaleString('tr-TR')}`;
            
            if (confirm(confirmMessage)) {
                createTakeProfitOrder(positionId, targetPrice);
            }
        }

        // Hızlı zarar durdur emri
        function setQuickStopLoss(positionId, currentPrice, positionType) {
            const stopPercentage = 5; // %5 zarar durdur
            let stopPrice;
            
            if (positionType === 'long') {
                stopPrice = currentPrice * 0.95; // %5 aşağı
            } else {
                stopPrice = currentPrice * 1.05; // %5 yukarı
            }
            
            const confirmMessage = `${stopPercentage}% zarar durdur emri oluşturulsun mu?\nStop fiyat: ₺${stopPrice.toLocaleString('tr-TR')}`;
            
            if (confirm(confirmMessage)) {
                createStopLossOrder(positionId, stopPrice);
            }
        }

        // Kar al emri oluştur
        async function createTakeProfitOrder(positionId, targetPrice) {
            try {
                const response = await fetch('backend/user/leverage_trading.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        action: 'create_take_profit',
                        position_id: positionId,
                        target_price: targetPrice
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showNotification(`✅ Kar al emri oluşturuldu! Hedef: ₺${targetPrice.toLocaleString('tr-TR')}`, 'success');
                } else {
                    throw new Error(data.error || 'Kar al emri oluşturulamadı');
                }
            } catch (error) {
                console.error('Kar al emri hatası:', error);
                showNotification(`❌ Kar al emri oluşturulamadı: ${error.message}`, 'error');
            }
        }

        // Zarar durdur emri oluştur
        async function createStopLossOrder(positionId, stopPrice) {
            try {
                const response = await fetch('backend/user/leverage_trading.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        action: 'create_stop_loss',
                        position_id: positionId,
                        stop_price: stopPrice
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showNotification(`✅ Zarar durdur emri oluşturuldu! Stop: ₺${stopPrice.toLocaleString('tr-TR')}`, 'success');
                } else {
                    throw new Error(data.error || 'Zarar durdur emri oluşturulamadı');
                }
            } catch (error) {
                console.error('Zarar durdur emri hatası:', error);
                showNotification(`❌ Zarar durdur emri oluşturulamadı: ${error.message}`, 'error');
            }
        }

        // Global positions view state
        let currentPositionsView = 'cards';
        
        // Pozisyonlar görünüm değiştirme
        function togglePositionsView(view) {
            currentPositionsView = view;
            const cardsContainer = document.getElementById('positionsCards');
            const tableContainer = document.getElementById('positionsTable');
            const cardViewBtn = document.getElementById('positionsCardViewBtn');
            const tableViewBtn = document.getElementById('positionsTableViewBtn');
            
            if (view === 'cards') {
                cardsContainer.style.display = 'grid';
                tableContainer.style.display = 'none';
                cardViewBtn.classList.add('active');
                tableViewBtn.classList.remove('active');
            } else {
                cardsContainer.style.display = 'none';
                tableContainer.style.display = 'block';
                cardViewBtn.classList.remove('active');
                tableViewBtn.classList.add('active');
            }
        }
        
        // Pozisyonları yenile
        async function refreshPositions() {
            const loader = document.getElementById('positionsLoader');
            const cardsContainer = document.getElementById('positionsCards');
            const tableContainer = document.getElementById('positionsTable');
            const emptyState = document.getElementById('positionsEmpty');
            
            // Loading state göster
            loader.style.display = 'block';
            cardsContainer.style.display = 'none';
            tableContainer.style.display = 'none';
            emptyState.style.display = 'none';
            
            await loadPositions();
        }

        // Pozisyon geçmişi yükle
        async function loadPositionHistory() {
            const loader = document.getElementById('historyLoader');
            const empty = document.getElementById('historyEmpty');
            const items = document.getElementById('historyItems');
            
            // Loading state göster
            loader.style.display = 'block';
            empty.style.display = 'none';
            items.innerHTML = '';
            
            try {
                const response = await fetch('backend/user/leverage_trading.php?action=history', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const result = await response.json();
                console.log('✅ Position History loaded:', result);
                
                if (result.success && result.data && result.data.length > 0) {
                    displayPositionHistory(result.data);
                } else {
                    // Geçmiş boş - test verisi ekle
                    const testHistory = [
                        {
                            id: 1,
                            coin_symbol: 'BTC',
                            position_type: 'long',
                            leverage_ratio: 10,
                            entry_price: 45000,
                            close_price: 47000,
                            invested_amount: 1000,
                            realized_pnl: 444.44,
                            pnl_percentage: 44.44,
                            open_time: '2024-01-15 10:30:00',
                            close_time: '2024-01-15 15:45:00'
                        },
                        {
                            id: 2,
                            coin_symbol: 'ETH',
                            position_type: 'short',
                            leverage_ratio: 5,
                            entry_price: 2800,
                            close_price: 2750,
                            invested_amount: 500,
                            realized_pnl: 89.29,
                            pnl_percentage: 17.86,
                            open_time: '2024-01-14 09:15:00',
                            close_time: '2024-01-14 16:20:00'
                        },
                        {
                            id: 3,
                            coin_symbol: 'BTC',
                            position_type: 'long',
                            leverage_ratio: 20,
                            entry_price: 46000,
                            close_price: 44500,
                            invested_amount: 800,
                            realized_pnl: -652.17,
                            pnl_percentage: -81.52,
                            open_time: '2024-01-13 14:20:00',
                            close_time: '2024-01-13 18:10:00'
                        }
                    ];
                    displayPositionHistory(testHistory);
                }
                
            } catch (error) {
                console.error('Position history loading error:', error);
                loader.style.display = 'none';
                empty.style.display = 'block';
            }
        }
        
        // Pozisyon geçmişini göster
        function displayPositionHistory(history) {
            const loader = document.getElementById('historyLoader');
            const empty = document.getElementById('historyEmpty');
            const items = document.getElementById('historyItems');
            
            // Loading'i gizle
            loader.style.display = 'none';
            
            if (!history || history.length === 0) {
                empty.style.display = 'block';
                return;
            }
            
            // Özet istatistikleri hesapla
            updateHistorySummary(history);
            
            // Geçmiş öğelerini oluştur
            items.innerHTML = '';
            
            history.forEach(item => {
                const pnlClass = parseFloat(item.realized_pnl) >= 0 ? 'profitable' : 'loss';
                const pnlColor = parseFloat(item.realized_pnl) >= 0 ? 'positive' : 'negative';
                const pnlSign = parseFloat(item.realized_pnl) >= 0 ? '+' : '';
                
                const historyItem = document.createElement('div');
                historyItem.className = `history-item ${pnlClass}`;
                historyItem.innerHTML = `
                    <div class="history-item-header">
                        <div class="history-item-left">
                            <div class="history-coin-icon">
                                ${item.coin_symbol.charAt(0)}
                            </div>
                            <div class="history-coin-details">
                                <h5>${item.coin_symbol}</h5>
                                <div class="history-position-type ${item.position_type}">
                                    <i class="fas fa-arrow-${item.position_type === 'long' ? 'up' : 'down'}"></i>
                                    ${item.position_type.toUpperCase()} ${item.leverage_ratio}x
                                </div>
                            </div>
                        </div>
                        <div class="history-item-right">
                            <div class="history-pnl ${pnlColor}">
                                ${pnlSign}₺${Math.abs(parseFloat(item.realized_pnl)).toLocaleString('tr-TR', {minimumFractionDigits: 2})}
                            </div>
                            <div class="history-date">
                                ${new Date(item.close_time).toLocaleDateString('tr-TR')} 
                                ${new Date(item.close_time).toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'})}
                            </div>
                        </div>
                    </div>
                    
                    <div class="history-item-details">
                        <div class="history-detail">
                            <div class="history-detail-label">Giriş Fiyat</div>
                            <div class="history-detail-value">₺${parseFloat(item.entry_price).toLocaleString('tr-TR')}</div>
                        </div>
                        <div class="history-detail">
                            <div class="history-detail-label">Çıkış Fiyat</div>
                            <div class="history-detail-value">₺${parseFloat(item.close_price).toLocaleString('tr-TR')}</div>
                        </div>
                        <div class="history-detail">
                            <div class="history-detail-label">Yatırım</div>
                            <div class="history-detail-value">₺${parseFloat(item.invested_amount).toLocaleString('tr-TR')}</div>
                        </div>
                        <div class="history-detail">
                            <div class="history-detail-label">Süre</div>
                            <div class="history-detail-value">${calculateDuration(item.open_time, item.close_time)}</div>
                        </div>
                        <div class="history-detail">
                            <div class="history-detail-label">K/Z %</div>
                            <div class="history-detail-value" style="color: ${parseFloat(item.realized_pnl) >= 0 ? '#10b981' : '#ef4444'}">
                                ${pnlSign}${Math.abs(parseFloat(item.pnl_percentage)).toFixed(2)}%
                            </div>
                        </div>
                    </div>
                `;
                
                items.appendChild(historyItem);
            });
            
            // Filter butonları için event listener ekle
            setupHistoryFilters(history);
        }
        
        // Geçmiş özet istatistiklerini güncelle
        function updateHistorySummary(history) {
            const totalTrades = history.length;
            const profitableTrades = history.filter(item => parseFloat(item.realized_pnl) >= 0).length;
            const winRate = totalTrades > 0 ? (profitableTrades / totalTrades) * 100 : 0;
            const totalPnL = history.reduce((sum, item) => sum + parseFloat(item.realized_pnl), 0);
            const avgPnL = totalTrades > 0 ? totalPnL / totalTrades : 0;
            
            document.getElementById('totalTrades').textContent = totalTrades;
            document.getElementById('winRate').textContent = `${winRate.toFixed(1)}%`;
            
            const totalPnLElement = document.getElementById('totalHistoryPnL');
            totalPnLElement.textContent = `${totalPnL >= 0 ? '+' : ''}₺${Math.abs(totalPnL).toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            totalPnLElement.style.color = totalPnL >= 0 ? '#10b981' : '#ef4444';
            
            const avgPnLElement = document.getElementById('avgPnL');
            avgPnLElement.textContent = `${avgPnL >= 0 ? '+' : ''}₺${Math.abs(avgPnL).toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            avgPnLElement.style.color = avgPnL >= 0 ? '#10b981' : '#ef4444';
        }
        
        // Süre hesaplama fonksiyonu
        function calculateDuration(openTime, closeTime) {
            const start = new Date(openTime);
            const end = new Date(closeTime);
            const diffMs = end - start;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            
            if (diffHours > 0) {
                return `${diffHours}s ${diffMinutes}d`;
            } else {
                return `${diffMinutes}d`;
            }
        }
        
        // Geçmiş filtreleme sistemi
        function setupHistoryFilters(allHistory) {
            const filterButtons = document.querySelectorAll('.history-filter-btn');
            
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Aktif button güncelle
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    // Filtrelenmiş geçmişi göster
                    const filter = button.dataset.filter;
                    let filteredHistory = allHistory;
                    
                    if (filter === 'profitable') {
                        filteredHistory = allHistory.filter(item => parseFloat(item.realized_pnl) >= 0);
                    } else if (filter === 'loss') {
                        filteredHistory = allHistory.filter(item => parseFloat(item.realized_pnl) < 0);
                    }
                    
                    displayFilteredHistory(filteredHistory);
                });
            });
        }
        
        // Filtrelenmiş geçmişi göster
        function displayFilteredHistory(history) {
            const items = document.getElementById('historyItems');
            const empty = document.getElementById('historyEmpty');
            
            if (history.length === 0) {
                items.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            
            empty.style.display = 'none';
            items.innerHTML = '';
            
            history.forEach(item => {
                const pnlClass = parseFloat(item.realized_pnl) >= 0 ? 'profitable' : 'loss';
                const pnlColor = parseFloat(item.realized_pnl) >= 0 ? 'positive' : 'negative';
                const pnlSign = parseFloat(item.realized_pnl) >= 0 ? '+' : '';
                
                const historyItem = document.createElement('div');
                historyItem.className = `history-item ${pnlClass}`;
                historyItem.innerHTML = `
                    <div class="history-item-header">
                        <div class="history-item-left">
                            <div class="history-coin-icon">
                                ${item.coin_symbol.charAt(0)}
                            </div>
                            <div class="history-coin-details">
                                <h5>${item.coin_symbol}</h5>
                                <div class="history-position-type ${item.position_type}">
                                    <i class="fas fa-arrow-${item.position_type === 'long' ? 'up' : 'down'}"></i>
                                    ${item.position_type.toUpperCase()} ${item.leverage_ratio}x
                                </div>
                            </div>
                        </div>
                        <div class="history-item-right">
                            <div class="history-pnl ${pnlColor}">
                                ${pnlSign}₺${Math.abs(parseFloat(item.realized_pnl)).toLocaleString('tr-TR', {minimumFractionDigits: 2})}
                            </div>
                            <div class="history-date">
                                ${new Date(item.close_time).toLocaleDateString('tr-TR')} 
                                ${new Date(item.close_time).toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'})}
                            </div>
                        </div>
                    </div>
                    
                    <div class="history-item-details">
                        <div class="history-detail">
                            <div class="history-detail-label">Giriş Fiyat</div>
                            <div class="history-detail-value">₺${parseFloat(item.entry_price).toLocaleString('tr-TR')}</div>
                        </div>
                        <div class="history-detail">
                            <div class="history-detail-label">Çıkış Fiyat</div>
                            <div class="history-detail-value">₺${parseFloat(item.close_price).toLocaleString('tr-TR')}</div>
                        </div>
                        <div class="history-detail">
                            <div class="history-detail-label">Yatırım</div>
                            <div class="history-detail-value">₺${parseFloat(item.invested_amount).toLocaleString('tr-TR')}</div>
                        </div>
                        <div class="history-detail">
                            <div class="history-detail-label">Süre</div>
                            <div class="history-detail-value">${calculateDuration(item.open_time, item.close_time)}</div>
                        </div>
                        <div class="history-detail">
                            <div class="history-detail-label">K/Z %</div>
                            <div class="history-detail-value" style="color: ${parseFloat(item.realized_pnl) >= 0 ? '#10b981' : '#ef4444'}">
                                ${pnlSign}${Math.abs(parseFloat(item.pnl_percentage)).toFixed(2)}%
                            </div>
                        </div>
                    </div>
                `;
                
                items.appendChild(historyItem);
            });
        }
        
        // Real-time pozisyon fiyat güncellemesi
        async function updatePositionPrices() {
            try {
                // Mevcut coin fiyatlarını al
                const response = await fetch('backend/user/coins.php?action=all', {
                    credentials: 'include'
                });
                const coinsData = await response.json();
                
                if (coinsData.success && coinsData.coins) {
                    const prices = {};
                    coinsData.coins.forEach(coin => {
                        prices[coin.symbol] = coin.current_price;
                    });
                    
                    // Backend'e fiyat güncellemesi gönder
                    const updateResponse = await fetch('backend/user/leverage_trading.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            action: 'update_prices',
                            prices: prices
                        })
                    });
                    
                    const updateData = await updateResponse.json();
                    if (updateData.success) {
                        // Pozisyonları yenile
                        await loadPositions();
                    }
                }
            } catch (error) {
                console.error('Fiyat güncelleme hatası:', error);
            }
        }

        // Otomatik fiyat güncellemesi (30 saniyede bir)
        let priceUpdateInterval;
        function startPriceUpdates() {
            // Önceki interval'i temizle
            if (priceUpdateInterval) {
                clearInterval(priceUpdateInterval);
            }
            
            // İlk güncellemeyi hemen yap
            updatePositionPrices();
            
            // 30 saniyede bir güncelle
            priceUpdateInterval = setInterval(updatePositionPrices, 30000);
        }

        function stopPriceUpdates() {
            if (priceUpdateInterval) {
                clearInterval(priceUpdateInterval);
                priceUpdateInterval = null;
            }
        }

        // Pozisyonların otomatik yenilenmesi için sayfa yüklendiğinde başlat
        document.addEventListener('DOMContentLoaded', function() {
            // Eğer sayfa yüklendiğinde pozisyonlar sekmesi aktifse fiyat güncellemesini başlat
            const activeSection = document.querySelector('.nav-link.active')?.dataset?.section;
            if (activeSection === 'positions') {
                startPriceUpdates();
            }
        });

        // Kaldıraçlı işlem yap
        async function executeLeverageOrder(orderData) {
            console.log('🚀 ExecuteLeverageOrder çağrıldı:', orderData);
            console.log('📊 Mevcut parametreler:', {
                currentPositionType,
                currentLeverage,
                currentLeverageMode
            });
            
            try {
                const requestData = {
                    action: 'open_position',
                    coin_symbol: orderData.coin_symbol,
                    position_type: currentPositionType,
                    leverage_ratio: currentLeverage,
                    invested_amount: orderData.invested_amount,
                    entry_price: orderData.entry_price
                };
                
                console.log('📤 API isteği gönderiliyor:', requestData);
                
                const response = await fetch('backend/user/leverage_trading.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include', // Session cookies için
                    body: JSON.stringify(requestData)
                });

                console.log('📥 API yanıtı alındı:', response.status, response.statusText);
                
                // Response içeriğini önce text olarak alalım
                const responseText = await response.text();
                console.log('📄 Raw response:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log('📋 API verisi:', data);
                } catch (parseError) {
                    console.error('❌ JSON Parse Error:', parseError);
                    console.error('📄 Full Response content:', responseText);
                    console.error('📏 Response length:', responseText.length);
                    console.error('🔤 First 100 chars:', JSON.stringify(responseText.substring(0, 100)));
                    console.error('🔤 Last 100 chars:', JSON.stringify(responseText.substring(responseText.length - 100)));
                    throw new Error('Server response is not valid JSON');
                }
                
                if (data.success) {
                    showNotification(`Kaldıraçlı pozisyon açıldı! Pozisyon ID: ${data.position_id}`, 'success');
                    closeTradingModal();
                    loadUserInfo(); // Bakiyeyi güncelle
                    loadPositions(); // Pozisyonları güncelle
                } else {
                    console.error('❌ API hatası:', data.error);
                    throw new Error(data.error || 'Pozisyon açılamadı');
                }
            } catch (error) {
                console.error('💥 Kaldıraçlı işlem hatası:', error);
                showNotification(`Hata: ${error.message}`, 'error');
            }
        }

        // Session kontrolü
        async function checkAuthSession() {
            try {
                const response = await fetch('backend/public/profile.php', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success && data.user) {
                    console.log('🔐 Session aktif:', data.user.username);
                    return true;
                } else {
                    console.warn('⚠️ Session bulunamadı - giriş yapın!');
                    return false;
                }
            } catch (error) {
                console.error('Session kontrol hatası:', error);
                return false;
            }
        }


            


        // Global test fonksiyonları
        window.testLightweightCharts = testLightweightCharts;

        // Pozisyonlardan coin listesini al ve candlestick dropdown'ını güncelle
        function updateCandlestickCoinList() {
            // Pozisyonlardan coin listesini al
            const positions = window.currentPositions || [];
            const coins = new Set();

            positions.forEach(position => {
                coins.add(position.coin_symbol);
            });

            console.log(`📊 Candlestick için ${coins.size} coin bulundu: ${Array.from(coins).join(', ')}`);
        }

        // Küçük candlestick grafikleri oluştur
        function createMiniCandlestickCharts(positions) {
            if (typeof LightweightCharts === 'undefined') {
                console.log('⏳ LightweightCharts yükleniyor, mini grafikler için bekleniyor...');
                setTimeout(() => createMiniCandlestickCharts(positions), 1000);
                return;
            }

            // Her pozisyon için küçük grafik oluştur
            positions.forEach(position => {
                const chartContainer = document.getElementById(`miniChart_${position.id}_${position.coin_symbol}`);
                if (!chartContainer) return;

                try {
                    // Mevcut grafik varsa kaldır
                    if (chartContainer.chart) {
                        chartContainer.chart.remove();
                    }

                    // Küçük grafik oluştur
                    const chart = LightweightCharts.createChart(chartContainer, {
                        width: 120,
                        height: 60,
                        layout: {
                            background: { type: 'solid', color: 'transparent' },
                            textColor: '#ffffff',
                        },
                        grid: {
                            vertLines: { color: 'rgba(255, 255, 255, 0.1)' },
                            horzLines: { color: 'rgba(255, 255, 255, 0.1)' },
                        },
                        crosshair: {
                            mode: LightweightCharts.CrosshairMode.Normal,
                        },
                        rightPriceScale: {
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            visible: false,
                        },
                        timeScale: {
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            visible: false,
                        },
                    });

                    // Candlestick serisi ekle
                    const candlestickSeries = chart.addCandlestickSeries({
                        upColor: '#10b981',
                        downColor: '#ef4444',
                        borderVisible: false,
                        wickUpColor: '#10b981',
                        wickDownColor: '#ef4444',
                    });

                    // Mini grafik verisi oluştur (son 20 veri)
                    const miniData = generateMiniCandlestickData(position.coin_symbol, 20);
                    candlestickSeries.setData(miniData);

                    // Grafik referansını sakla
                    chartContainer.chart = chart;
                    chartContainer.series = candlestickSeries;

                    console.log(`✅ Mini candlestick grafiği oluşturuldu: ${position.coin_symbol}`);

                } catch (error) {
                    console.error(`❌ Mini grafik oluşturma hatası (${position.coin_symbol}):`, error);
                }
            });
        }

        // Mini candlestick verisi oluştur
        function generateMiniCandlestickData(coinSymbol, count = 20) {
            const data = [];
            const basePrice = getBasePriceForCoin(coinSymbol);
            const volatility = 0.02; // %2 volatilite

            for (let i = 0; i < count; i++) {
                const time = Math.floor(Date.now() / 1000) - (count - i) * 3600; // Her saat
                const open = basePrice * (1 + (Math.random() - 0.5) * volatility);
                const high = open * (1 + Math.random() * volatility);
                const low = open * (1 - Math.random() * volatility);
                const close = (open + high + low) / 3 + (Math.random() - 0.5) * volatility * basePrice;

                data.push({
                    time: time,
                    open: open,
                    high: high,
                    low: low,
                    close: close
                });
            }

            return data;
        }

        // Coin için base price belirle
        function getBasePriceForCoin(coinSymbol) {
            const basePrices = {
                'BTC': 1350000,
                'ETH': 85000,
                'BNB': 4500,
                'ADA': 2.5,
                'DOT': 45,
                'LINK': 85,
                'LTC': 1200,
                'BCH': 8500,
                'XRP': 3.2,
                'DOGE': 0.15
            };
            return basePrices[coinSymbol] || 1000;
        }

        // Test fonksiyonu - LightweightCharts durumunu kontrol et
        function testLightweightCharts() {
            console.log('🔍 LightweightCharts durumu:');
            console.log('- typeof LightweightCharts:', typeof LightweightCharts);
            console.log('- LightweightCharts object:', LightweightCharts);
            
            if (typeof LightweightCharts !== 'undefined') {
                console.log('✅ LightweightCharts yüklendi!');
                console.log('- createChart method:', typeof LightweightCharts.createChart);
            } else {
                console.log('❌ LightweightCharts yüklenmedi!');
            }
        }

        // Sayfa yüklendiğinde kaldıraç sistemini başlat
        document.addEventListener('DOMContentLoaded', function() {
            initTradingModal();
            checkAuthSession();
            
            // Portföy-Piyasalar entegrasyonu için event listener'lar ekle
            setupPortfolioIntegration();
        });
        
        // Portföy ve piyasalar arasındaki entegrasyonu kur
        function setupPortfolioIntegration() {
            // Portfolio ekranı aktif olduğunda otomatik yenile
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    if (section === 'portfolio') {
                        setTimeout(() => {
                            loadPortfolio();
                        }, 300);
                    }
                });
            });
        }
        
        // Check if portfolio screen is active
        function isPortfolioScreenActive() {
            const activeSection = document.querySelector('.content-section.active');
            return activeSection && activeSection.id === 'portfolio';
        }
        
        // Enhanced coin trade function with portfolio integration
        async function executeCoinTrade(type, coinId, coinName, coinCode, amount, price) {
            try {
                const response = await fetch(`backend/user/trading.php?action=${type}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        coin_id: coinId,
                        miktar: amount,
                        fiyat: price
                    })
                });
                
                const result = await response.json();
                console.log(`${type} işlem sonucu:`, result);
                
                if (result.success) {
                    const actionText = type === 'buy' ? 'satın alındı' : 'satıldı';
                    showNotification(`${amount} ${coinCode} başarıyla ${actionText}!`, 'success');
                    
                    // Close modal if exists
                    if (typeof closeTradingModal === 'function') {
                        closeTradingModal();
                    }
                    
                    // Update balance
                    loadUserInfo();
                    
                    // Update portfolio if on portfolio screen
                    if (isPortfolioScreenActive()) {
                        console.log('Portfolio ekranı aktif, güncelleniyor...');
                        setTimeout(() => {
                            loadPortfolio();
                        }, 500);
                    }
                    
                    // Update coin list
                    setTimeout(() => {
                        loadCoins();
                    }, 300);
                    
                    return result;
                } else {
                    throw new Error(result.message || `${type} işlemi başarısız!`);
                }
            } catch (error) {
                console.error(`${type} error:`, error);
                showNotification(error.message || 'Bir hata oluştu!', 'error');
                throw error;
            }
        }
        
        // Quick buy function for portfolio integration
        async function quickBuyCoin(coinId, coinCode, currentPrice, amount = 0.001) {
            return await executeCoinTrade('buy', coinId, coinCode, coinCode, amount, currentPrice);
        }
        
        // Quick sell function for portfolio integration  
        async function quickSellCoin(coinId, coinCode, currentPrice, amount) {
            return await executeCoinTrade('sell', coinId, coinCode, coinCode, amount, currentPrice);
        }
        
        // Auto-refresh portfolio when coins are bought/sold
        function enablePortfolioAutoRefresh() {
            // Portfolio ekranında 30 saniyede bir otomatik güncelle
            let portfolioRefreshInterval;
            
            function startPortfolioRefresh() {
                portfolioRefreshInterval = setInterval(() => {
                    if (isPortfolioScreenActive()) {
                        loadPortfolio();
                    }
                }, 30000); // 30 saniye
            }
            
            function stopPortfolioRefresh() {
                if (portfolioRefreshInterval) {
                    clearInterval(portfolioRefreshInterval);
                    portfolioRefreshInterval = null;
                }
            }
            
            // Sayfa görünürlüğü değiştiğinde refresh'i kontrol et
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    stopPortfolioRefresh();
                } else if (isPortfolioScreenActive()) {
                    startPortfolioRefresh();
                }
            });
            
            // İlk başlatma
            if (isPortfolioScreenActive()) {
                startPortfolioRefresh();
            }
        }
        
        // DÜZELTME: Portföy varlık satış fonksiyonu - Geliştirilmiş satış işlemi
        async function portfolioSellAsset(coinId, coinName, coinCode, availableAmount) {
            console.log(`🔄 ENHANCED Selling portfolio asset: ${coinCode}`, {coinId, availableAmount});
            
            // Miktar kontrolü - hassas floating point karşılaştırması
            const sellAmount = parseFloat(availableAmount);
            if (sellAmount <= 0.00000001) {
                showNotification(`❌ Satış için yeterli ${coinCode} miktarı yok`, 'error');
                return;
            }
            
            // Gelişmiş onay dialogu
            const confirmMessage = `${coinName} (${coinCode}) satış işlemi:\n\n` +
                                 `• Satılacak Miktar: ${sellAmount.toFixed(8)} ${coinCode}\n` +
                                 `• İşlem: Piyasa fiyatından anında satış\n\n` +
                                 `Bu işlemi onaylıyor musunuz?`;
            
            if (!confirm(confirmMessage)) {
                console.log('❌ Sell cancelled by user');
                return;
            }
            
            // Loading state göster
            const sellButton = event?.target;
            let originalButtonText = '';
            if (sellButton) {
                originalButtonText = sellButton.innerHTML;
                sellButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Satılıyor...';
                sellButton.disabled = true;
            }
            
            try {
                // DÜZELTME: Hassas miktar gönderimi
                const formData = new FormData();
                formData.append('coin_id', coinId);
                formData.append('miktar', sellAmount.toFixed(8)); // 8 ondalık hassasiyet
                formData.append('fiyat', 0); // 0 = Güncel piyasa fiyatını kullan
                
                console.log('📤 ENHANCED Sending sell request:', {
                    coin_id: coinId,
                    miktar: sellAmount.toFixed(8),
                    fiyat: 0,
                    coin_code: coinCode,
                    available_amount: availableAmount,
                    sell_amount_formatted: sellAmount.toFixed(8)
                });
                
                const response = await fetch('backend/user/trading.php?action=sell', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                console.log('📥 Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
                }
                
                const responseText = await response.text();
                console.log('📄 Raw response length:', responseText.length);
                console.log('📄 Raw response preview:', responseText.substring(0, 200));
                
                // JSON parse kontrolü
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('❌ JSON Parse Error:', parseError);
                    console.error('📄 Full response content:', responseText);
                    
                    // HTML response kontrolü
                    if (responseText.includes('<html>') || responseText.includes('<!DOCTYPE')) {
                        throw new Error('Server returned HTML instead of JSON (likely a PHP error)');
                    }
                    
                    throw new Error(`Invalid JSON response: ${parseError.message}`);
                }
                
                console.log('📈 ENHANCED Sell response:', result);
                
                if (result.success) {
                    // Başarılı satış - detaylı bildirim
                    const soldAmount = result.data?.miktar || sellAmount;
                    const totalAmount = result.data?.net_tutar || result.data?.toplam_tutar || 0;
                    const commission = result.data?.komisyon || 0;
                    
                    let successMessage = `✅ ${parseFloat(soldAmount).toFixed(6)} ${coinCode} başarıyla satıldı!`;
                    
                    if (totalAmount > 0) {
                        successMessage += `\n💰 Net Tutar: ₺${parseFloat(totalAmount).toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
                    }
                    
                    if (commission > 0) {
                        successMessage += `\n📊 Komisyon: ₺${parseFloat(commission).toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
                    }
                    
                    showNotification(successMessage, 'success');
                    
                    // Kullanıcı bilgilerini güncelle
                    loadUserInfo();
                    
                    // Portföyü yeniden yükle
                    setTimeout(() => {
                        loadPortfolio();
                    }, 500);
                    
                } else {
                    // Hata durumu - detaylı hata mesajı
                    const errorMessage = result.message || 'Bilinmeyen satış hatası';
                    console.error('❌ Sell failed:', errorMessage);
                    
                    // Hata türüne göre özel mesajlar
                    let userMessage = `❌ Satış Hatası: ${errorMessage}`;
                    
                    if (errorMessage.includes('Yetersiz coin miktarı')) {
                        userMessage = `❌ Yetersiz ${coinCode} miktarı. Portföyünüzü kontrol edin.`;
                    } else if (errorMessage.includes('Coin bulunamadı')) {
                        userMessage = `❌ ${coinCode} coin'i bulunamadı veya aktif değil.`;
                    } else if (errorMessage.includes('Geçersiz fiyat')) {
                        userMessage = `❌ Fiyat bilgisi alınamadı. Lütfen tekrar deneyin.`;
                    }
                    
                    showNotification(userMessage, 'error');
                    
                    // Debug bilgisi göster (geliştirme modunda)
                    if (result.debug) {
                        console.error('🔍 Debug info:', result.debug);
                    }
                }
                
            } catch (error) {
                console.error('❌ Enhanced sell error:', error);
                
                // Hata türüne göre kullanıcı dostu mesajlar
                let errorMessage = 'Satış işlemi sırasında hata oluştu';
                
                if (error.message.includes('Network')) {
                    errorMessage = 'Bağlantı hatası. İnternet bağlantınızı kontrol edin.';
                } else if (error.message.includes('HTML instead of JSON')) {
                    errorMessage = 'Sunucu hatası oluştu. Lütfen daha sonra tekrar deneyin.';
                } else if (error.message.includes('HTTP Error: 500')) {
                    errorMessage = 'Sunucu iç hatası. Lütfen sistem yöneticisi ile iletişime geçin.';
                } else if (error.message.includes('HTTP Error: 401')) {
                    errorMessage = 'Oturum süreniz dolmuş. Lütfen tekrar giriş yapın.';
                } else {
                    errorMessage = `Hata: ${error.message}`;
                }
                
                showNotification(`❌ ${errorMessage}`, 'error');
                
            } finally {
                // Loading state'i kaldır
                if (sellButton && originalButtonText) {
                    sellButton.innerHTML = originalButtonText;
                    sellButton.disabled = false;
                }
            }
        }

        // Navigate from portfolio to markets and highlight specific coin
        function navigateToMarkets(coinCode) {
            console.log(`🔄 Navigating to markets for ${coinCode}`);
            
            // Switch to markets section
            switchSection('markets');
            
            // Wait for the markets section to load, then highlight the coin
            setTimeout(() => {
                highlightCoinInMarkets(coinCode);
            }, 500);
        }
        
        // Highlight specific coin in markets
        function highlightCoinInMarkets(coinCode) {
            // Desktop coin cards
            const desktopCards = document.querySelectorAll('.desktop-coin-card');
            desktopCards.forEach(card => {
                const coinSymbol = card.querySelector('.coin-symbol');
                if (coinSymbol && coinSymbol.textContent === coinCode) {
                    card.style.border = '2px solid #4fc3f7';
                    card.style.transform = 'scale(1.02)';
                    card.style.boxShadow = '0 8px 25px rgba(79, 195, 247, 0.4)';
                    
                    // Scroll to the card
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Remove highlight after 3 seconds
                    setTimeout(() => {
                        card.style.border = '';
                        card.style.transform = '';
                        card.style.boxShadow = '';
                    }, 3000);
                }
            });
            
            // Mobile coin cards
            const mobileCards = document.querySelectorAll('.mobile-coin-card');
            mobileCards.forEach(card => {
                const coinSymbol = card.querySelector('.coin-symbol');
                if (coinSymbol && coinSymbol.textContent === coinCode) {
                    card.style.border = '2px solid #4fc3f7';
                    card.style.boxShadow = '0 8px 25px rgba(79, 195, 247, 0.4)';
                    
                    // Scroll to the card
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Remove highlight after 3 seconds
                    setTimeout(() => {
                        card.style.border = '';
                        card.style.boxShadow = '';
                    }, 3000);
                }
            });
        }
        
        
        // Database setup function for missing tables
        async function setupDatabase() {
            try {
                showNotification('Veritabanı kurulumu başlatılıyor...', 'info');
                
                const response = await fetch('backend/setup_database.php', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Veritabanı başarıyla kuruldu!', 'success');
                    setTimeout(() => {
                        loadPortfolio();
                    }, 2000);
                } else {
                    throw new Error(result.message || 'Veritabanı kurulumu başarısız');
                }
            } catch (error) {
                console.error('Database setup error:', error);
                showNotification('Veritabanı kurulumu başarısız: ' + error.message, 'error');
            }
        }
        
        // Portfolio health check and recovery
        async function checkPortfolioHealth() {
            try {
                const response = await fetch('backend/user/trading.php?action=health_check', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    console.warn('Portfolio health check failed:', result.message);
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('Portfolio health check error:', error);
                return false;
            }
        }
        
        // Enhanced portfolio loading with retry mechanism
        async function loadPortfolioWithRetry(maxRetries = 3) {
            let retryCount = 0;
            
            while (retryCount < maxRetries) {
                try {
                    await loadPortfolio();
                    return; // Success, exit the retry loop
                } catch (error) {
                    retryCount++;
                    console.warn(`Portfolio load attempt ${retryCount} failed:`, error.message);
                    
                    if (retryCount < maxRetries) {
                        // Wait before retry (exponential backoff)
                        const waitTime = Math.pow(2, retryCount) * 1000; // 2s, 4s, 8s
                        console.log(`Retrying in ${waitTime/1000} seconds...`);
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                    } else {
                        // Final attempt failed
                        console.error('All portfolio load attempts failed');
                        throw error;
                    }
                }
            }
        }
        
        // Initialize portfolio auto-refresh on page load
        document.addEventListener('DOMContentLoaded', function() {
            enablePortfolioAutoRefresh();
            enablePortfolioRealTimePrices();
            addPortfolioQuickStats();
            
            // Initial health check
            setTimeout(() => {
                checkPortfolioHealth().then(isHealthy => {
                    if (!isHealthy) {
                        console.warn('Portfolio system health check failed');
                    }
                });
            }, 1000);
        });
        
        // Real-time portfolio price updates
        function enablePortfolioRealTimePrices() {
            let priceUpdateInterval;
            
            function updatePortfolioPrices() {
                if (!isPortfolioScreenActive()) return;
                
                // Portfolio kartlarındaki fiyatları güncelle
                const portfolioCards = document.querySelectorAll('.portfolio-asset-card');
                portfolioCards.forEach(card => {
                    const coinId = card.dataset.coinId;
                    if (coinId) {
                        updateSingleCoinPriceInPortfolio(coinId);
                    }
                });
            }
            
            function startPortfolioPriceUpdates() {
                // Her 15 saniyede bir fiyatları güncelle
                priceUpdateInterval = setInterval(updatePortfolioPrices, 15000);
            }
            
            function stopPortfolioPriceUpdates() {
                if (priceUpdateInterval) {
                    clearInterval(priceUpdateInterval);
                    priceUpdateInterval = null;
                }
            }
            
            // Portfolio ekranı aktif olduğunda price updates başlat
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    if (section === 'portfolio') {
                        setTimeout(startPortfolioPriceUpdates, 500);
                    } else {
                        stopPortfolioPriceUpdates();
                    }
                });
            });
        }
        
        // Update single coin price in portfolio
        async function updateSingleCoinPriceInPortfolio(coinId) {
            try {
                const response = await fetch(`backend/user/coins.php?coin_id=${coinId}`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const result = await response.json();
                if (result.success && result.coin) {
                    const coin = result.coin;
                    updatePortfolioCoinDisplay(coinId, coin);
                }
            } catch (error) {
                console.error('Coin fiyat güncelleme hatası:', error);
            }
        }
        
        // Update portfolio coin display with new price
        function updatePortfolioCoinDisplay(coinId, coinData) {
            const card = document.querySelector(`[data-coin-id="${coinId}"]`);
            if (!card) return;
            
            const currentPriceElement = card.querySelector('.current-price');
            const changeElement = card.querySelector('.price-change-indicator');
            
            if (currentPriceElement) {
                const oldPrice = parseFloat(currentPriceElement.textContent.replace(/[₺,]/g, ''));
                const newPrice = parseFloat(coinData.current_price);
                
                // Fiyat değişimi animasyonu
                if (oldPrice !== newPrice) {
                    currentPriceElement.style.background = newPrice > oldPrice ? '#10b981' : '#ef4444';
                    currentPriceElement.style.transition = 'background 0.3s ease';
                    
                    setTimeout(() => {
                        currentPriceElement.style.background = 'transparent';
                    }, 1000);
                }
                
                currentPriceElement.textContent = `₺${newPrice.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            }
            
            if (changeElement && coinData.price_change_24h !== undefined) {
                const change = parseFloat(coinData.price_change_24h);
                changeElement.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
                changeElement.className = `price-change-indicator ${change >= 0 ? 'positive' : 'negative'}`;
            }
        }
        
        // Enhanced portfolio display with real-time indicators
        function displayPortfolio(data) {
            console.log('📊 Displaying portfolio with enhanced features:', data);
            
            const loader = document.getElementById('portfolioLoader');
            const empty = document.getElementById('portfolioEmpty');
            const cardsContainer = document.getElementById('portfolioCards');
            const tableBody = document.getElementById('portfolioTableBody');
            
            // Loading'i gizle
            if (loader) loader.style.display = 'none';
            
            if (!data.portfolio || !Array.isArray(data.portfolio) || data.portfolio.length === 0) {
                if (empty) empty.style.display = 'block';
                return;
            }
            
            if (empty) empty.style.display = 'none';
            
            // Portfolio özetini güncelle
            if (data.summary) {
                updatePortfolioSummary(data.summary, data.portfolio);
            }
            
            // Portfolio kartlarını göster (real-time özelliklerle)
            if (cardsContainer) {
                displayPortfolioCardsWithRealTime(data.portfolio, cardsContainer);
            }
            
            // Portfolio tablosunu göster
            if (tableBody) {
                displayPortfolioTable(data.portfolio, tableBody);
            }
        }
        
        // Quick portfolio stats update function (eksik fonksiyon eklendi)
        function updateQuickPortfolioStats(summary) {
            // Bu fonksiyon portfolio hızlı istatistiklerini günceller
            console.log('📈 Updating quick portfolio stats:', summary);
            
            // Gelecekte kullanılmak üzere placeholder
            // Şimdilik sadece console log
        }
        
        // Add portfolio quick stats function (eksik fonksiyon eklendi)
        function addPortfolioQuickStats() {
            console.log('📊 Adding portfolio quick stats functionality');
            
            // Portfolio hızlı istatistik özelliklerini ekler
            // Bu fonksiyon portfolio sayfasında hızlı erişim widget'ları oluşturur
            
            // Şimdilik placeholder - gelecekte genişletilebilir
        }

        // Modern Profile Functions
        function editProfileAvatar() {
            showNotification('Avatar düzenleme özelliği yakında gelecek!', 'info');
        }

        function editProfileInfo() {
            showNotification('Profil düzenleme özelliği yakında gelecek!', 'info');
        }

        function showWithdrawalComingSoon() {
            showNotification('Para çekme özelliği yakında gelecek!', 'info');
        }

        // Modern Transaction History Loading
        async function loadTransactionHistory() {
            const historyContainer = document.getElementById('modernTransactionHistory');
            
            if (!historyContainer) {
                console.warn('Modern transaction history container not found');
                return;
            }
            
            // Loading state göster
            historyContainer.innerHTML = `
                <div class="loading-state">
                    <div class="modern-spinner"></div>
                    <p>İşlem geçmişi yükleniyor...</p>
                </div>
            `;
            
            try {
                const response = await fetch('backend/user/transaction_history.php?action=list&limit=20', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const result = await response.json();
                console.log('✅ Modern transaction history loaded:', result);
                
                if (result.success && result.data.transactions) {
                    displayModernTransactionHistory(result.data.transactions);
                } else {
                    // Boş durum
                    historyContainer.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: #8b8fa3;">
                            <i class="fas fa-history" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                            <h3 style="color: #ffffff; margin-bottom: 12px;">Henüz İşlem Yok</h3>
                            <p>Henüz hiç işlem yapmamışsınız. İlk işleminizi yapmak için piyasalar sayfasını ziyaret edin.</p>
                        </div>
                    `;
                }
                
                // İstatistikleri güncelle
                if (result.data.stats) {
                    updateModernProfileStats(result.data.stats);
                }
                
            } catch (error) {
                console.error('Modern transaction history loading error:', error);
                historyContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 12px;"></i><br>
                        İşlem geçmişi yüklenirken hata oluştu.<br>
                        <button onclick="loadTransactionHistory()" style="background: #4fc3f7; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 12px;">
                            Tekrar Dene
                        </button>
                    </div>
                `;
            }
        }

        // Global transaction pagination variables
        let allTransactions = [];
        let currentTransactionPage = 1;
        const transactionsPerPage = 3;

        // Modern Transaction History Display with Pagination
        function displayModernTransactionHistory(transactions) {
            const historyContainer = document.getElementById('modernTransactionHistory');
            
            if (!transactions || transactions.length === 0) {
                historyContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #8b8fa3;">
                        <i class="fas fa-history" style="font-size: 32px; margin-bottom: 12px; opacity: 0.5;"></i>
                        <h3 style="color: #ffffff; margin-bottom: 8px; font-size: 18px;">İşlem Geçmişi Boş</h3>
                        <p style="font-size: 14px;">Henüz hiç işlem yapmamışsınız.</p>
                    </div>
                `;
                return;
            }
            
            // Store all transactions globally
            allTransactions = transactions;
            
            // Calculate pagination
            const totalPages = Math.ceil(transactions.length / transactionsPerPage);
            const startIndex = (currentTransactionPage - 1) * transactionsPerPage;
            const endIndex = startIndex + transactionsPerPage;
            const currentTransactions = transactions.slice(startIndex, endIndex);
            
            let historyHTML = '<div style="display: flex; flex-direction: column; gap: 12px;">';
            
            currentTransactions.forEach(transaction => {
                const isPositive = parseFloat(transaction.amount) > 0;
                const amount = parseFloat(transaction.amount);
                const formattedAmount = (isPositive ? '+' : '') + '₺' + Math.abs(amount).toLocaleString('tr-TR', { minimumFractionDigits: 2 });
                
                // İşlem tipine göre icon belirle
                let icon = 'fas fa-exchange-alt';
                let iconColor = '#4fc3f7';
                
                if (transaction.type === 'coin_trade') {
                    icon = transaction.sub_type === 'al' ? 'fas fa-arrow-down' : 'fas fa-arrow-up';
                    iconColor = transaction.sub_type === 'al' ? '#00d4aa' : '#ef4444';
                } else if (transaction.type === 'deposit') {
                    icon = 'fas fa-plus-circle';
                    iconColor = '#00d4aa';
                } else if (transaction.type === 'withdrawal') {
                    icon = 'fas fa-minus-circle';
                    iconColor = '#ef4444';
                }
                
                // Status badge
                let statusBadge = '';
                if (transaction.sub_type === 'beklemede') {
                    statusBadge = '<span style="background: rgba(251, 191, 36, 0.2); color: #fbbf24; padding: 2px 6px; border-radius: 8px; font-size: 10px; font-weight: 600;">Beklemede</span>';
                } else if (transaction.sub_type === 'onaylandi' || transaction.sub_type === 'al' || transaction.sub_type === 'sat') {
                    statusBadge = '<span style="background: rgba(16, 185, 129, 0.2); color: #10b981; padding: 2px 6px; border-radius: 8px; font-size: 10px; font-weight: 600;">Tamamlandı</span>';
                } else if (transaction.sub_type === 'reddedildi') {
                    statusBadge = '<span style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 2px 6px; border-radius: 8px; font-size: 10px; font-weight: 600;">Reddedildi</span>';
                }
                
                historyHTML += `
                    <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 16px; transition: all 0.3s ease; backdrop-filter: blur(20px);">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 36px; height: 36px; background: rgba(${iconColor.substring(1, 3)}, ${iconColor.substring(3, 5)}, ${iconColor.substring(5, 7)}, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="${icon}" style="color: ${iconColor}; font-size: 14px;"></i>
                                </div>
                                <div style="min-width: 0; flex: 1;">
                                    <div style="font-weight: 600; color: #ffffff; margin-bottom: 2px; font-size: 14px; line-height: 1.2;">
                                        ${transaction.description}
                                    </div>
                                    <div style="font-size: 11px; color: #8b8fa3; display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                                        <span>${new Date(transaction.date).toLocaleDateString('tr-TR', { 
                                            month: 'short', 
                                            day: 'numeric', 
                                            hour: '2-digit', 
                                            minute: '2-digit' 
                                        })}</span>
                                        ${statusBadge}
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: right; flex-shrink: 0; margin-left: 8px;">
                                <div style="font-weight: 700; font-size: 15px; color: ${isPositive ? '#00d4aa' : '#ef4444'}; margin-bottom: 2px;">
                                    ${formattedAmount}
                                </div>
                                <div style="font-size: 10px; color: #8b8fa3;">
                                    ${transaction.type === 'coin_trade' ? 'Coin' : transaction.type === 'deposit' ? 'Yatırım' : 'Çekim'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            historyHTML += '</div>';
            
            // Add pagination if there are more than 3 transactions
            if (totalPages > 1) {
                historyHTML += `
                    <div style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 16px; padding: 12px;">
                        <button onclick="changeTransactionPage(${currentTransactionPage - 1})" 
                                ${currentTransactionPage === 1 ? 'disabled' : ''} 
                                style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #ffffff; padding: 6px 10px; border-radius: 6px; cursor: ${currentTransactionPage === 1 ? 'not-allowed' : 'pointer'}; font-size: 12px; opacity: ${currentTransactionPage === 1 ? '0.5' : '1'};">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        
                        <div style="display: flex; gap: 4px;">
                `;
                
                // Page numbers
                for (let i = 1; i <= totalPages; i++) {
                    const isActive = i === currentTransactionPage;
                    historyHTML += `
                        <button onclick="changeTransactionPage(${i})" 
                                style="background: ${isActive ? 'linear-gradient(135deg, #3b82f6, #1d4ed8)' : 'rgba(255, 255, 255, 0.1)'}; 
                                       border: 1px solid ${isActive ? '#3b82f6' : 'rgba(255, 255, 255, 0.2)'}; 
                                       color: #ffffff; 
                                       padding: 6px 10px; 
                                       border-radius: 6px; 
                                       cursor: pointer; 
                                       font-size: 12px; 
                                       font-weight: ${isActive ? '600' : '400'};
                                       min-width: 28px;
                                       transition: all 0.3s ease;">
                            ${i}
                        </button>
                    `;
                }
                
                historyHTML += `
                        </div>
                        
                        <button onclick="changeTransactionPage(${currentTransactionPage + 1})" 
                                ${currentTransactionPage === totalPages ? 'disabled' : ''} 
                                style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #ffffff; padding: 6px 10px; border-radius: 6px; cursor: ${currentTransactionPage === totalPages ? 'not-allowed' : 'pointer'}; font-size: 12px; opacity: ${currentTransactionPage === totalPages ? '0.5' : '1'};">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        
                        <div style="margin-left: 12px; color: #8b8fa3; font-size: 11px;">
                            ${startIndex + 1}-${Math.min(endIndex, transactions.length)} / ${transactions.length}
                        </div>
                    </div>
                `;
            }
            
            historyContainer.innerHTML = historyHTML;
        }

        // Change transaction page function
        function changeTransactionPage(page) {
            const totalPages = Math.ceil(allTransactions.length / transactionsPerPage);
            
            if (page < 1 || page > totalPages) return;
            
            currentTransactionPage = page;
            displayModernTransactionHistory(allTransactions);
        }

        // Modern Profile Stats Update
        function updateModernProfileStats(stats) {
            // Modern stats kartlarını güncelle
            const modernTotalTrades = document.getElementById('modernTotalTrades');
            const modernProfitLoss = document.getElementById('modernProfitLoss');
            const modernPortfolioValue = document.getElementById('modernPortfolioValue');
            const modernMemberSince = document.getElementById('modernMemberSince');

            if (modernTotalTrades && stats.total_trades) {
                modernTotalTrades.textContent = stats.total_trades;
            }

            if (modernProfitLoss) {
                const profitLoss = (stats.total_sell_amount || 0) - (stats.total_buy_amount || 0);
                modernProfitLoss.textContent = `₺${profitLoss.toLocaleString('tr-TR')}`;
                modernProfitLoss.style.color = profitLoss >= 0 ? '#10b981' : '#ef4444';
            }

            if (modernPortfolioValue) {
                // Portfolio değeri backend'den gelecek
                modernPortfolioValue.textContent = '₺0';
            }

            if (modernMemberSince) {
                // Üyelik süresi hesapla
                const memberSince = stats.member_since || new Date();
                const monthsDiff = Math.floor((new Date() - new Date(memberSince)) / (1000 * 60 * 60 * 24 * 30));
                modernMemberSince.textContent = monthsDiff || 1;
            }
        }

        // Modern User Info Display
        function displayModernUserInfo(userInfo) {
            const container = document.getElementById('modernUserInfo');
            
            if (!container) return;
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; padding: 0;">
                    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.1);">
                        <h4 style="color: #ffffff; margin-bottom: 16px; font-size: 16px; font-weight: 600;">
                            <i class="fas fa-user" style="color: #3b82f6; margin-right: 8px;"></i>
                            Kişisel Bilgiler
                        </h4>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #8b8fa3; font-size: 14px;">Kullanıcı Adı:</span>
                                <span style="color: #ffffff; font-weight: 600;">${userInfo.username || 'N/A'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #8b8fa3; font-size: 14px;">Email:</span>
                                <span style="color: #ffffff; font-weight: 600;">${userInfo.email || 'N/A'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #8b8fa3; font-size: 14px;">Ad Soyad:</span>
                                <span style="color: #ffffff; font-weight: 600;">${userInfo.ad_soyad || 'Belirtilmemiş'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.1);">
                        <h4 style="color: #ffffff; margin-bottom: 16px; font-size: 16px; font-weight: 600;">
                            <i class="fas fa-calendar" style="color: #10b981; margin-right: 8px;"></i>
                            Hesap Durumu
                        </h4>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #8b8fa3; font-size: 14px;">Kayıt Tarihi:</span>
                                <span style="color: #ffffff; font-weight: 600;">${userInfo.created_at ? new Date(userInfo.created_at).toLocaleDateString('tr-TR') : 'N/A'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #8b8fa3; font-size: 14px;">Son Giriş:</span>
                                <span style="color: #ffffff; font-weight: 600;">${userInfo.son_giris ? new Date(userInfo.son_giris).toLocaleDateString('tr-TR') : 'İlk giriş'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #8b8fa3; font-size: 14px;">Hesap Tipi:</span>
                                <span style="color: #10b981; font-weight: 600;">${userInfo.role === 'admin' ? 'Yönetici' : 'Premium Üye'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Enhanced loadUserInfo for modern profile
        function loadUserInfo() {
            fetch('backend/public/profile.php', {
                method: 'GET',
                credentials: 'include'
            })
            .then(r => r.json())
            .then(data => {
                if(data.success) {
                    console.log('✅ Kullanıcı bilgileri yüklendi:', data.user);
                    
                    // Bakiye göster
                    const balance = parseFloat(data.user.balance) || 0;
                    const balanceFormatted = balance.toLocaleString('tr-TR', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    
                    document.getElementById('userBalance').innerHTML = 
                        `<i class="fas fa-wallet"></i> ₺${balanceFormatted}`;
                    
                    document.getElementById('totalBalance').innerHTML = 
                        `<h1 style="font-size: 2rem; color: #00d4aa;">₺${balanceFormatted}</h1>`;
                    
                    // Modern Profile Updates
                    const profileUsername = document.getElementById('profileUsername');
                    const profileBalanceAmount = document.getElementById('profileBalanceAmount');
                    const profileBalanceChange = document.getElementById('profileBalanceChange');
                    const profileJoinDate = document.getElementById('profileJoinDate');
                    
                    if (profileUsername) {
                        profileUsername.textContent = data.user.username || 'Kullanıcı';
                    }
                    
                    if (profileBalanceAmount) {
                        profileBalanceAmount.textContent = `₺${balanceFormatted}`;
                    }
                    
                    if (profileBalanceChange) {
                        // Günlük değişim hesapla (şimdilik sabit)
                        const dailyChange = balance * 0.02; // %2 örnek artış
                        profileBalanceChange.textContent = `+₺${dailyChange.toLocaleString('tr-TR', {minimumFractionDigits: 2})} (+2.0%)`;
                    }
                    
                    if (profileJoinDate) {
                        const joinDate = data.user.created_at ? new Date(data.user.created_at).toLocaleDateString('tr-TR', {
                            year: 'numeric',
                            month: 'long'
                        }) : 'Ocak 2024';
                        profileJoinDate.innerHTML = `
                            <i class="fas fa-calendar-alt"></i>
                            <span>Üye olma: ${joinDate}</span>
                        `;
                    }
                    
                    // Profile avatar güncelle
                    const profileAvatar = document.getElementById('profileAvatar');
                    if (profileAvatar) {
                        const firstLetter = (data.user.username || 'U').charAt(0).toUpperCase();
                        profileAvatar.innerHTML = `<i class="fas fa-user"></i>`;
                    }
                    
                    // Modern user info display
                    displayModernUserInfo(data.user);
                    
                    // Legacy updates
                    document.getElementById('userInfo').innerHTML = `
                        <div style="line-height: 1.8;">
                            <p><strong>Kullanıcı Adı:</strong> ${data.user.username || 'N/A'}</p>
                            <p><strong>Email:</strong> ${data.user.email || 'N/A'}</p>
                            <p><strong>Ad Soyad:</strong> ${data.user.ad_soyad || 'Belirtilmemiş'}</p>
                            <p><strong>Kayıt Tarihi:</strong> ${data.user.created_at ? new Date(data.user.created_at).toLocaleDateString('tr-TR') : 'N/A'}</p>
                            <p><strong>Son Giriş:</strong> ${data.user.son_giris ? new Date(data.user.son_giris).toLocaleDateString('tr-TR') : 'İlk giriş'}</p>
                            <p><strong>Hesap Tipi:</strong> ${data.user.role === 'admin' ? 'Yönetici' : 'Standart Kullanıcı'}</p>
                            <p><strong>Toplam Bakiye:</strong> <span style="color: #00d4aa; font-weight: 600;">₺${balanceFormatted}</span></p>
                        </div>
                    `;
                    
                    // Bakiye kartı
                    document.getElementById('balanceInfo').innerHTML = `
                        <div style="text-align: center;">
                            <h1 style="font-size: 2.5rem; color: #00d4aa; margin-bottom: 10px;">₺${balanceFormatted}</h1>
                            <p style="color: #8b8fa3; margin-bottom: 15px;">Mevcut Bakiye</p>
                            <div style="display: flex; gap: 10px; justify-content: center;">
                                <button onclick="showSection('deposit')" style="background: #00d4aa; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                    <i class="fas fa-plus"></i> Para Yatır
                                </button>
                                <button onclick="showWithdrawalComingSoon()" style="background: #2d3748; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                    <i class="fas fa-minus"></i> Para Çek
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // İstatistikler
                    document.getElementById('totalTrades').textContent = '12';
                    document.getElementById('profitLoss').textContent = '₺2,450';
                    document.getElementById('memberSince').textContent = '3 ay';
                    
                    // İşlem geçmişi ve mevduatları yükle
                    loadTransactionHistory();
                    if (typeof loadRecentDeposits === 'function') {
                        loadRecentDeposits();
                    }
                    
                    // Diğer dashboard verilerini simüle et
                    setTimeout(() => {
                        document.getElementById('dailyPnl').innerHTML = 
                            `<h2 style="color: #00d4aa;">+₺156.24</h2><small style="color: #8b8fa3;">+2.34%</small>`;
                        
                        document.getElementById('openPositions').innerHTML = 
                            `<h2 style="color: #ffffff;">3</h2><small style="color: #8b8fa3;">Aktif pozisyon</small>`;
                        
                        document.getElementById('recentTrades').innerHTML = 
                            `<p style="color: #8b8fa3;">Henüz işlem yapılmamış</p>`;
                        
                        document.getElementById('marketSummary').innerHTML = 
                            `<p style="color: #8b8fa3;">Piyasa verileri yükleniyor...</p>`;
                    }, 1000);
                    
                } else {
                    console.error('❌ Kullanıcı girişi gerekli:', data.message);
                    showNotification('Oturum süreniz dolmuş. Lütfen tekrar giriş yapın.', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                }
            })
            .catch(err => {
                console.error('❌ API Hatası:', err);
                document.getElementById('totalBalance').innerHTML = '<span style="color: #ef4444;">Bağlantı Hatası</span>';
                document.getElementById('userBalance').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Hata';
                showNotification('Bağlantı hatası. Lütfen sayfayı yenileyin.', 'error');
            });
        }

        // Show section helper function
        function showSection(sectionName) {
            // Nav link'i bul ve tıkla
            const navLink = document.querySelector(`[data-section="${sectionName}"]`);
            if (navLink) {
                navLink.click();
            }
        }
    </script>
</body>
</html>
